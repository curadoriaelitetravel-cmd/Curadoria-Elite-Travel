<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Confirmando pagamento | Curadoria Elite Travel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #0b0b0b;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
    }

    .box {
      max-width: 560px;
      padding: 40px 26px;
      border-radius: 16px;
      border: 1px solid #222;
      background: #111;
    }

    h1 {
      color: #d4af37;
      font-size: 22px;
      margin-bottom: 14px;
    }

    p {
      color: rgba(255,255,255,0.85);
      font-size: 15px;
      line-height: 1.6;
      margin: 8px 0;
    }

    .muted {
      color: rgba(255,255,255,0.6);
      font-size: 14px;
      margin-top: 18px;
    }

    form {
      margin-top: 22px;
      text-align: left;
      display: none;
    }

    label {
      display: block;
      margin-top: 14px;
      font-size: 14px;
    }

    input, select {
      width: 100%;
      margin-top: 6px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #0b0b0b;
      color: #fff;
      box-sizing: border-box;
    }

    .row {
      display: flex;
      gap: 12px;
    }

    .row > div {
      flex: 1;
    }

    .checkboxRow {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 14px;
    }

    .checkboxRow input[type="checkbox"] {
      width: auto;
      margin: 0;
      transform: translateY(1px);
    }

    button {
      margin-top: 22px;
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: none;
      background: #d4af37;
      color: #000;
      font-weight: 600;
      cursor: pointer;
    }

    .actions {
      margin-top: 26px;
      display: none;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .actions a {
      padding: 10px 16px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 600;
    }

    .btn-main {
      background: #d4af37;
      color: #000;
    }

    .btn-ghost {
      border: 1px solid rgba(212,175,55,0.4);
      color: #d4af37;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>

  <div class="box">
    <h1 id="title">Confirmando seu pagamento…</h1>

    <p id="subtitle">
      Estamos validando a compra e liberando seu material.
    </p>

    <p class="muted" id="status">
      Aguarde alguns instantes.
    </p>

    <!-- FORMULÁRIO NOTA FISCAL -->
    <form id="invoiceForm">
      <label>Tipo de documento</label>
      <select id="person_type">
        <option value="CPF">Pessoa Física (CPF)</option>
        <option value="CNPJ">Pessoa Jurídica (CNPJ)</option>
      </select>

      <label>CPF / CNPJ</label>
      <input id="doc_number" required placeholder="Digite seu CPF ou CNPJ" inputmode="numeric" />

      <!-- CPF: Nome -->
      <div id="cpfNameWrap">
        <label>Nome completo</label>
        <input id="full_name" required />
      </div>

      <!-- CNPJ: Razão Social -->
      <div id="cnpjCorporateWrap" class="hidden">
        <label>Razão Social</label>
        <input id="corporate_name" />
      </div>

      <!-- CPF: Sexo -->
      <div id="genderWrap">
        <label>Sexo</label>
        <select id="gender">
          <option value="" selected>Selecione</option>
          <option value="Mulher">Mulher</option>
          <option value="Homem">Homem</option>
          <option value="Outro">Outro</option>
        </select>
      </div>

      <!-- CPF: Nascimento -->
      <div id="birthWrap">
        <label>Data de nascimento</label>
        <input type="date" id="birth_date" />
      </div>

      <!-- CNPJ: IE + Isento -->
      <div id="ieWrap" class="hidden">
        <div class="checkboxRow">
          <input type="checkbox" id="ie_isento" checked />
          <label for="ie_isento" style="margin:0;">Isento de Inscrição Estadual</label>
        </div>

        <label id="ieLabel">Inscrição Estadual (IE)</label>
        <input id="ie" disabled />
      </div>

      <div class="row">
        <div>
          <label>UF</label>
          <select id="uf"></select>
        </div>
        <div>
          <label>Cidade</label>
          <select id="city_name"></select>
        </div>
      </div>

      <label>CEP</label>
      <input id="cep" required inputmode="numeric" placeholder="00000-000" />

      <label>Bairro</label>
      <input id="neighborhood" required />

      <label>Rua</label>
      <input id="street" required />

      <label>Número</label>
      <input id="street_number" required />

      <button id="btnSubmit" type="submit">Salvar dados e prosseguir</button>
    </form>

    <div class="actions" id="actions">
      <a href="/" class="btn-main">Voltar ao site</a>
      <a href="mailto:curadoriaelitetravel@gmail.com" class="btn-ghost">Contato</a>
    </div>
  </div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
/* =========================
   SUPABASE (mesmo projeto)
========================= */
const SUPABASE_URL = "https://lnyoqoezezisakghtmim.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxueW9xb2V6ZXppc2FrZ2h0bWltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNjI4OTMsImV4cCI6MjA3OTczODg5M30.Nn9ZPRXeJlvCGJ2kXQ3XBvT743pQn2VIXEsT9pexqnA";

let sb = null;
function ensureSupabase(){
  if (sb) return sb;
  if (!window.supabase) return null;
  sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  return sb;
}
async function getAccessToken(){
  const s = ensureSupabase();
  if (!s) return null;
  const { data } = await s.auth.getSession();
  return (data && data.session && data.session.access_token) ? data.session.access_token : null;
}

/* =========================
   INIT
========================= */
async function init() {
  const params = new URLSearchParams(window.location.search);

  // MODO 1: antes do Stripe (Nota Fiscal)
  const step = params.get("step");
  const category = params.get("category");
  const city = params.get("city");

  if (step === "invoice" && category && city) {
    // exige login aqui também
    const token = await getAccessToken();
    if (!token) {
      document.getElementById("title").innerText = "Acesso à conta";
      document.getElementById("subtitle").innerText = "Para prosseguir, é necessário entrar ou criar seu cadastro.";
      document.getElementById("status").innerText = "Você será direcionado para o login.";
      document.getElementById("status").style.display = "block";

      // manda para login e volta para esta etapa
      const returnTo =
        "checkout-success.html?step=invoice&category=" +
        encodeURIComponent(category) +
        "&city=" +
        encodeURIComponent(city);

      setTimeout(() => {
        window.location.href = "login.html?return_to=" + encodeURIComponent(returnTo);
      }, 900);

      return;
    }

    // mostra formulário NF
    document.getElementById("title").innerText = "Dados para Nota Fiscal";
    document.getElementById("subtitle").innerText = "Precisamos dessas informações antes do pagamento.";
    document.getElementById("status").style.display = "none";
    document.getElementById("invoiceForm").style.display = "block";
    document.getElementById("btnSubmit").innerText = "Salvar dados e ir para pagamento";

    await loadUFs();
    applyPersonTypeUI();
    applyDocMask();
    return;
  }

  // MODO 2: depois do Stripe (confirmação de pagamento)
  const sessionId = params.get("session_id");
  if (!sessionId) {
    document.getElementById("title").innerText = "Acesso";
    document.getElementById("subtitle").innerText = "Não encontramos a sessão de pagamento.";
    document.getElementById("status").innerText = "Volte ao site e tente novamente.";
    document.getElementById("actions").style.display = "flex";
    return;
  }

  liberarPDF(sessionId);
}

/* =========================
   LIBERA PDF (pós-pagamento)
========================= */
async function liberarPDF(sessionId) {
  const res = await fetch("/api/get-pdf-from-session?session_id=" + encodeURIComponent(sessionId));
  const data = await res.json();
  if (data?.pdf_url) {
    window.location.href = data.pdf_url;
    return;
  }

  document.getElementById("title").innerText = "Pagamento";
  document.getElementById("subtitle").innerText = "Não conseguimos liberar seu material.";
  document.getElementById("status").innerText = "Se precisar, fale com nosso contato.";
  document.getElementById("actions").style.display = "flex";
}

/* =========================
   UFs / Cidades
========================= */
async function loadUFs() {
  const res = await fetch("/api/br-cities");
  const data = await res.json();

  const ufSelect = document.getElementById("uf");
  ufSelect.innerHTML = (data.estados || []).map(u => `<option>${u}</option>`).join("");

  await loadCities();
}

async function loadCities() {
  const uf = document.getElementById("uf").value;
  const res = await fetch("/api/br-cities?uf=" + encodeURIComponent(uf));
  const data = await res.json();

  document.getElementById("city_name").innerHTML =
    (data.cidades || []).map(c => `<option>${c}</option>`).join("");
}
document.getElementById("uf").addEventListener("change", loadCities);

/* =========================
   CPF / CNPJ: UI CONDICIONAL
========================= */
function applyPersonTypeUI() {
  const personType = document.getElementById("person_type").value;
  const isCPF = personType === "CPF";

  document.getElementById("cpfNameWrap").classList.toggle("hidden", !isCPF);
  document.getElementById("genderWrap").classList.toggle("hidden", !isCPF);
  document.getElementById("birthWrap").classList.toggle("hidden", !isCPF);

  document.getElementById("cnpjCorporateWrap").classList.toggle("hidden", isCPF);
  document.getElementById("ieWrap").classList.toggle("hidden", isCPF);

  document.getElementById("full_name").required = isCPF;
  document.getElementById("corporate_name").required = !isCPF;
  document.getElementById("birth_date").required = isCPF;

  if (isCPF) {
    document.getElementById("corporate_name").value = "";
    document.getElementById("ie").value = "";
    document.getElementById("ie_isento").checked = true;
    document.getElementById("ie").disabled = true;
  } else {
    document.getElementById("full_name").value = "";
    document.getElementById("gender").value = "";
    document.getElementById("birth_date").value = "";
    toggleIE();
  }
}

function toggleIE() {
  const isento = document.getElementById("ie_isento").checked;
  const ieInput = document.getElementById("ie");

  if (isento) {
    ieInput.value = "";
    ieInput.disabled = true;
  } else {
    ieInput.disabled = false;
    ieInput.focus();
  }
}

document.getElementById("person_type").addEventListener("change", () => {
  applyPersonTypeUI();
  applyDocMask();
});
document.getElementById("ie_isento").addEventListener("change", toggleIE);

/* =========================
   MÁSCARA CPF / CNPJ
========================= */
function onlyDigits(v) { return String(v || "").replace(/\D+/g, ""); }

function formatCPF(digits) {
  const d = digits.slice(0, 11);
  return d
    .replace(/^(\d{3})(\d)/, "$1.$2")
    .replace(/^(\d{3})\.(\d{3})(\d)/, "$1.$2.$3")
    .replace(/^(\d{3})\.(\d{3})\.(\d{3})(\d{1,2})$/, "$1.$2.$3-$4");
}

function formatCNPJ(digits) {
  const d = digits.slice(0, 14);
  return d
    .replace(/^(\d{2})(\d)/, "$1.$2")
    .replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3")
    .replace(/^(\d{2})\.(\d{3})\.(\d{3})(\d)/, "$1.$2.$3/$4")
    .replace(/^(\d{2})\.(\d{3})\.(\d{3})\/(\d{4})(\d{1,2})$/, "$1.$2.$3/$4-$5");
}

function applyDocMask() {
  const personType = document.getElementById("person_type").value;
  const input = document.getElementById("doc_number");
  const digits = onlyDigits(input.value);

  if (personType === "CPF") {
    input.value = formatCPF(digits);
    input.placeholder = "000.000.000-00";
  } else {
    input.value = formatCNPJ(digits);
    input.placeholder = "00.000.000/0001-00";
  }
}
document.getElementById("doc_number").addEventListener("input", applyDocMask);

/* =========================
   SUBMIT (salva NF e vai pro Stripe)
========================= */
document.getElementById("invoiceForm").addEventListener("submit", async e => {
  e.preventDefault();

  const params = new URLSearchParams(window.location.search);
  const category = params.get("category");
  const city = params.get("city");

  const token = await getAccessToken();
  if (!token) {
    alert("Para prosseguir, faça login novamente.");
    return;
  }

  const personType = person_type.value;

  const payload = {
    person_type: personType,
    doc_number: onlyDigits(doc_number.value),

    // CPF:
    full_name: personType === "CPF" ? full_name.value : "",
    gender: personType === "CPF" ? (gender.value || null) : null,
    birth_date: personType === "CPF" ? (birth_date.value || null) : null,

    // CNPJ:
    corporate_name: personType === "CNPJ" ? corporate_name.value : "",
    ie_isento: personType === "CNPJ" ? ie_isento.checked : true,
    ie: personType === "CNPJ" ? (ie.value || null) : null,

    // Endereço:
    uf: uf.value,
    city_name: city_name.value,
    cep: onlyDigits(cep.value),
    neighborhood: neighborhood.value,
    street: street.value,
    street_number: street_number.value
  };

  // UI simples de carregando
  document.getElementById("btnSubmit").disabled = true;
  document.getElementById("btnSubmit").innerText = "Salvando...";

  // 1) salva NF
  const saveRes = await fetch("/api/save-invoice-profile", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify(payload)
  });

  const saveJson = await saveRes.json().catch(() => null);

  if (!saveRes.ok || !saveJson || saveJson.ok !== true) {
    document.getElementById("btnSubmit").disabled = false;
    document.getElementById("btnSubmit").innerText = "Salvar dados e ir para pagamento";
    alert("Não foi possível salvar seus dados. Por favor, revise e tente novamente.");
    return;
  }

  // 2) cria checkout stripe (agora vai passar na validação)
  document.getElementById("btnSubmit").innerText = "Abrindo pagamento...";

  const payRes = await fetch("/api/create-checkout-session", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({ category, city })
  });

  const payJson = await payRes.json().catch(() => null);

  if (!payRes.ok || !payJson || !payJson.url) {
    document.getElementById("btnSubmit").disabled = false;
    document.getElementById("btnSubmit").innerText = "Salvar dados e ir para pagamento";
    alert("Não foi possível iniciar o pagamento. Tente novamente.");
    return;
  }

  window.location.href = payJson.url;
});

init();
</script>

</body>
</html>
