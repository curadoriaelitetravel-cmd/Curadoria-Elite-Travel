<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Confirmando pagamento | Curadoria Elite Travel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #0b0b0b;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
    }

    .box {
      max-width: 560px;
      padding: 40px 26px;
      border-radius: 16px;
      border: 1px solid #222;
      background: #111;
    }

    h1 {
      color: #d4af37;
      font-size: 22px;
      margin-bottom: 14px;
    }

    p {
      color: rgba(255,255,255,0.85);
      font-size: 15px;
      line-height: 1.6;
      margin: 8px 0;
    }

    .muted {
      color: rgba(255,255,255,0.6);
      font-size: 14px;
      margin-top: 18px;
    }

    form {
      margin-top: 22px;
      text-align: left;
      display: none;
    }

    label {
      display: block;
      margin-top: 14px;
      font-size: 14px;
    }

    input, select {
      width: 100%;
      margin-top: 6px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #0b0b0b;
      color: #fff;
    }

    .row {
      display: flex;
      gap: 12px;
    }

    .row > div {
      flex: 1;
    }

    button {
      margin-top: 22px;
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: none;
      background: #d4af37;
      color: #000;
      font-weight: 600;
      cursor: pointer;
    }

    .actions {
      margin-top: 26px;
      display: none;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .actions a {
      padding: 10px 16px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 600;
    }

    .btn-main {
      background: #d4af37;
      color: #000;
    }

    .btn-ghost {
      border: 1px solid rgba(212,175,55,0.4);
      color: #d4af37;
    }

    .field-hidden {
      display: none !important;
    }

    .error-box {
      margin-top: 16px;
      padding: 10px 12px;
      border: 1px solid rgba(255, 80, 80, 0.35);
      background: rgba(255, 80, 80, 0.08);
      border-radius: 10px;
      color: rgba(255,255,255,0.9);
      display: none;
      text-align: left;
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

  <div class="box">
    <h1 id="title">Confirmando seu pagamento…</h1>

    <p id="subtitle">
      Estamos validando a compra e liberando seu material.
    </p>

    <p class="muted" id="status">
      Aguarde alguns instantes.
    </p>

    <div class="error-box" id="errorBox"></div>

    <!-- FORMULÁRIO NOTA FISCAL -->
    <form id="invoiceForm">
      <label>Tipo de documento</label>
      <select id="person_type">
        <option value="CPF">Pessoa Física (CPF)</option>
        <option value="CNPJ">Pessoa Jurídica (CNPJ)</option>
      </select>

      <label>CPF / CNPJ</label>
      <input id="doc_number" required />

      <label id="fullNameLabel">Nome completo</label>
      <input id="full_name" required />

      <!-- CPF: nascimento + sexo -->
      <div id="cpfFields">
        <label>Data de nascimento</label>
        <input type="date" id="birth_date" />

        <label>Sexo</label>
        <select id="gender">
          <option value="">Selecione</option>
          <option value="Mulher">Mulher</option>
          <option value="Homem">Homem</option>
          <option value="Outro">Outro</option>
        </select>
      </div>

      <!-- CNPJ: IE -->
      <div id="cnpjFields" class="field-hidden">
        <label>
          <input type="checkbox" id="ie_isento" checked />
          Isento de Inscrição Estadual
        </label>

        <label>Inscrição Estadual</label>
        <input id="ie" />
      </div>

      <label>País</label>
      <select id="country">
        <option value="Brasil" selected>Brasil</option>
      </select>

      <div class="row">
        <div>
          <label>UF</label>
          <select id="uf"></select>
        </div>
        <div>
          <label>Cidade</label>
          <select id="city_name"></select>
        </div>
      </div>

      <label>CEP</label>
      <input id="cep" required />

      <label>Bairro</label>
      <input id="neighborhood" required />

      <label>Rua</label>
      <input id="street" required />

      <label>Número</label>
      <input id="street_number" required />

      <button type="submit">Salvar dados e acessar material</button>
    </form>

    <div class="actions" id="actions">
      <a href="/" class="btn-main">Voltar ao site</a>
      <a href="mailto:curadoriaelitetravel@gmail.com" class="btn-ghost">Contato</a>
    </div>
  </div>

<script>
const PAGE_VERSION = "checkout-success-2026-01-30b";

function showError(msg) {
  const box = document.getElementById("errorBox");
  box.style.display = "block";
  box.innerText = msg;
}

function clearError() {
  const box = document.getElementById("errorBox");
  box.style.display = "none";
  box.innerText = "";
}

function showForm() {
  document.getElementById("title").innerText = "Dados para Nota Fiscal";
  document.getElementById("subtitle").innerText =
    "Precisamos dessas informações para emitir sua nota fiscal.";
  document.getElementById("status").style.display = "none";
  document.getElementById("invoiceForm").style.display = "block";
}

function applyPersonTypeUI() {
  const type = document.getElementById("person_type").value;
  const cpfFields = document.getElementById("cpfFields");
  const cnpjFields = document.getElementById("cnpjFields");
  const fullNameLabel = document.getElementById("fullNameLabel");

  if (type === "CPF") {
    cpfFields.classList.remove("field-hidden");
    cnpjFields.classList.add("field-hidden");
    fullNameLabel.innerText = "Nome completo";

    document.getElementById("ie_isento").checked = true;
    document.getElementById("ie").value = "";
  } else {
    cpfFields.classList.add("field-hidden");
    cnpjFields.classList.remove("field-hidden");
    fullNameLabel.innerText = "Razão Social";

    document.getElementById("birth_date").value = "";
    document.getElementById("gender").value = "";
  }

  applyIeUI();
}

function applyIeUI() {
  const type = document.getElementById("person_type").value;
  const ieIsento = document.getElementById("ie_isento").checked;
  const ieInput = document.getElementById("ie");

  if (type !== "CNPJ") {
    ieInput.value = "";
    ieInput.disabled = true;
    return;
  }

  if (ieIsento) {
    ieInput.value = "";
    ieInput.disabled = true;
  } else {
    ieInput.disabled = false;
  }
}

async function loadUFs() {
  const res = await fetch("/api/br-cities?ts=" + Date.now());
  const data = await res.json();

  const ufSelect = document.getElementById("uf");
  ufSelect.innerHTML = (data.estados || []).map(u => `<option>${u}</option>`).join("");

  await loadCities();
}

async function loadCities() {
  const uf = document.getElementById("uf").value;
  const res = await fetch("/api/br-cities?uf=" + encodeURIComponent(uf) + "&ts=" + Date.now());
  const data = await res.json();

  document.getElementById("city_name").innerHTML =
    (data.cidades || []).map(c => `<option>${c}</option>`).join("");
}

async function liberarPDF(sessionId) {
  const res = await fetch("/api/get-pdf-from-session?session_id=" + encodeURIComponent(sessionId));
  const data = await res.json();

  if (data?.pdf_url) {
    window.location.href = data.pdf_url;
    return;
  }

  showError(
    "Pagamento confirmado, mas não foi possível liberar o material automaticamente.\n" +
    "Por favor, entre em contato.\n\n" +
    "Detalhes técnicos: " + JSON.stringify(data || {}, null, 2)
  );
  document.getElementById("actions").style.display = "flex";
}

async function init() {
  try {
    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get("session_id");

    if (!sessionId) {
      showError("Sessão de pagamento não encontrada (faltou session_id na URL).");
      document.getElementById("actions").style.display = "flex";
      return;
    }

    // ✅ CAMINHO B: sempre pede nota fiscal primeiro
    showForm();
    applyPersonTypeUI();
    await loadUFs();

  } catch (err) {
    showError(
      "Erro ao carregar a página.\n\n" +
      "Detalhes: " + (err?.message || String(err)) +
      "\n\nVersão: " + PAGE_VERSION
    );
    document.getElementById("actions").style.display = "flex";
  }
}

document.getElementById("uf").addEventListener("change", loadCities);
document.getElementById("person_type").addEventListener("change", applyPersonTypeUI);
document.getElementById("ie_isento").addEventListener("change", applyIeUI);

document.getElementById("invoiceForm").addEventListener("submit", async e => {
  e.preventDefault();
  clearError();

  try {
    const sessionId = new URLSearchParams(window.location.search).get("session_id");
    const personType = document.getElementById("person_type").value;

    const payload = {
      person_type: personType,
      doc_number: document.getElementById("doc_number").value,
      full_name: document.getElementById("full_name").value,

      birth_date: (personType === "CPF") ? (document.getElementById("birth_date").value || null) : null,
      gender: (personType === "CPF") ? (document.getElementById("gender").value || null) : null,

      ie_isento: (personType === "CNPJ") ? document.getElementById("ie_isento").checked : true,
      ie: (personType === "CNPJ") ? (document.getElementById("ie").value || null) : null,

      uf: document.getElementById("uf").value,
      city_name: document.getElementById("city_name").value,
      cep: document.getElementById("cep").value,
      neighborhood: document.getElementById("neighborhood").value,
      street: document.getElementById("street").value,
      street_number: document.getElementById("street_number").value,

      country: document.getElementById("country").value
    };

    const resp = await fetch("/api/save-invoice-profile", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await resp.json().catch(() => ({}));

    if (!resp.ok) {
      const msg =
        (result && (result.details || result.error || result.message)) ||
        "Erro ao salvar os dados de nota fiscal.";

      showError(
        "Não foi possível salvar os dados.\n\nMensagem: " + msg +
        "\n\nOBS: se aparecer 'missing_token', significa que ainda falta o LOGIN (email/senha) para gerar o token do usuário."
      );
      document.getElementById("actions").style.display = "flex";
      return;
    }

    // ✅ só libera o PDF depois de salvar
    await liberarPDF(sessionId);

  } catch (err) {
    showError("Erro inesperado ao salvar.\n\nDetalhes: " + (err?.message || String(err)));
    document.getElementById("actions").style.display = "flex";
  }
});

init();
</script>

</body>
</html>
