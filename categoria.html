<!-- =========================
     INDEX.HTML (PARTE 1/3)
     - Ajuste do cabeçalho (Entrar / Minha conta / Sair)
     - Estrutura do Carrinho (popup) + lógica base (adicionar/remover + contador)
     - NÃO altera layout/estilo existente (apenas adiciona o link "Carrinho" e o popup)
========================= -->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Curadoria Elite Travel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body{
      margin:0;
      font-family:"Segoe UI",sans-serif;
      background:#0b0b0b;
      color:#fff;
      overflow-x:hidden;
    }

    header{
      padding:16px 40px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:fixed;
      width:100%;
      top:0;
      z-index:1000;
      background:rgba(0,0,0,0.25);
      backdrop-filter:blur(8px);
      border-bottom:1px solid rgba(255,255,255,0.06);
      box-sizing:border-box;
      gap:16px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 240px;
      cursor:pointer;
    }

    .brand img{
      height:34px;
      width:34px;
    }

    .brand-name{
      font-family:"Cinzel","Georgia",serif;
      font-size:18px;
      color:#d4af37;
      letter-spacing:0.8px;
      text-transform:uppercase;
      line-height:1.1;
    }

    .brand-tagline{
      font-size:12px;
      color:rgba(255,255,255,0.7);
      line-height:1.2;
      margin-top:2px;
    }

    nav{
      display:flex;
      align-items:center;
      gap:16px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    nav a{
      color:#d4af37;
      text-decoration:none;
      font-weight:500;
      cursor:pointer;
      white-space: nowrap;
    }

    .nav-sep{
      width:1px;
      height:16px;
      background:rgba(255,255,255,0.12);
      display:inline-block;
      margin:0 2px;
    }

    section{
      display:none;
      padding:120px 40px 80px;
      max-width:1100px;
      margin:auto;
      box-sizing:border-box;
    }

    section.active{ display:block; }

    footer{
      border-top:1px solid #222;
      padding:30px;
      text-align:center;
      color:#888;
      font-size:14px;
    }

    /* ========= HOME (Hero) ========= */
    #inicio{
      padding:0;
      max-width:none;
    }

    .hero{
      height:100vh;
      position:relative;
      overflow:hidden;
      background:#0b0b0b;
    }

    .hero-bg{
      position:absolute;
      inset:0;
      background-size:cover;
      background-position:center;
      filter:brightness(0.42) saturate(0.6);
      opacity:0;
      transition:opacity 3s ease;
      transform:scale(1.03);
    }

    .hero-bg.active{ opacity:1; }

    .hero-overlay{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,0.68);
    }

    .hero-content{
      position:relative;
      z-index:2;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:20px;
      box-sizing:border-box;
    }

    .hero-content h1{
      color:#d4af37;
      font-size:clamp(28px,4vw,52px);
      margin:0 0 12px;
    }

    .hero-content p{
      color:rgba(255,255,255,0.85);
      margin:6px 0;
      font-size:15px;
      line-height:1.6;
    }

    /* ========= QUEM SOMOS ========= */
    #quem{
      max-width:none;
      padding-left:0;
      padding-right:0;
    }

    .about-layout{
      display:grid;
      grid-template-columns:minmax(260px,1fr) minmax(520px,760px) minmax(260px,1fr);
      gap:26px;
      align-items:stretch;
      padding:0 40px;
      box-sizing:border-box;
    }

    .about-center{
      display:flex;
      flex-direction:column;
    }

    .about-center h2{
      text-align:center;
      color:#d4af37;
      margin:40px 0 34px;
      font-size:28px;
      letter-spacing:0.2px;
    }

    .text-block{
      color:#ddd;
      font-size:15px;
      line-height:1.7;
      max-width:760px;
      margin:0 auto 54px;
      text-align:center;
    }

    .rules-block{
      background:#111;
      border:1px solid #222;
      border-radius:14px;
      padding:30px;
      max-width:760px;
      margin:0 auto;
      font-size:14px;
      line-height:1.6;
      color:#ccc;
    }

    .rules-block strong{
      color:#d4af37;
      font-weight:700;
    }

    .rules-block .hl{
      color:#d4af37;
      font-weight:600;
    }

    .side-panel{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      border:1px solid #222;
      background:#0b0b0b;
      margin-top:92px;
      height:calc(100% - 92px);
    }

    .side-panel-inner{
      position:absolute;
      inset:0;
    }

    .side-bg{
      position:absolute;
      inset:0;
      background-size:cover;
      opacity:0;
      transition:opacity 3.2s ease;
      transform:scale(1.02);
      filter:brightness(0.72) saturate(0.9) contrast(0.95);
    }

    .side-bg.active{ opacity:1; }
    .side-bg.left{ background-position:left center; }
    .side-bg.right{ background-position:right center; }

    .side-overlay{
      position:absolute;
      inset:0;
      background:linear-gradient(
        180deg,
        rgba(0,0,0,0.42) 0%,
        rgba(0,0,0,0.58) 55%,
        rgba(0,0,0,0.72) 100%
      );
      pointer-events:none;
    }

    .side-caption{
      position:absolute;
      left:18px;
      bottom:16px;
      z-index:3;
      color:rgba(255,255,255,0.78);
      font-size:12.5px;
      letter-spacing:0.2px;
    }

    /* ========= CURADORIA ========= */
    #curadoria h2{
      text-align:center;
      color:#d4af37;
      margin:40px 0 14px;
      font-size:28px;
      letter-spacing:0.2px;
    }

    .subtitle{
      text-align:center;
      color:rgba(255,255,255,0.78);
      max-width:860px;
      margin:0 auto 34px;
      line-height:1.6;
      font-size:15px;
    }

    .card{
      background:linear-gradient(145deg,#111,#000);
      border:1px solid #222;
      border-radius:14px;
      padding:22px;
      transition:all 0.35s ease;
      position:relative;
    }

    .card:hover{
      transform:translateY(-4px);
      border-color:#d4af37;
      box-shadow:0 10px 20px rgba(212,175,55,0.20);
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:22px;
      margin-top:18px;
    }

    .card img{
      width:100%;
      height:150px;
      object-fit:cover;
      border-radius:10px;
      margin-bottom:12px;
      filter:brightness(0.82) saturate(0.9);
    }

    .card h3{
      margin:6px 0 8px;
      color:#d4af37;
      font-size:18px;
      letter-spacing:0.2px;
    }

    .card p{
      margin:0;
      color:rgba(255,255,255,0.75);
      font-size:13.8px;
      line-height:1.5;
    }

    button{
      cursor:pointer;
      padding:10px 16px;
      border-radius:10px;
      border:none;
      background:#d4af37;
      color:#000;
      font-weight:700;
      margin-top:14px;
    }

    button[disabled]{
      opacity:0.6;
      cursor:not-allowed;
    }

    .btn-ghost{
      background:transparent;
      border:1px solid rgba(212,175,55,0.35);
      color:#d4af37;
      font-weight:600;
    }

    .curadoria-panel{
      display:none;
      margin-top:26px;
      border-radius:16px;
      border:1px solid rgba(212,175,55,0.22);
      background:linear-gradient(145deg,#0f0f0f,#0a0a0a);
      padding:18px;
    }

    .panel-top{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    .breadcrumb{
      color:rgba(255,255,255,0.72);
      font-size:13px;
      margin-bottom:6px;
    }

    .panel-title{
      color:#d4af37;
      font-size:20px;
      margin:0;
      letter-spacing:0.2px;
    }

    .panel-meta{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid #222;
      background:#0f0f0f;
      color:rgba(255,255,255,0.75);
      font-size:12.5px;
      line-height:1;
      white-space:nowrap;
    }

    .pill.ok{
      border-color: rgba(212,175,55,0.35);
      color:#d4af37;
    }

    .pill.muted{
      border-color: rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.62);
    }

    .search-wrap{
      flex:1;
      min-width: 240px;
      max-width: 520px;
      position:relative;
    }

    .search-input{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid #222;
      background:#0f0f0f;
      color:#fff;
      outline:none;
      box-sizing:border-box;
      font-size:14px;
    }

    .search-input::placeholder{
      color:rgba(255,255,255,0.45);
    }

    .panel-actions{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }

    .cities-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:14px;
      margin-top:16px;
    }

    .city-card{
      background:#0f0f0f;
      border:1px solid #222;
      border-radius:14px;
      padding:16px;
      text-align:left;
      transition:all 0.3s ease;
      position:relative;
    }

    .city-card:hover{
      transform:translateY(-3px);
      border-color:rgba(212,175,55,0.55);
    }

    .city-card h4{
      margin:0 0 10px;
      color:#fff;
      font-weight:650;
      font-size:15px;
      line-height:1.3;
    }

    .city-card small{
      display:block;
      color:rgba(255,255,255,0.6);
      margin-top:2px;
      font-size:12px;
    }

    .city-meta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
      margin-bottom:8px;
      align-items:center;
    }

    .panel-footer{
      margin-top:14px;
      display:flex;
      justify-content:center;
    }

    .empty-state{
      text-align:center;
      color:rgba(255,255,255,0.68);
      border:1px dashed rgba(255,255,255,0.12);
      border-radius:14px;
      padding:22px 16px;
      margin-top:14px;
      font-size:14px;
      line-height:1.6;
    }

    /* ========= POPUPS ========= */
    .popup-bg{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.85);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:3000;
      padding:18px;
      box-sizing:border-box;
    }

    .popup-bg.active{ display:flex; }

    .popup-content{
      background:#111;
      border:1px solid #222;
      border-radius:14px;
      max-width:720px;
      width:100%;
      padding:24px;
      box-sizing:border-box;
      position:relative;
      text-align:center;
    }

    .popup-content h3{
      margin:0 0 10px;
      color:#d4af37;
      letter-spacing:0.2px;
    }

    .popup-content p{
      margin:0 0 14px;
      color:rgba(255,255,255,0.8);
      line-height:1.6;
      font-size:14px;
    }

    .popup-actions{
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .popup-rules{
      text-align:left;
      margin-top:14px;
      background:#0f0f0f;
      border:1px solid #222;
      border-radius:12px;
      padding:16px;
      color:rgba(255,255,255,0.78);
      font-size:13.5px;
      line-height:1.6;
    }

    .popup-rules strong{ color:#d4af37; }

    .consent-wrap{
      display:flex;
      gap:10px;
      align-items:flex-start;
      margin-top:12px;
      text-align:left;
      padding:12px;
      border:1px solid #222;
      border-radius:12px;
      background:#0f0f0f;
      color:rgba(255,255,255,0.82);
      font-size:13.2px;
      line-height:1.55;
    }

    .consent-wrap input{
      margin-top:3px;
      accent-color:#d4af37;
    }

    /* ========= CARRINHO (popup) ========= */
    .cart-list{
      text-align:left;
      margin-top:14px;
      border:1px solid #222;
      border-radius:12px;
      background:#0f0f0f;
      padding:12px;
    }

    .cart-item{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:12px 10px;
      border-bottom:1px solid rgba(255,255,255,0.08);
    }

    .cart-item:last-child{ border-bottom:none; }

    .cart-item-left{
      min-width:0;
    }

    .cart-item-title{
      color:#fff;
      font-weight:650;
      margin:0 0 4px;
      font-size:14px;
      line-height:1.35;
    }

    .cart-item-meta{
      color:rgba(255,255,255,0.70);
      font-size:12.5px;
      line-height:1.4;
    }

    .cart-item-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:10px;
      white-space:nowrap;
    }

    .cart-total{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      padding:12px;
      border:1px solid rgba(255,255,255,0.10);
      border-radius:12px;
      background:#0f0f0f;
      text-align:left;
    }

    .cart-total strong{ color:#d4af37; }

    @media (max-width:980px){
      header{ padding:14px 16px; }
      section{ padding:110px 16px 70px; }

      .about-layout{
        grid-template-columns:1fr;
        padding:0 16px;
        gap:16px;
        align-items:start;
      }

      .side-panel{ height:240px; margin-top:0; }
      .side-bg.left,.side-bg.right{ background-position:center; }
      .brand{ min-width: auto; }

      .curadoria-panel{ padding:16px; }
      .panel-top{ align-items:flex-start; }
      .search-wrap{ max-width: 100%; }
    }
  </style>
</head>
<body>

<header>
  <div class="brand" onclick="showSection('inicio')">
    <img src="images/rosa-dos-ventos.png" alt="Rosa dos Ventos">
    <div>
      <div class="brand-name">Curadoria Elite Travel</div>
      <div class="brand-tagline">O seu mundo, bem indicado.</div>
    </div>
  </div>

  <nav>
    <a onclick="showSection('inicio')">Início</a>
    <a onclick="showSection('quem')">Quem Somos</a>
    <a onclick="showSection('curadoria')">Curadoria</a>
    <a onclick="showSection('buscador')">Buscador</a>

    <span class="nav-sep"></span>

    <!-- Carrinho -->
    <a id="navCart" onclick="openCart()">Carrinho (0)</a>

    <!-- alterna conforme login -->
    <a id="navAccount" onclick="goAccount()" style="display:none;">Minha conta</a>
    <a id="navLogin" onclick="goLogin()" style="display:none;">Entrar</a>
    <a id="navLogout" onclick="doLogout()" style="display:none;">Sair</a>
  </nav>
</header>

<section id="inicio" class="active">
  <div class="hero">
    <div class="hero-bg active" id="bg1"></div>
    <div class="hero-bg" id="bg2"></div>
    <div class="hero-overlay"></div>

    <div class="hero-content">
      <div>
        <h1>Uma plataforma de curadoria para viajar melhor.</h1>
        <p>Curadoria que orienta. Decisão que flui.</p>
        <p>Selecionamos e organizamos informações essenciais para decisões de viagem mais seguras e bem fundamentadas.</p>
      </div>
    </div>
  </div>
</section>

<section id="quem">
  <div class="about-layout">

    <div class="side-panel" aria-hidden="true">
      <div class="side-panel-inner">
        <div class="side-bg left active" id="sl1"></div>
        <div class="side-bg left" id="sl2"></div>
        <div class="side-overlay"></div>
        <div class="side-caption">Critério · Orientação · Decisão</div>
      </div>
    </div>

    <div class="about-center">
      <h2>Quem Somos</h2>

      <div class="text-block">
        Na Curadoria Elite Travel, acreditamos que o tempo é um dos bens mais valiosos de quem viaja.<br><br>
        Em um cenário onde a praticidade digital é essencial, percebemos que o viajante moderno buscava autonomia sem abrir mão de inspiração, critério e confiança - uma forma clara e organizada de decidir melhor, que ainda não existia.<br><br>
        Foi dessa necessidade que nascemos. A Curadoria Elite Travel é uma plataforma criada para organizar informações e oferecer indicações criteriosas, transformando destinos em universos referenciados e acessíveis digitalmente.<br><br>
        Nossa curadoria é composta por indicações, referências e orientações práticas, pensadas para apoiar decisões de viagem antes e durante a experiência.<br><br>
        Não somos uma agência de viagens e não realizamos reservas. Nosso papel é selecionar, estruturar e apresentar conhecimento de qualidade para quem prefere decidir com segurança e clareza.<br><br>
        <strong>O seu mundo, bem indicado.</strong>
      </div>

      <div class="rules-block">
        <strong>Informações Importantes</strong><br><br>

        A Curadoria Elite Travel oferece exclusivamente materiais digitais de caráter informativo e orientativo, baseados em indicações, referências e conteúdos selecionados.<br><br>

        Não realizamos reservas, vendas de passagens, hospedagens, experiências ou qualquer tipo de intermediação direta com fornecedores ou prestadores de serviço.<br><br>

        As decisões de compra, contratação e utilização de serviços indicados nos materiais são de <span class="hl">responsabilidade exclusiva do usuário</span>, assim como qualquer tratativa, solicitação, alteração ou eventual problema relacionado aos serviços contratados.<br><br>

        Por se tratar de conteúdo digital disponibilizado de forma imediata após a confirmação da compra, <span class="hl">não é possível realizar cancelamentos, trocas ou reembolsos</span>.<br><br>

        Ao adquirir nossos materiais, o usuário declara estar ciente e de acordo com essas condições.
      </div>
    </div>

    <div class="side-panel" aria-hidden="true">
      <div class="side-panel-inner">
        <div class="side-bg right active" id="sr1"></div>
        <div class="side-bg right" id="sr2"></div>
        <div class="side-overlay"></div>
      </div>
    </div>

  </div>
</section>

<section id="curadoria">
  <h2>Curadoria</h2>
  <p class="subtitle">
    Materiais digitais desenvolvidos para apoiar decisões de viagem com critério, clareza e indicações bem organizadas.
  </p>

  <div class="card" style="text-align:center; max-width:900px; margin:0 auto;">
    <h3 style="margin-top:0;">Overview</h3>
    <p>Conheça o formato, a profundidade e o padrão dos materiais que entregamos.</p>
    <button onclick="openOverview()">Abrir overview</button>
  </div>

  <!-- Grid de categorias (mantido como está) -->
  <div id="curadoria-categories" class="grid" style="margin-top:26px;">
    <div class="card" onclick="openCategory('City Guide')">
      <img src="https://images.unsplash.com/photo-1505761671935-60b3a7427bad?auto=format&fit=crop&w=1200&q=80">
      <h3>City Guide</h3>
      <p>Indicações essenciais por destino, com foco em clareza e praticidade.</p>
    </div>

    <div class="card" onclick="openCategory('Gastronomia')">
      <img src="https://images.unsplash.com/photo-1528605248644-14dd04022da1?auto=format&fit=crop&w=1200&q=80">
      <h3>Gastronomia</h3>
      <p>Seleções gastronômicas para decisões mais seguras e bem orientadas.</p>
    </div>

    <div class="card" onclick="openCategory('Atrações Turísticas')">
      <img src="https://images.unsplash.com/photo-1526778548025-fa2f459cd5c1?auto=format&fit=crop&w=1200&q=80">
      <h3>Atrações Turísticas</h3>
      <p>O que vale seu tempo - com contexto e organização por destino.</p>
    </div>

    <div class="card" onclick="openCategory('Vida Noturna')">
      <img src="https://images.unsplash.com/photo-1506157786151-b8491531f063?auto=format&fit=crop&w=1200&q=80">
      <h3>Vida Noturna</h3>
      <p>Locais e experiências noturnas com curadoria e referências.</p>
    </div>

    <div class="card" onclick="openCategory('Endereços para Compras')">
      <img src="https://images.unsplash.com/photo-1483985988355-763728e1935b?auto=format&fit=crop&w=1200&q=80">
      <h3>Endereços para Compras</h3>
      <p>Lojas, regiões e referências para comprar bem e com intenção.</p>
    </div>

    <div class="card" onclick="openCategory('Sugestão de Presentes')">
      <img src="https://images.unsplash.com/photo-1512909006721-3d6018887383?auto=format&fit=crop&w=1200&q=80">
      <h3>Sugestão de Presentes</h3>
      <p>Ideias e recomendações para presentes com bom senso e estilo.</p>
    </div>
  </div>

  <!-- Painel interno -->
  <div id="curadoria-panel" class="curadoria-panel">
    <div class="panel-top">
      <div>
        <div class="breadcrumb" id="breadcrumb">Curadoria</div>
        <h3 class="panel-title" id="panel-title">Categoria</h3>
        <div class="panel-meta">
          <span class="pill" id="cities-count">0 cidades</span>
          <span class="pill" id="visible-count">Mostrando 0</span>
          <span class="pill muted" id="admin-status">Admin: carregando...</span>
        </div>
      </div>

      <div class="panel-actions">
        <div class="search-wrap">
          <input
            id="city-search"
            class="search-input"
            type="text"
            placeholder="Buscar cidade..."
            oninput="onSearchCity()"
          />
        </div>
        <button class="btn-ghost" onclick="closeCategory()">← Voltar</button>
      </div>
    </div>

    <div id="cities-grid" class="cities-grid"></div>

    <div id="empty-state" class="empty-state" style="display:none;">
      Nenhum material disponível no momento.
    </div>

    <div class="panel-footer">
      <button id="btn-more" class="btn-ghost" style="display:none;" onclick="loadMoreCities()">
        Ver mais cidades
      </button>
    </div>
  </div>
</section>

<section id="buscador">
  <h2 style="text-align:center;color:#d4af37;margin:40px 0 14px;">Buscador</h2>
  <p class="subtitle">Em breve: área integrada com buscadores e indicações.</p>
</section>

<footer>
  Curadoria Elite Travel · O seu mundo, bem indicado.<br>
  São Paulo - SP · curadoriaelitetravel@gmail.com
</footer>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  function showSection(id){
    document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
    const el = document.getElementById(id);
    if (el) el.classList.add("active");
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function openOverview(){
    window.location.href = "https://lnyoqoezezisakghtmim.supabase.co/storage/v1/object/public/materiais/overview/general-overview.pdf";
  }

  /* =========================
     POPUP (já existente)
  ========================= */
  function ensurePopupExists(){
    if (document.getElementById("popup")) return;

    const popupHTML = `
      <div class="popup-bg" id="popup">
        <div class="popup-content" id="popup-content">
          <h3 id="popup-title"></h3>
          <p id="popup-text"></p>

          <div class="popup-rules" id="popup-rules" style="display:none;">
            <strong>Informações Importantes</strong><br><br>
            A Curadoria Elite Travel oferece exclusivamente materiais digitais de caráter informativo e orientativo, baseados em indicações, referências e conteúdos selecionados.<br><br>
            Não realizamos reservas, vendas de passagens, hospedagens, experiências ou qualquer tipo de intermediação direta com fornecedores ou prestadores de serviço.<br><br>
            As decisões de compra, contratação e utilização de serviços indicados nos materiais são de <strong>responsabilidade exclusiva do usuário</strong>, assim como qualquer tratativa, solicitação, alteração ou eventual problema relacionado aos serviços contratados.<br><br>
            Por se tratar de conteúdo digital disponibilizado de forma imediata após a confirmação da compra, <strong>não é possível realizar cancelamentos, trocas ou reembolsos</strong>.<br><br>
            Ao adquirir nossos materiais, o usuário declara estar ciente e de acordo com essas condições.
          </div>

          <div class="popup-actions">
            <button id="popup-secondary" class="btn-ghost" style="display:none;">Minha conta</button>
            <button id="popup-prosseguir" style="display:none;">Prosseguir</button>
            <button class="btn-ghost" id="popup-fechar">Fechar</button>
          </div>
        </div>
      </div>
    `;

    const wrap = document.createElement("div");
    wrap.innerHTML = popupHTML;
    document.body.appendChild(wrap);

    document.getElementById("popup-fechar").addEventListener("click", closePopup);
  }

  function openPopup({
    title="",
    text="",
    showProsseguir=false,
    showRules=false,
    onProsseguir=null,
    secondaryText=null,
    onSecondary=null
  }){
    ensurePopupExists();

    document.getElementById("popup-title").innerText = title;
    document.getElementById("popup-text").innerText = text;

    const rules = document.getElementById("popup-rules");
    rules.style.display = showRules ? "block" : "none";

    const btn = document.getElementById("popup-prosseguir");
    btn.style.display = showProsseguir ? "inline-block" : "none";
    btn.disabled = false;
    btn.innerText = "Prosseguir";

    const btn2 = document.getElementById("popup-secondary");
    if (secondaryText && typeof onSecondary === "function"){
      btn2.style.display = "inline-block";
      btn2.innerText = secondaryText;
      btn2.onclick = () => {
        try{ closePopup(); }catch(e){}
        onSecondary();
      };
    }else{
      btn2.style.display = "none";
      btn2.onclick = null;
    }

    const old = document.getElementById("consent-checkbox-wrap");
    if (old) old.remove();

    if (showProsseguir){
      const actions = document.querySelector("#popup-content .popup-actions");

      const consentWrap = document.createElement("div");
      consentWrap.id = "consent-checkbox-wrap";
      consentWrap.className = "consent-wrap";
      consentWrap.innerHTML = `
        <input type="checkbox" id="consent-checkbox" />
        <label for="consent-checkbox">(Li e concordo que, por ser um produto digital de acesso imediato, não será possível realizar cancelamentos, trocas ou reembolsos após a confirmação da compra.)</label>
      `;

      actions.parentNode.insertBefore(consentWrap, actions);

      btn.disabled = true;

      const cb = document.getElementById("consent-checkbox");
      cb.addEventListener("change", () => {
        btn.disabled = !cb.checked;
      });
    }

    btn.onclick = null;
    if (showProsseguir && typeof onProsseguir === "function"){
      btn.onclick = async () => {
        try{
          btn.disabled = true;
          btn.innerText = "Aguarde...";
          closePopup();
          await onProsseguir();
        }catch(e){
          openPopup({
            title: "Pagamento",
            text: "Não foi possível prosseguir. Tente novamente.",
            showProsseguir: false,
            showRules: false
          });
        }
      };
    }

    document.getElementById("popup").classList.add("active");
  }

  function closePopup(){
    const p = document.getElementById("popup");
    if (p) p.classList.remove("active");

    const old = document.getElementById("consent-checkbox-wrap");
    if (old) old.remove();

    const btn = document.getElementById("popup-prosseguir");
    if (btn){
      btn.disabled = false;
      btn.innerText = "Prosseguir";
    }

    const btn2 = document.getElementById("popup-secondary");
    if (btn2){
      btn2.style.display = "none";
      btn2.onclick = null;
    }
  }

  /* =========================
     CARRINHO (popup) - estrutura + base
  ========================= */
  const CART_STORAGE_KEY = "cet_cart_v1";

  function ensureCartPopupExists(){
    if (document.getElementById("cartPopup")) return;

    const cartHTML = `
      <div class="popup-bg" id="cartPopup">
        <div class="popup-content" id="cartPopupContent">
          <h3>Carrinho</h3>
          <p id="cartSubtitle">Revise seus materiais antes de prosseguir.</p>

          <div class="cart-list" id="cartList"></div>

          <div class="cart-total" id="cartTotalWrap" style="display:none;">
            <div><strong>Total</strong></div>
            <div id="cartTotalValue"><strong>R$ 0,00</strong></div>
          </div>

          <div class="popup-actions">
            <button class="btn-ghost" id="cartContinueBtn">Continuar comprando</button>
            <button id="cartProceedBtn">Prosseguir</button>
            <button class="btn-ghost" id="cartCloseBtn">Fechar</button>
          </div>
        </div>
      </div>
    `;

    const wrap = document.createElement("div");
    wrap.innerHTML = cartHTML;
    document.body.appendChild(wrap);

    document.getElementById("cartCloseBtn").addEventListener("click", closeCart);
    document.getElementById("cartContinueBtn").addEventListener("click", closeCart);

    // Por enquanto, o Prosseguir do carrinho não chama o fluxo completo (isso entra na PARTE 2/3)
    document.getElementById("cartProceedBtn").addEventListener("click", async () => {
      // Placeholder: PARTE 2/3 implementa Login -> Política -> NF -> Stripe
      openPopup({
        title: "Carrinho",
        text: "Estamos finalizando o fluxo do carrinho. (Etapa 2/3)",
        showProsseguir: false,
        showRules: false
      });
    });
  }

  function getCart(){
    try{
      const raw = localStorage.getItem(CART_STORAGE_KEY);
      const parsed = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(parsed)) return [];
      return parsed;
    }catch(e){
      return [];
    }
  }

  function saveCart(items){
    try{
      localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(items || []));
    }catch(e){}
    updateCartBadge();
  }

  function cartItemKey(category, cityLabel){
    return purchaseKey(category, cityLabel);
  }

  function addToCart(category, cityLabel){
    const items = getCart();
    const k = cartItemKey(category, cityLabel);

    const exists = items.some(it => it && it.key === k);
    if (exists){
      openPopup({
        title: "Carrinho",
        text: "Este material já está no carrinho.",
        showProsseguir: false,
        showRules: false
      });
      return;
    }

    const price = getPriceForCategory(category);

    items.push({
      key: k,
      category: String(category || "").trim(),
      city: String(cityLabel || "").trim(),
      qty: 1,
      price: Number(price || 0)
    });

    saveCart(items);

    openPopup({
      title: "Carrinho",
      text: "Material adicionado ao carrinho.",
      showProsseguir: false,
      showRules: false
    });
  }

  function removeFromCart(key){
    const items = getCart().filter(it => it && it.key !== key);
    saveCart(items);
    renderCart();
  }

  function calcCartTotal(items){
    let total = 0;
    (items || []).forEach(it => {
      const q = Number(it.qty || 0);
      const p = Number(it.price || 0);
      total += (q * p);
    });
    return total;
  }

  function renderCart(){
    ensureCartPopupExists();

    const listEl = document.getElementById("cartList");
    const totalWrap = document.getElementById("cartTotalWrap");
    const totalVal = document.getElementById("cartTotalValue");

    const items = getCart();

    if (!items.length){
      listEl.innerHTML = `
        <div style="padding:14px;color:rgba(255,255,255,0.70);line-height:1.6;">
          Seu carrinho está vazio.
        </div>
      `;
      if (totalWrap) totalWrap.style.display = "none";
      return;
    }

    listEl.innerHTML = "";

    items.forEach(it => {
      const div = document.createElement("div");
      div.className = "cart-item";

      const price = formatBRL(Number(it.price || 0));
      const qty = Number(it.qty || 1) || 1;

      div.innerHTML = `
        <div class="cart-item-left">
          <div class="cart-item-title">${it.city}</div>
          <div class="cart-item-meta">
            Quantidade: ${qty} · ${it.category}
          </div>
          <div class="cart-item-meta">
            ${price}
          </div>
        </div>
        <div class="cart-item-right">
          <button class="btn-ghost" data-remove="${it.key}" style="margin-top:0;">Remover</button>
        </div>
      `;

      const btnRemove = div.querySelector("[data-remove]");
      btnRemove.addEventListener("click", () => removeFromCart(it.key));

      listEl.appendChild(div);
    });

    const total = calcCartTotal(items);
    if (totalWrap) totalWrap.style.display = "flex";
    if (totalVal) totalVal.innerHTML = `<strong>${formatBRL(total)}</strong>`;
  }

  function openCart(){
    ensureCartPopupExists();
    renderCart();
    document.getElementById("cartPopup").classList.add("active");
  }

  function closeCart(){
    const p = document.getElementById("cartPopup");
    if (p) p.classList.remove("active");
  }

  function updateCartBadge(){
    const el = document.getElementById("navCart");
    if (!el) return;
    const items = getCart();
    const count = (items || []).length;
    el.innerText = "Carrinho (" + count + ")";
  }

  /* =========================
     SUPABASE
  ========================= */
  const SUPABASE_URL = "https://lnyoqoezezisakghtmim.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxueW9xb2V6ZXppc2FrZ2h0bWltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNjI4OTMsImV4cCI6MjA3OTczODg5M30.Nn9ZPRXeJlvCGJ2kXQ3XBvT743pQn2VIXEsT9pexqnA";

  let supabaseClient = null;

  function ensureSupabase(){
    if (supabaseClient) return supabaseClient;
    if (!window.supabase) return null;
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    return supabaseClient;
  }

  async function getSession(){
    const sb = ensureSupabase();
    if (!sb) return null;
    const { data } = await sb.auth.getSession();
    return (data && data.session) ? data.session : null;
  }

  /* =========================
     Cabeçalho (auth) - AJUSTADO
     - Deslogado: só "Entrar"
     - Logado: "Minha conta" + "Sair"
  ========================= */
  async function refreshNavAuth(){
    const s = await getSession();
    const navLogin = document.getElementById("navLogin");
    const navLogout = document.getElementById("navLogout");
    const navAccount = document.getElementById("navAccount");

    if (!navLogin || !navLogout || !navAccount) return;

    if (s && s.user){
      navLogin.style.display = "none";
      navAccount.style.display = "inline";
      navLogout.style.display = "inline";
    }else{
      navLogin.style.display = "inline";
      navAccount.style.display = "none";
      navLogout.style.display = "none";
    }
  }

  function goLogin(){
    window.location.href = "login.html?return_to=index.html";
  }

  function goAccount(){
    window.location.href = "account.html";
  }

  async function doLogout(){
    try{
      const sb = ensureSupabase();
      if (sb) await sb.auth.signOut();
    }catch(e){}
    try{ await refreshNavAuth(); }catch(e){}
    openPopup({
      title: "Acesso à conta",
      text: "Você saiu da sua conta.",
      showProsseguir: false,
      showRules: false
    });
  }

  /* =========================
     NORMALIZAÇÃO + PREÇO
  ========================= */
  function normalizeKeyPart(str){
    const s = String(str || "")
      .trim()
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/[—–−]/g, "-")
      .replace(/\s*-\s*/g, " - ")
      .replace(/\s+/g, " ")
      .trim();
    return s;
  }

  function purchaseKey(category, cityLabel){
    return normalizeKeyPart(category) + "||" + normalizeKeyPart(cityLabel);
  }

  function formatBRL(v){
    try{
      return new Intl.NumberFormat("pt-BR", { style:"currency", currency:"BRL" }).format(v);
    }catch(e){
      return "R$ " + String(v);
    }
  }

  function getPriceForCategory(category){
    const c = String(category || "").trim().toLowerCase();
    if (c === "city guide") return 88.92;
    return 57.83;
  }

  /* =========================
     DADOS AUTOMÁTICOS DO SUPABASE
     - materiaisAtivosPorCategoria: Map(category => [{city_label, pdf_url}...])
  ========================= */
  const materiaisAtivosPorCategoria = new Map();
  const ownedMap = new Map(); // purchases do usuário logado

  function setAdminStatus(text, ok){
    const el = document.getElementById("admin-status");
    if (!el) return;
    el.innerText = text;
    el.classList.remove("ok","muted");
    el.classList.add(ok ? "ok" : "muted");
  }

  async function loadActiveMaterials(){
    materiaisAtivosPorCategoria.clear();

    try{
      ensureSupabase();

      const { data, error } = await supabaseClient
        .from("curadoria_materials")
        .select("category, city_label, pdf_url")
        .eq("is_active", true)
        .order("city_label", { ascending: true });

      if (error){
        setAdminStatus("Admin: erro ao carregar", false);
        return;
      }

      (data || []).forEach(row => {
        const cat = String(row.category || "").trim();
        const city = String(row.city_label || "").trim();
        const url = row.pdf_url || null;

        if (!cat || !city || !url) return;

        if (!materiaisAtivosPorCategoria.has(cat)) materiaisAtivosPorCategoria.set(cat, []);
        materiaisAtivosPorCategoria.get(cat).push({ cidade: city, pdf_url: url });
      });

      setAdminStatus("Admin: conectado", true);
    }catch(e){
      setAdminStatus("Admin: falha na conexão", false);
    }
  }

  async function loadOwnedPurchases(){
    ownedMap.clear();

    try{
      const sess = await getSession();
      if (!sess || !sess.user) return;

      ensureSupabase();

      const { data, error } = await supabaseClient
        .from("purchase")
        .select("category, city, pdf_url")
        .eq("user_id", sess.user.id)
        .limit(500);

      if (error) return;

      (data || []).forEach(row => {
        const k = purchaseKey(row.category || "", row.city || "");
        ownedMap.set(k, { pdf_url: row.pdf_url || null });
      });
    }catch(e){}
  }

  function userOwns(category, cityLabel){
    return ownedMap.has(purchaseKey(category, cityLabel));
  }

  /* =========================
     CURADORIA PANEL (somente disponíveis)
  ========================= */
  const BATCH_SIZE = 12;
  let currentCategory = null;
  let filteredCities = [];
  let visibleCount = 0;

  function normalizeText(str){
    return normalizeKeyPart(str || "");
  }

  function openCategory(category){
    currentCategory = category;

    const panel = document.getElementById("curadoria-panel");
    if (!panel) return;
    panel.style.display = "block";

    const bc = document.getElementById("breadcrumb");
    const pt = document.getElementById("panel-title");
    if (bc) bc.innerText = "Curadoria > " + category;
    if (pt) pt.innerText = category;

    const input = document.getElementById("city-search");
    if (input) input.value = "";

    // ✅ SOMENTE cidades disponíveis do Supabase
    const list = materiaisAtivosPorCategoria.get(category) || [];
    filteredCities = list.slice();
    visibleCount = Math.min(BATCH_SIZE, filteredCities.length);

    renderCities();

    setTimeout(() => {
      panel.scrollIntoView({ behavior: "smooth", block: "start" });
      if (input) input.focus({ preventScroll: true });
    }, 120);
  }

  function closeCategory(){
    const panel = document.getElementById("curadoria-panel");
    if (panel) panel.style.display = "none";
    currentCategory = null;
    filteredCities = [];
    visibleCount = 0;

    const cats = document.getElementById("curadoria-categories");
    if (cats) cats.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  function onSearchCity(){
    if (!currentCategory) return;

    const input = document.getElementById("city-search");
    const q = normalizeText(input ? input.value : "");
    const all = (materiaisAtivosPorCategoria.get(currentCategory) || []);

    if (!q) filteredCities = all.slice();
    else filteredCities = all.filter(item => normalizeText(item.cidade).includes(q));

    visibleCount = Math.min(BATCH_SIZE, filteredCities.length);
    renderCities();
  }

  function loadMoreCities(){
    visibleCount = Math.min(visibleCount + BATCH_SIZE, filteredCities.length);
    renderCities(true);
  }

  function renderCities(){
    const grid = document.getElementById("cities-grid");
    const empty = document.getElementById("empty-state");
    const btnMore = document.getElementById("btn-more");
    const citiesCount = document.getElementById("cities-count");
    const visible = document.getElementById("visible-count");

    if (!grid) return;

    const total = filteredCities.length;

    if (citiesCount) citiesCount.innerText = total + (total === 1 ? " cidade" : " cidades");
    if (visible) visible.innerText = "Mostrando " + Math.min(visibleCount, total);

    if (total === 0){
      grid.innerHTML = "";
      if (empty) empty.style.display = "block";
      if (btnMore) btnMore.style.display = "none";
      return;
    }

    if (empty) empty.style.display = "none";

    const slice = filteredCities.slice(0, visibleCount);
    grid.innerHTML = "";

    slice.forEach((item) => {
      const div = document.createElement("div");
      div.className = "city-card";

      const cityLabel = item.cidade || "";
      const price = formatBRL(getPriceForCategory(currentCategory));

      const badge = `<span class="pill ok">Disponível</span>`;
      const pricePill = `<span class="pill muted">${price}</span>`;

      div.innerHTML = `
        <h4>${cityLabel}<small>Material digital com indicações selecionadas</small></h4>
        <div class="city-meta">${badge} ${pricePill}</div>
        <button>Acessar</button>
      `;

      const btn = div.querySelector("button");
      btn.addEventListener("click", () => openCityModal(currentCategory, cityLabel));

      grid.appendChild(div);
    });

    if (btnMore){
      btnMore.style.display = visibleCount < total ? "inline-flex" : "none";
    }
  }

  /* =========================
     FLUXO: SEMPRE NF antes do Stripe
     (PARTE 2/3 ajusta isso para carrinho)
  ========================= */
  function goInvoiceStep(category, city){
    const url =
      "checkout-success.html?step=invoice&category=" +
      encodeURIComponent(category) +
      "&city=" +
      encodeURIComponent(city);

    window.location.href = url;
  }

  /* =========================
     Modal da cidade
     - PARTE 2/3 ajusta o texto do "já possui" e integra carrinho/fluxo
  ========================= */
  function openCityModal(category, city){
    const msg =
      `${category} é um material digital com indicações e referências selecionadas para apoiar suas decisões de viagem. ` +
      `Este conteúdo é liberado após a confirmação da compra.`;

    const owns = userOwns(category, city);

    if (owns){
      openPopup({
        title: city,
        text: "Você já possui este material.",
        showProsseguir: true,
        showRules: true,
        secondaryText: "Minha conta",
        onSecondary: () => goAccount(),
        onProsseguir: async () => {
          // PARTE 2/3: aqui vira o fluxo do carrinho (política + NF) antes do pagamento
          goInvoiceStep(category, city);
        }
      });
      return;
    }

    // Mantém o comportamento atual (compra direta) por enquanto.
    // PARTE 2/3 vai incluir "Adicionar ao carrinho" neste popup.
    openPopup({
      title: city,
      text: msg,
      showProsseguir: true,
      showRules: true,
      onProsseguir: async () => {
        goInvoiceStep(category, city);
      }
    });
  }

  /* =========================
     INIT
  ========================= */
  document.addEventListener("DOMContentLoaded", async () => {
    ensureSupabase();

    updateCartBadge();     // ✅ contador do carrinho
    await refreshNavAuth(); // ✅ header certo

    await loadActiveMaterials();
    await loadOwnedPurchases();
  });
</script>

</body>
</html>
<!-- =========================
     INDEX.HTML (PARTE 2/3)
     - Carrinho: botão "Prosseguir" agora segue o fluxo correto
       Login (se precisar) -> Política (checkbox) -> Nota Fiscal -> Stripe
     - Popup da cidade: adiciona "Adicionar ao carrinho"
     - Aviso "já possui" fica sucinto + botões: Minha conta / Prosseguir / Sair
     - Mantém layout/estilo (apenas comportamento)
========================= -->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Curadoria Elite Travel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body{
      margin:0;
      font-family:"Segoe UI",sans-serif;
      background:#0b0b0b;
      color:#fff;
      overflow-x:hidden;
    }

    header{
      padding:16px 40px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:fixed;
      width:100%;
      top:0;
      z-index:1000;
      background:rgba(0,0,0,0.25);
      backdrop-filter:blur(8px);
      border-bottom:1px solid rgba(255,255,255,0.06);
      box-sizing:border-box;
      gap:16px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 240px;
      cursor:pointer;
    }

    .brand img{
      height:34px;
      width:34px;
    }

    .brand-name{
      font-family:"Cinzel","Georgia",serif;
      font-size:18px;
      color:#d4af37;
      letter-spacing:0.8px;
      text-transform:uppercase;
      line-height:1.1;
    }

    .brand-tagline{
      font-size:12px;
      color:rgba(255,255,255,0.7);
      line-height:1.2;
      margin-top:2px;
    }

    nav{
      display:flex;
      align-items:center;
      gap:16px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    nav a{
      color:#d4af37;
      text-decoration:none;
      font-weight:500;
      cursor:pointer;
      white-space: nowrap;
    }

    .nav-sep{
      width:1px;
      height:16px;
      background:rgba(255,255,255,0.12);
      display:inline-block;
      margin:0 2px;
    }

    section{
      display:none;
      padding:120px 40px 80px;
      max-width:1100px;
      margin:auto;
      box-sizing:border-box;
    }

    section.active{ display:block; }

    footer{
      border-top:1px solid #222;
      padding:30px;
      text-align:center;
      color:#888;
      font-size:14px;
    }

    /* ========= HOME (Hero) ========= */
    #inicio{
      padding:0;
      max-width:none;
    }

    .hero{
      height:100vh;
      position:relative;
      overflow:hidden;
      background:#0b0b0b;
    }

    .hero-bg{
      position:absolute;
      inset:0;
      background-size:cover;
      background-position:center;
      filter:brightness(0.42) saturate(0.6);
      opacity:0;
      transition:opacity 3s ease;
      transform:scale(1.03);
    }

    .hero-bg.active{ opacity:1; }

    .hero-overlay{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,0.68);
    }

    .hero-content{
      position:relative;
      z-index:2;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:20px;
      box-sizing:border-box;
    }

    .hero-content h1{
      color:#d4af37;
      font-size:clamp(28px,4vw,52px);
      margin:0 0 12px;
    }

    .hero-content p{
      color:rgba(255,255,255,0.85);
      margin:6px 0;
      font-size:15px;
      line-height:1.6;
    }

    /* ========= QUEM SOMOS ========= */
    #quem{
      max-width:none;
      padding-left:0;
      padding-right:0;
    }

    .about-layout{
      display:grid;
      grid-template-columns:minmax(260px,1fr) minmax(520px,760px) minmax(260px,1fr);
      gap:26px;
      align-items:stretch;
      padding:0 40px;
      box-sizing:border-box;
    }

    .about-center{
      display:flex;
      flex-direction:column;
    }

    .about-center h2{
      text-align:center;
      color:#d4af37;
      margin:40px 0 34px;
      font-size:28px;
      letter-spacing:0.2px;
    }

    .text-block{
      color:#ddd;
      font-size:15px;
      line-height:1.7;
      max-width:760px;
      margin:0 auto 54px;
      text-align:center;
    }

    .rules-block{
      background:#111;
      border:1px solid #222;
      border-radius:14px;
      padding:30px;
      max-width:760px;
      margin:0 auto;
      font-size:14px;
      line-height:1.6;
      color:#ccc;
    }

    .rules-block strong{
      color:#d4af37;
      font-weight:700;
    }

    .rules-block .hl{
      color:#d4af37;
      font-weight:600;
    }

    .side-panel{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      border:1px solid #222;
      background:#0b0b0b;
      margin-top:92px;
      height:calc(100% - 92px);
    }

    .side-panel-inner{
      position:absolute;
      inset:0;
    }

    .side-bg{
      position:absolute;
      inset:0;
      background-size:cover;
      opacity:0;
      transition:opacity 3.2s ease;
      transform:scale(1.02);
      filter:brightness(0.72) saturate(0.9) contrast(0.95);
    }

    .side-bg.active{ opacity:1; }
    .side-bg.left{ background-position:left center; }
    .side-bg.right{ background-position:right center; }

    .side-overlay{
      position:absolute;
      inset:0;
      background:linear-gradient(
        180deg,
        rgba(0,0,0,0.42) 0%,
        rgba(0,0,0,0.58) 55%,
        rgba(0,0,0,0.72) 100%
      );
      pointer-events:none;
    }

    .side-caption{
      position:absolute;
      left:18px;
      bottom:16px;
      z-index:3;
      color:rgba(255,255,255,0.78);
      font-size:12.5px;
      letter-spacing:0.2px;
    }

    /* ========= CURADORIA ========= */
    #curadoria h2{
      text-align:center;
      color:#d4af37;
      margin:40px 0 14px;
      font-size:28px;
      letter-spacing:0.2px;
    }

    .subtitle{
      text-align:center;
      color:rgba(255,255,255,0.78);
      max-width:860px;
      margin:0 auto 34px;
      line-height:1.6;
      font-size:15px;
    }

    .card{
      background:linear-gradient(145deg,#111,#000);
      border:1px solid #222;
      border-radius:14px;
      padding:22px;
      transition:all 0.35s ease;
      position:relative;
    }

    .card:hover{
      transform:translateY(-4px);
      border-color:#d4af37;
      box-shadow:0 10px 20px rgba(212,175,55,0.20);
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:22px;
      margin-top:18px;
    }

    .card img{
      width:100%;
      height:150px;
      object-fit:cover;
      border-radius:10px;
      margin-bottom:12px;
      filter:brightness(0.82) saturate(0.9);
    }

    .card h3{
      margin:6px 0 8px;
      color:#d4af37;
      font-size:18px;
      letter-spacing:0.2px;
    }

    .card p{
      margin:0;
      color:rgba(255,255,255,0.75);
      font-size:13.8px;
      line-height:1.5;
    }

    button{
      cursor:pointer;
      padding:10px 16px;
      border-radius:10px;
      border:none;
      background:#d4af37;
      color:#000;
      font-weight:700;
      margin-top:14px;
    }

    button[disabled]{
      opacity:0.6;
      cursor:not-allowed;
    }

    .btn-ghost{
      background:transparent;
      border:1px solid rgba(212,175,55,0.35);
      color:#d4af37;
      font-weight:600;
    }

    .curadoria-panel{
      display:none;
      margin-top:26px;
      border-radius:16px;
      border:1px solid rgba(212,175,55,0.22);
      background:linear-gradient(145deg,#0f0f0f,#0a0a0a);
      padding:18px;
    }

    .panel-top{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    .breadcrumb{
      color:rgba(255,255,255,0.72);
      font-size:13px;
      margin-bottom:6px;
    }

    .panel-title{
      color:#d4af37;
      font-size:20px;
      margin:0;
      letter-spacing:0.2px;
    }

    .panel-meta{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid #222;
      background:#0f0f0f;
      color:rgba(255,255,255,0.75);
      font-size:12.5px;
      line-height:1;
      white-space:nowrap;
    }

    .pill.ok{
      border-color: rgba(212,175,55,0.35);
      color:#d4af37;
    }

    .pill.muted{
      border-color: rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.62);
    }

    .search-wrap{
      flex:1;
      min-width: 240px;
      max-width: 520px;
      position:relative;
    }

    .search-input{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid #222;
      background:#0f0f0f;
      color:#fff;
      outline:none;
      box-sizing:border-box;
      font-size:14px;
    }

    .search-input::placeholder{
      color:rgba(255,255,255,0.45);
    }

    .panel-actions{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }

    .cities-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:14px;
      margin-top:16px;
    }

    .city-card{
      background:#0f0f0f;
      border:1px solid #222;
      border-radius:14px;
      padding:16px;
      text-align:left;
      transition:all 0.3s ease;
      position:relative;
    }

    .city-card:hover{
      transform:translateY(-3px);
      border-color:rgba(212,175,55,0.55);
    }

    .city-card h4{
      margin:0 0 10px;
      color:#fff;
      font-weight:650;
      font-size:15px;
      line-height:1.3;
    }

    .city-card small{
      display:block;
      color:rgba(255,255,255,0.6);
      margin-top:2px;
      font-size:12px;
    }

    .city-meta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
      margin-bottom:8px;
      align-items:center;
    }

    .panel-footer{
      margin-top:14px;
      display:flex;
      justify-content:center;
    }

    .empty-state{
      text-align:center;
      color:rgba(255,255,255,0.68);
      border:1px dashed rgba(255,255,255,0.12);
      border-radius:14px;
      padding:22px 16px;
      margin-top:14px;
      font-size:14px;
      line-height:1.6;
    }

    /* ========= POPUPS ========= */
    .popup-bg{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.85);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:3000;
      padding:18px;
      box-sizing:border-box;
    }

    .popup-bg.active{ display:flex; }

    .popup-content{
      background:#111;
      border:1px solid #222;
      border-radius:14px;
      max-width:720px;
      width:100%;
      padding:24px;
      box-sizing:border-box;
      position:relative;
      text-align:center;
    }

    .popup-content h3{
      margin:0 0 10px;
      color:#d4af37;
      letter-spacing:0.2px;
    }

    .popup-content p{
      margin:0 0 14px;
      color:rgba(255,255,255,0.8);
      line-height:1.6;
      font-size:14px;
    }

    .popup-actions{
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .popup-rules{
      text-align:left;
      margin-top:14px;
      background:#0f0f0f;
      border:1px solid #222;
      border-radius:12px;
      padding:16px;
      color:rgba(255,255,255,0.78);
      font-size:13.5px;
      line-height:1.6;
    }

    .popup-rules strong{ color:#d4af37; }

    .consent-wrap{
      display:flex;
      gap:10px;
      align-items:flex-start;
      margin-top:12px;
      text-align:left;
      padding:12px;
      border:1px solid #222;
      border-radius:12px;
      background:#0f0f0f;
      color:rgba(255,255,255,0.82);
      font-size:13.2px;
      line-height:1.55;
    }

    .consent-wrap input{
      margin-top:3px;
      accent-color:#d4af37;
    }

    /* ========= CARRINHO (popup) ========= */
    .cart-list{
      text-align:left;
      margin-top:14px;
      border:1px solid #222;
      border-radius:12px;
      background:#0f0f0f;
      padding:12px;
    }

    .cart-item{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:12px 10px;
      border-bottom:1px solid rgba(255,255,255,0.08);
    }

    .cart-item:last-child{ border-bottom:none; }

    .cart-item-left{
      min-width:0;
    }

    .cart-item-title{
      color:#fff;
      font-weight:650;
      margin:0 0 4px;
      font-size:14px;
      line-height:1.35;
    }

    .cart-item-meta{
      color:rgba(255,255,255,0.70);
      font-size:12.5px;
      line-height:1.4;
    }

    .cart-item-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:10px;
      white-space:nowrap;
    }

    .cart-total{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      padding:12px;
      border:1px solid rgba(255,255,255,0.10);
      border-radius:12px;
      background:#0f0f0f;
      text-align:left;
    }

    .cart-total strong{ color:#d4af37; }

    @media (max-width:980px){
      header{ padding:14px 16px; }
      section{ padding:110px 16px 70px; }

      .about-layout{
        grid-template-columns:1fr;
        padding:0 16px;
        gap:16px;
        align-items:start;
      }

      .side-panel{ height:240px; margin-top:0; }
      .side-bg.left,.side-bg.right{ background-position:center; }
      .brand{ min-width: auto; }

      .curadoria-panel{ padding:16px; }
      .panel-top{ align-items:flex-start; }
      .search-wrap{ max-width: 100%; }
    }
  </style>
</head>
<body>

<header>
  <div class="brand" onclick="showSection('inicio')">
    <img src="images/rosa-dos-ventos.png" alt="Rosa dos Ventos">
    <div>
      <div class="brand-name">Curadoria Elite Travel</div>
      <div class="brand-tagline">O seu mundo, bem indicado.</div>
    </div>
  </div>

  <nav>
    <a onclick="showSection('inicio')">Início</a>
    <a onclick="showSection('quem')">Quem Somos</a>
    <a onclick="showSection('curadoria')">Curadoria</a>
    <a onclick="showSection('buscador')">Buscador</a>

    <span class="nav-sep"></span>

    <!-- Carrinho -->
    <a id="navCart" onclick="openCart()">Carrinho (0)</a>

    <!-- alterna conforme login -->
    <a id="navAccount" onclick="goAccount()" style="display:none;">Minha conta</a>
    <a id="navLogin" onclick="goLogin()" style="display:none;">Entrar</a>
    <a id="navLogout" onclick="doLogout()" style="display:none;">Sair</a>
  </nav>
</header>

<section id="inicio" class="active">
  <div class="hero">
    <div class="hero-bg active" id="bg1"></div>
    <div class="hero-bg" id="bg2"></div>
    <div class="hero-overlay"></div>

    <div class="hero-content">
      <div>
        <h1>Uma plataforma de curadoria para viajar melhor.</h1>
        <p>Curadoria que orienta. Decisão que flui.</p>
        <p>Selecionamos e organizamos informações essenciais para decisões de viagem mais seguras e bem fundamentadas.</p>
      </div>
    </div>
  </div>
</section>

<section id="quem">
  <div class="about-layout">

    <div class="side-panel" aria-hidden="true">
      <div class="side-panel-inner">
        <div class="side-bg left active" id="sl1"></div>
        <div class="side-bg left" id="sl2"></div>
        <div class="side-overlay"></div>
        <div class="side-caption">Critério · Orientação · Decisão</div>
      </div>
    </div>

    <div class="about-center">
      <h2>Quem Somos</h2>

      <div class="text-block">
        Na Curadoria Elite Travel, acreditamos que o tempo é um dos bens mais valiosos de quem viaja.<br><br>
        Em um cenário onde a praticidade digital é essencial, percebemos que o viajante moderno buscava autonomia sem abrir mão de inspiração, critério e confiança - uma forma clara e organizada de decidir melhor, que ainda não existia.<br><br>
        Foi dessa necessidade que nascemos. A Curadoria Elite Travel é uma plataforma criada para organizar informações e oferecer indicações criteriosas, transformando destinos em universos referenciados e acessíveis digitalmente.<br><br>
        Nossa curadoria é composta por indicações, referências e orientações práticas, pensadas para apoiar decisões de viagem antes e durante a experiência.<br><br>
        Não somos uma agência de viagens e não realizamos reservas. Nosso papel é selecionar, estruturar e apresentar conhecimento de qualidade para quem prefere decidir com segurança e clareza.<br><br>
        <strong>O seu mundo, bem indicado.</strong>
      </div>

      <div class="rules-block">
        <strong>Informações Importantes</strong><br><br>

        A Curadoria Elite Travel oferece exclusivamente materiais digitais de caráter informativo e orientativo, baseados em indicações, referências e conteúdos selecionados.<br><br>

        Não realizamos reservas, vendas de passagens, hospedagens, experiências ou qualquer tipo de intermediação direta com fornecedores ou prestadores de serviço.<br><br>

        As decisões de compra, contratação e utilização de serviços indicados nos materiais são de <span class="hl">responsabilidade exclusiva do usuário</span>, assim como qualquer tratativa, solicitação, alteração ou eventual problema relacionado aos serviços contratados.<br><br>

        Por se tratar de conteúdo digital disponibilizado de forma imediata após a confirmação da compra, <span class="hl">não é possível realizar cancelamentos, trocas ou reembolsos</span>.<br><br>

        Ao adquirir nossos materiais, o usuário declara estar ciente e de acordo com essas condições.
      </div>
    </div>

    <div class="side-panel" aria-hidden="true">
      <div class="side-panel-inner">
        <div class="side-bg right active" id="sr1"></div>
        <div class="side-bg right" id="sr2"></div>
        <div class="side-overlay"></div>
      </div>
    </div>

  </div>
</section>

<section id="curadoria">
  <h2>Curadoria</h2>
  <p class="subtitle">
    Materiais digitais desenvolvidos para apoiar decisões de viagem com critério, clareza e indicações bem organizadas.
  </p>

  <div class="card" style="text-align:center; max-width:900px; margin:0 auto;">
    <h3 style="margin-top:0;">Overview</h3>
    <p>Conheça o formato, a profundidade e o padrão dos materiais que entregamos.</p>
    <button onclick="openOverview()">Abrir overview</button>
  </div>

  <!-- Grid de categorias (mantido como está) -->
  <div id="curadoria-categories" class="grid" style="margin-top:26px;">
    <div class="card" onclick="openCategory('City Guide')">
      <img src="https://images.unsplash.com/photo-1505761671935-60b3a7427bad?auto=format&fit=crop&w=1200&q=80">
      <h3>City Guide</h3>
      <p>Indicações essenciais por destino, com foco em clareza e praticidade.</p>
    </div>

    <div class="card" onclick="openCategory('Gastronomia')">
      <img src="https://images.unsplash.com/photo-1528605248644-14dd04022da1?auto=format&fit=crop&w=1200&q=80">
      <h3>Gastronomia</h3>
      <p>Seleções gastronômicas para decisões mais seguras e bem orientadas.</p>
    </div>

    <div class="card" onclick="openCategory('Atrações Turísticas')">
      <img src="https://images.unsplash.com/photo-1526778548025-fa2f459cd5c1?auto=format&fit=crop&w=1200&q=80">
      <h3>Atrações Turísticas</h3>
      <p>O que vale seu tempo - com contexto e organização por destino.</p>
    </div>

    <div class="card" onclick="openCategory('Vida Noturna')">
      <img src="https://images.unsplash.com/photo-1506157786151-b8491531f063?auto=format&fit=crop&w=1200&q=80">
      <h3>Vida Noturna</h3>
      <p>Locais e experiências noturnas com curadoria e referências.</p>
    </div>

    <div class="card" onclick="openCategory('Endereços para Compras')">
      <img src="https://images.unsplash.com/photo-1483985988355-763728e1935b?auto=format&fit=crop&w=1200&q=80">
      <h3>Endereços para Compras</h3>
      <p>Lojas, regiões e referências para comprar bem e com intenção.</p>
    </div>

    <div class="card" onclick="openCategory('Sugestão de Presentes')">
      <img src="https://images.unsplash.com/photo-1512909006721-3d6018887383?auto=format&fit=crop&w=1200&q=80">
      <h3>Sugestão de Presentes</h3>
      <p>Ideias e recomendações para presentes com bom senso e estilo.</p>
    </div>
  </div>

  <!-- Painel interno -->
  <div id="curadoria-panel" class="curadoria-panel">
    <div class="panel-top">
      <div>
        <div class="breadcrumb" id="breadcrumb">Curadoria</div>
        <h3 class="panel-title" id="panel-title">Categoria</h3>
        <div class="panel-meta">
          <span class="pill" id="cities-count">0 cidades</span>
          <span class="pill" id="visible-count">Mostrando 0</span>
          <span class="pill muted" id="admin-status">Admin: carregando...</span>
        </div>
      </div>

      <div class="panel-actions">
        <div class="search-wrap">
          <input
            id="city-search"
            class="search-input"
            type="text"
            placeholder="Buscar cidade..."
            oninput="onSearchCity()"
          />
        </div>
        <button class="btn-ghost" onclick="closeCategory()">← Voltar</button>
      </div>
    </div>

    <div id="cities-grid" class="cities-grid"></div>

    <div id="empty-state" class="empty-state" style="display:none;">
      Nenhum material disponível no momento.
    </div>

    <div class="panel-footer">
      <button id="btn-more" class="btn-ghost" style="display:none;" onclick="loadMoreCities()">
        Ver mais cidades
      </button>
    </div>
  </div>
</section>

<section id="buscador">
  <h2 style="text-align:center;color:#d4af37;margin:40px 0 14px;">Buscador</h2>
  <p class="subtitle">Em breve: área integrada com buscadores e indicações.</p>
</section>

<footer>
  Curadoria Elite Travel · O seu mundo, bem indicado.<br>
  São Paulo - SP · curadoriaelitetravel@gmail.com
</footer>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  function showSection(id){
    document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
    const el = document.getElementById(id);
    if (el) el.classList.add("active");
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function openOverview(){
    window.location.href = "https://lnyoqoezezisakghtmim.supabase.co/storage/v1/object/public/materiais/overview/general-overview.pdf";
  }

  /* =========================
     POPUP (atualizado: inclui botão extra opcional)
  ========================= */
  function ensurePopupExists(){
    if (document.getElementById("popup")) return;

    const popupHTML = `
      <div class="popup-bg" id="popup">
        <div class="popup-content" id="popup-content">
          <h3 id="popup-title"></h3>
          <p id="popup-text"></p>

          <div class="popup-rules" id="popup-rules" style="display:none;">
            <strong>Informações Importantes</strong><br><br>
            A Curadoria Elite Travel oferece exclusivamente materiais digitais de caráter informativo e orientativo, baseados em indicações, referências e conteúdos selecionados.<br><br>
            Não realizamos reservas, vendas de passagens, hospedagens, experiências ou qualquer tipo de intermediação direta com fornecedores ou prestadores de serviço.<br><br>
            As decisões de compra, contratação e utilização de serviços indicados nos materiais são de <strong>responsabilidade exclusiva do usuário</strong>, assim como qualquer tratativa, solicitação, alteração ou eventual problema relacionado aos serviços contratados.<br><br>
            Por se tratar de conteúdo digital disponibilizado de forma imediata após a confirmação da compra, <strong>não é possível realizar cancelamentos, trocas ou reembolsos</strong>.<br><br>
            Ao adquirir nossos materiais, o usuário declara estar ciente e de acordo com essas condições.
          </div>

          <div class="popup-actions">
            <button id="popup-secondary" class="btn-ghost" style="display:none;">Minha conta</button>
            <button id="popup-tertiary" class="btn-ghost" style="display:none;">Sair</button>
            <button id="popup-prosseguir" style="display:none;">Prosseguir</button>
            <button class="btn-ghost" id="popup-fechar">Fechar</button>
          </div>
        </div>
      </div>
    `;

    const wrap = document.createElement("div");
    wrap.innerHTML = popupHTML;
    document.body.appendChild(wrap);

    document.getElementById("popup-fechar").addEventListener("click", closePopup);
  }

  function openPopup({
    title="",
    text="",
    showProsseguir=false,
    showRules=false,
    onProsseguir=null,
    secondaryText=null,
    onSecondary=null,
    tertiaryText=null,
    onTertiary=null
  }){
    ensurePopupExists();

    document.getElementById("popup-title").innerText = title;
    document.getElementById("popup-text").innerText = text;

    const rules = document.getElementById("popup-rules");
    rules.style.display = showRules ? "block" : "none";

    const btn = document.getElementById("popup-prosseguir");
    btn.style.display = showProsseguir ? "inline-block" : "none";
    btn.disabled = false;
    btn.innerText = "Prosseguir";

    const btn2 = document.getElementById("popup-secondary");
    if (secondaryText && typeof onSecondary === "function"){
      btn2.style.display = "inline-block";
      btn2.innerText = secondaryText;
      btn2.onclick = () => {
        try{ closePopup(); }catch(e){}
        onSecondary();
      };
    }else{
      btn2.style.display = "none";
      btn2.onclick = null;
    }

    const btn3 = document.getElementById("popup-tertiary");
    if (tertiaryText && typeof onTertiary === "function"){
      btn3.style.display = "inline-block";
      btn3.innerText = tertiaryText;
      btn3.onclick = () => {
        try{ closePopup(); }catch(e){}
        onTertiary();
      };
    }else{
      btn3.style.display = "none";
      btn3.onclick = null;
    }

    const old = document.getElementById("consent-checkbox-wrap");
    if (old) old.remove();

    if (showProsseguir){
      const actions = document.querySelector("#popup-content .popup-actions");

      const consentWrap = document.createElement("div");
      consentWrap.id = "consent-checkbox-wrap";
      consentWrap.className = "consent-wrap";
      consentWrap.innerHTML = `
        <input type="checkbox" id="consent-checkbox" />
        <label for="consent-checkbox">(Li e concordo que, por ser um produto digital de acesso imediato, não será possível realizar cancelamentos, trocas ou reembolsos após a confirmação da compra.)</label>
      `;

      actions.parentNode.insertBefore(consentWrap, actions);

      btn.disabled = true;

      const cb = document.getElementById("consent-checkbox");
      cb.addEventListener("change", () => {
        btn.disabled = !cb.checked;
      });
    }

    btn.onclick = null;
    if (showProsseguir && typeof onProsseguir === "function"){
      btn.onclick = async () => {
        try{
          btn.disabled = true;
          btn.innerText = "Aguarde...";
          closePopup();
          await onProsseguir();
        }catch(e){
          openPopup({
            title: "Pagamento",
            text: "Não foi possível prosseguir. Tente novamente.",
            showProsseguir: false,
            showRules: false
          });
        }
      };
    }

    document.getElementById("popup").classList.add("active");
  }

  function closePopup(){
    const p = document.getElementById("popup");
    if (p) p.classList.remove("active");

    const old = document.getElementById("consent-checkbox-wrap");
    if (old) old.remove();

    const btn = document.getElementById("popup-prosseguir");
    if (btn){
      btn.disabled = false;
      btn.innerText = "Prosseguir";
    }

    const btn2 = document.getElementById("popup-secondary");
    if (btn2){
      btn2.style.display = "none";
      btn2.onclick = null;
    }

    const btn3 = document.getElementById("popup-tertiary");
    if (btn3){
      btn3.style.display = "none";
      btn3.onclick = null;
    }
  }

  /* =========================
     CARRINHO (popup) - estrutura + base
  ========================= */
  const CART_STORAGE_KEY = "cet_cart_v1";
  const CHECKOUT_CONTEXT_KEY = "cet_checkout_context_v1";

  function ensureCartPopupExists(){
    if (document.getElementById("cartPopup")) return;

    const cartHTML = `
      <div class="popup-bg" id="cartPopup">
        <div class="popup-content" id="cartPopupContent">
          <h3>Carrinho</h3>
          <p id="cartSubtitle">Revise seus materiais antes de prosseguir.</p>

          <div class="cart-list" id="cartList"></div>

          <div class="cart-total" id="cartTotalWrap" style="display:none;">
            <div><strong>Total</strong></div>
            <div id="cartTotalValue"><strong>R$ 0,00</strong></div>
          </div>

          <div class="popup-actions">
            <button class="btn-ghost" id="cartContinueBtn">Continuar comprando</button>
            <button id="cartProceedBtn">Prosseguir</button>
            <button class="btn-ghost" id="cartCloseBtn">Fechar</button>
          </div>
        </div>
      </div>
    `;

    const wrap = document.createElement("div");
    wrap.innerHTML = cartHTML;
    document.body.appendChild(wrap);

    document.getElementById("cartCloseBtn").addEventListener("click", closeCart);
    document.getElementById("cartContinueBtn").addEventListener("click", closeCart);

    document.getElementById("cartProceedBtn").addEventListener("click", async () => {
      await startCartCheckoutFlow();
    });
  }

  function getCart(){
    try{
      const raw = localStorage.getItem(CART_STORAGE_KEY);
      const parsed = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(parsed)) return [];
      return parsed;
    }catch(e){
      return [];
    }
  }

  function saveCart(items){
    try{
      localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(items || []));
    }catch(e){}
    updateCartBadge();
  }

  function cartItemKey(category, cityLabel){
    return purchaseKey(category, cityLabel);
  }

  function addToCart(category, cityLabel){
    const items = getCart();
    const k = cartItemKey(category, cityLabel);

    const exists = items.some(it => it && it.key === k);
    if (exists){
      openPopup({
        title: "Carrinho",
        text: "Este material já está no carrinho.",
        showProsseguir: false,
        showRules: false
      });
      return;
    }

    const price = getPriceForCategory(category);

    items.push({
      key: k,
      category: String(category || "").trim(),
      city: String(cityLabel || "").trim(),
      qty: 1,
      price: Number(price || 0)
    });

    saveCart(items);

    openPopup({
      title: "Carrinho",
      text: "Material adicionado ao carrinho.",
      showProsseguir: false,
      showRules: false
    });
  }

  function removeFromCart(key){
    const items = getCart().filter(it => it && it.key !== key);
    saveCart(items);
    renderCart();
  }

  function calcCartTotal(items){
    let total = 0;
    (items || []).forEach(it => {
      const q = Number(it.qty || 0);
      const p = Number(it.price || 0);
      total += (q * p);
    });
    return total;
  }

  function renderCart(){
    ensureCartPopupExists();

    const listEl = document.getElementById("cartList");
    const totalWrap = document.getElementById("cartTotalWrap");
    const totalVal = document.getElementById("cartTotalValue");

    const items = getCart();

    if (!items.length){
      listEl.innerHTML = `
        <div style="padding:14px;color:rgba(255,255,255,0.70);line-height:1.6;">
          Seu carrinho está vazio.
        </div>
      `;
      if (totalWrap) totalWrap.style.display = "none";
      return;
    }

    listEl.innerHTML = "";

    items.forEach(it => {
      const div = document.createElement("div");
      div.className = "cart-item";

      const price = formatBRL(Number(it.price || 0));
      const qty = Number(it.qty || 1) || 1;

      div.innerHTML = `
        <div class="cart-item-left">
          <div class="cart-item-title">${it.city}</div>
          <div class="cart-item-meta">
            Quantidade: ${qty} · ${it.category}
          </div>
          <div class="cart-item-meta">
            ${price}
          </div>
        </div>
        <div class="cart-item-right">
          <button class="btn-ghost" data-remove="${it.key}" style="margin-top:0;">Remover</button>
        </div>
      `;

      const btnRemove = div.querySelector("[data-remove]");
      btnRemove.addEventListener("click", () => removeFromCart(it.key));

      listEl.appendChild(div);
    });

    const total = calcCartTotal(items);
    if (totalWrap) totalWrap.style.display = "flex";
    if (totalVal) totalVal.innerHTML = `<strong>${formatBRL(total)}</strong>`;
  }

  function openCart(){
    ensureCartPopupExists();
    renderCart();
    document.getElementById("cartPopup").classList.add("active");
  }

  function closeCart(){
    const p = document.getElementById("cartPopup");
    if (p) p.classList.remove("active");
  }

  function updateCartBadge(){
    const el = document.getElementById("navCart");
    if (!el) return;
    const items = getCart();
    const count = (items || []).length;
    el.innerText = "Carrinho (" + count + ")";
  }

  /* =========================
     SUPABASE
  ========================= */
  const SUPABASE_URL = "https://lnyoqoezezisakghtmim.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxueW9xb2V6ZXppc2FrZ2h0bWltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNjI4OTMsImV4cCI6MjA3OTczODg5M30.Nn9ZPRXeJlvCGJ2kXQ3XBvT743pQn2VIXEsT9pexqnA";

  let supabaseClient = null;

  function ensureSupabase(){
    if (supabaseClient) return supabaseClient;
    if (!window.supabase) return null;
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    return supabaseClient;
  }

  async function getSession(){
    const sb = ensureSupabase();
    if (!sb) return null;
    const { data } = await sb.auth.getSession();
    return (data && data.session) ? data.session : null;
  }

  /* =========================
     Cabeçalho (auth) - AJUSTADO
  ========================= */
  async function refreshNavAuth(){
    const s = await getSession();
    const navLogin = document.getElementById("navLogin");
    const navLogout = document.getElementById("navLogout");
    const navAccount = document.getElementById("navAccount");

    if (!navLogin || !navLogout || !navAccount) return;

    if (s && s.user){
      navLogin.style.display = "none";
      navAccount.style.display = "inline";
      navLogout.style.display = "inline";
    }else{
      navLogin.style.display = "inline";
      navAccount.style.display = "none";
      navLogout.style.display = "none";
    }
  }

  function goLogin(){
    window.location.href = "login.html?return_to=index.html";
  }

  function goLoginWithReturn(returnTo){
    window.location.href = "login.html?return_to=" + encodeURIComponent(returnTo);
  }

  function goAccount(){
    window.location.href = "account.html";
  }

  async function doLogout(){
    try{
      const sb = ensureSupabase();
      if (sb) await sb.auth.signOut();
    }catch(e){}
    try{ await refreshNavAuth(); }catch(e){}
    openPopup({
      title: "Acesso à conta",
      text: "Você saiu da sua conta.",
      showProsseguir: false,
      showRules: false
    });
  }

  /* =========================
     NORMALIZAÇÃO + PREÇO
  ========================= */
  function normalizeKeyPart(str){
    const s = String(str || "")
      .trim()
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/[—–−]/g, "-")
      .replace(/\s*-\s*/g, " - ")
      .replace(/\s+/g, " ")
      .trim();
    return s;
  }

  function purchaseKey(category, cityLabel){
    return normalizeKeyPart(category) + "||" + normalizeKeyPart(cityLabel);
  }

  function formatBRL(v){
    try{
      return new Intl.NumberFormat("pt-BR", { style:"currency", currency:"BRL" }).format(v);
    }catch(e){
      return "R$ " + String(v);
    }
  }

  function getPriceForCategory(category){
    const c = String(category || "").trim().toLowerCase();
    if (c === "city guide") return 88.92;
    return 57.83;
  }

  /* =========================
     CONTEXTO DE CHECKOUT (para voltar do login)
  ========================= */
  function setCheckoutContext(obj){
    try{
      localStorage.setItem(CHECKOUT_CONTEXT_KEY, JSON.stringify(obj || {}));
    }catch(e){}
  }

  function getCheckoutContext(){
    try{
      const raw = localStorage.getItem(CHECKOUT_CONTEXT_KEY);
      return raw ? JSON.parse(raw) : null;
    }catch(e){
      return null;
    }
  }

  function clearCheckoutContext(){
    try{ localStorage.removeItem(CHECKOUT_CONTEXT_KEY); }catch(e){}
  }

  /* =========================
     PASSO: Nota Fiscal (página já existente)
     - para 1 item: usa query category/city (como você já tinha)
     - para carrinho: salva itens no localStorage e redireciona com flag cart=1
  ========================= */
  const CART_CHECKOUT_ITEMS_KEY = "cet_cart_checkout_items_v1";

  function goInvoiceSingle(category, city){
    const url =
      "checkout-success.html?step=invoice&category=" +
      encodeURIComponent(category) +
      "&city=" +
      encodeURIComponent(city);

    window.location.href = url;
  }

  function goInvoiceCart(items){
    // salva os itens para a próxima página ler (checkout-success.html)
    try{
      const payload = (items || []).map(it => ({
        category: it.category,
        city: it.city,
        qty: Number(it.qty || 1) || 1
      }));
      localStorage.setItem(CART_CHECKOUT_ITEMS_KEY, JSON.stringify(payload));
    }catch(e){}

    window.location.href = "checkout-success.html?step=invoice&cart=1";
  }

  /* =========================
     PASSO: Política (checkbox) -> depois Nota Fiscal
  ========================= */
  async function showPolicyThenProceed(nextFn){
    // o texto completo já está no "Informações Importantes" (popup-rules)
    openPopup({
      title: "Informações Importantes",
      text: "Antes de prosseguir, confirme as condições abaixo.",
      showProsseguir: true,
      showRules: true,
      onProsseguir: async () => {
        await nextFn();
      }
    });
  }

  /* =========================
     FLUXO: Carrinho -> Login (se precisar) -> Política -> Nota Fiscal
  ========================= */
  async function startCartCheckoutFlow(){
    const items = getCart();
    if (!items.length){
      openPopup({
        title: "Carrinho",
        text: "Seu carrinho está vazio.",
        showProsseguir: false,
        showRules: false
      });
      return;
    }

    const sess = await getSession();
    if (!sess || !sess.user){
      // guarda intenção e vai para login, voltando para o index
      setCheckoutContext({ type: "cart" });
      closeCart();
      goLoginWithReturn("index.html?after_login=1");
      return;
    }

    // logado -> política -> nota fiscal (carrinho)
    closeCart();
    await showPolicyThenProceed(async () => {
      goInvoiceCart(items);
    });
  }

  /* =========================
     FLUXO: Compra 1 item -> Login (se precisar) -> Política -> Nota Fiscal
  ========================= */
  async function startSingleCheckoutFlow(category, city){
    const sess = await getSession();
    if (!sess || !sess.user){
      setCheckoutContext({ type: "single", category, city });
      goLoginWithReturn("index.html?after_login=1");
      return;
    }

    await showPolicyThenProceed(async () => {
      goInvoiceSingle(category, city);
    });
  }

  /* =========================
     DADOS AUTOMÁTICOS DO SUPABASE
  ========================= */
  const materiaisAtivosPorCategoria = new Map();
  const ownedMap = new Map(); // purchases do usuário logado

  function setAdminStatus(text, ok){
    const el = document.getElementById("admin-status");
    if (!el) return;
    el.innerText = text;
    el.classList.remove("ok","muted");
    el.classList.add(ok ? "ok" : "muted");
  }

  async function loadActiveMaterials(){
    materiaisAtivosPorCategoria.clear();

    try{
      ensureSupabase();

      const { data, error } = await supabaseClient
        .from("curadoria_materials")
        .select("category, city_label, pdf_url")
        .eq("is_active", true)
        .order("city_label", { ascending: true });

      if (error){
        setAdminStatus("Admin: erro ao carregar", false);
        return;
      }

      (data || []).forEach(row => {
        const cat = String(row.category || "").trim();
        const city = String(row.city_label || "").trim();
        const url = row.pdf_url || null;

        if (!cat || !city || !url) return;

        if (!materiaisAtivosPorCategoria.has(cat)) materiaisAtivosPorCategoria.set(cat, []);
        materiaisAtivosPorCategoria.get(cat).push({ cidade: city, pdf_url: url });
      });

      setAdminStatus("Admin: conectado", true);
    }catch(e){
      setAdminStatus("Admin: falha na conexão", false);
    }
  }

  async function loadOwnedPurchases(){
    ownedMap.clear();

    try{
      const sess = await getSession();
      if (!sess || !sess.user) return;

      ensureSupabase();

      const { data, error } = await supabaseClient
        .from("purchase")
        .select("category, city, pdf_url")
        .eq("user_id", sess.user.id)
        .limit(500);

      if (error) return;

      (data || []).forEach(row => {
        const k = purchaseKey(row.category || "", row.city || "");
        ownedMap.set(k, { pdf_url: row.pdf_url || null });
      });
    }catch(e){}
  }

  function userOwns(category, cityLabel){
    return ownedMap.has(purchaseKey(category, cityLabel));
  }

  /* =========================
     CURADORIA PANEL
  ========================= */
  const BATCH_SIZE = 12;
  let currentCategory = null;
  let filteredCities = [];
  let visibleCount = 0;

  function normalizeText(str){
    return normalizeKeyPart(str || "");
  }

  function openCategory(category){
    currentCategory = category;

    const panel = document.getElementById("curadoria-panel");
    if (!panel) return;
    panel.style.display = "block";

    const bc = document.getElementById("breadcrumb");
    const pt = document.getElementById("panel-title");
    if (bc) bc.innerText = "Curadoria > " + category;
    if (pt) pt.innerText = category;

    const input = document.getElementById("city-search");
    if (input) input.value = "";

    const list = materiaisAtivosPorCategoria.get(category) || [];
    filteredCities = list.slice();
    visibleCount = Math.min(BATCH_SIZE, filteredCities.length);

    renderCities();

    setTimeout(() => {
      panel.scrollIntoView({ behavior: "smooth", block: "start" });
      if (input) input.focus({ preventScroll: true });
    }, 120);
  }

  function closeCategory(){
    const panel = document.getElementById("curadoria-panel");
    if (panel) panel.style.display = "none";
    currentCategory = null;
    filteredCities = [];
    visibleCount = 0;

    const cats = document.getElementById("curadoria-categories");
    if (cats) cats.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  function onSearchCity(){
    if (!currentCategory) return;

    const input = document.getElementById("city-search");
    const q = normalizeText(input ? input.value : "");
    const all = (materiaisAtivosPorCategoria.get(currentCategory) || []);

    if (!q) filteredCities = all.slice();
    else filteredCities = all.filter(item => normalizeText(item.cidade).includes(q));

    visibleCount = Math.min(BATCH_SIZE, filteredCities.length);
    renderCities();
  }

  function loadMoreCities(){
    visibleCount = Math.min(visibleCount + BATCH_SIZE, filteredCities.length);
    renderCities(true);
  }

  function renderCities(){
    const grid = document.getElementById("cities-grid");
    const empty = document.getElementById("empty-state");
    const btnMore = document.getElementById("btn-more");
    const citiesCount = document.getElementById("cities-count");
    const visible = document.getElementById("visible-count");

    if (!grid) return;

    const total = filteredCities.length;

    if (citiesCount) citiesCount.innerText = total + (total === 1 ? " cidade" : " cidades");
    if (visible) visible.innerText = "Mostrando " + Math.min(visibleCount, total);

    if (total === 0){
      grid.innerHTML = "";
      if (empty) empty.style.display = "block";
      if (btnMore) btnMore.style.display = "none";
      return;
    }

    if (empty) empty.style.display = "none";

    const slice = filteredCities.slice(0, visibleCount);
    grid.innerHTML = "";

    slice.forEach((item) => {
      const div = document.createElement("div");
      div.className = "city-card";

      const cityLabel = item.cidade || "";
      const price = formatBRL(getPriceForCategory(currentCategory));

      const badge = `<span class="pill ok">Disponível</span>`;
      const pricePill = `<span class="pill muted">${price}</span>`;

      div.innerHTML = `
        <h4>${cityLabel}<small>Material digital com indicações selecionadas</small></h4>
        <div class="city-meta">${badge} ${pricePill}</div>
        <button>Acessar</button>
      `;

      const btn = div.querySelector("button");
      btn.addEventListener("click", () => openCityModal(currentCategory, cityLabel));

      grid.appendChild(div);
    });

    if (btnMore){
      btnMore.style.display = visibleCount < total ? "inline-flex" : "none";
    }
  }

  /* =========================
     Modal da cidade
     - Novo: "Adicionar ao carrinho"
     - Compra (Prosseguir) passa pelo fluxo: Login -> Política -> Nota Fiscal
     - "Já possui" é sucinto + pode comprar novamente (mesmo fluxo)
  ========================= */
  function openCityModal(category, city){
    const msg =
      `${category} é um material digital com indicações e referências selecionadas para apoiar suas decisões de viagem. ` +
      `Este conteúdo é liberado após a confirmação da compra.`;

    const owns = userOwns(category, city);

    if (owns){
      openPopup({
        title: city,
        text: "Você já possui este produto. Deseja comprar novamente?",
        showProsseguir: true,
        showRules: false, // a política aparece no passo seguinte (obrigatório)
        secondaryText: "Minha conta",
        onSecondary: () => goAccount(),
        tertiaryText: "Sair",
        onTertiary: () => doLogout(),
        onProsseguir: async () => {
          await startSingleCheckoutFlow(category, city);
        }
      });
      return;
    }

    // Não possui: pode adicionar ao carrinho OU comprar agora
    openPopup({
      title: city,
      text: msg,
      showProsseguir: true,
      showRules: false, // a política aparece no passo seguinte (obrigatório)
      secondaryText: "Adicionar ao carrinho",
      onSecondary: () => {
        addToCart(category, city);
        try{ openCart(); }catch(e){}
      },
      onProsseguir: async () => {
        await startSingleCheckoutFlow(category, city);
      }
    });
  }

  /* =========================
     INIT
     - Se voltou do login, retoma a intenção (carrinho ou item)
  ========================= */
  async function handleAfterLoginResume(){
    const url = new URL(window.location.href);
    const after = url.searchParams.get("after_login");
    if (!after) return;

    const ctx = getCheckoutContext();
    clearCheckoutContext();

    // limpa o param da URL para não repetir em refresh
    url.searchParams.delete("after_login");
    window.history.replaceState({}, document.title, url.toString());

    if (!ctx || !ctx.type) return;

    // atualiza compras (agora logado)
    try{ await loadOwnedPurchases(); }catch(e){}
    try{ await refreshNavAuth(); }catch(e){}

    if (ctx.type === "cart"){
      // retoma carrinho -> política -> nota fiscal
      await startCartCheckoutFlow();
      return;
    }

    if (ctx.type === "single" && ctx.category && ctx.city){
      await startSingleCheckoutFlow(ctx.category, ctx.city);
      return;
    }
  }

  document.addEventListener("DOMContentLoaded", async () => {
    ensureSupabase();

    updateCartBadge();
    await refreshNavAuth();

    await loadActiveMaterials();
    await loadOwnedPurchases();

    await handleAfterLoginResume();
  });
</script>

</body>
</html>
<!-- =========================
     INDEX.HTML (PARTE 3/3) — FINAL
     Ajustes finais:
     1) Checkbox (política) aparece APENAS no passo da política (não em outros popups)
     2) Fluxo completo confirmado:
        Carrinho -> (Login se precisar) -> Política (checkbox + texto) -> Nota Fiscal -> Stripe
        Recompra (já possui) -> mesmo fluxo acima
     3) Mantém layout/estilo/textos. Só comportamento.
========================= -->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Curadoria Elite Travel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body{
      margin:0;
      font-family:"Segoe UI",sans-serif;
      background:#0b0b0b;
      color:#fff;
      overflow-x:hidden;
    }

    header{
      padding:16px 40px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:fixed;
      width:100%;
      top:0;
      z-index:1000;
      background:rgba(0,0,0,0.25);
      backdrop-filter:blur(8px);
      border-bottom:1px solid rgba(255,255,255,0.06);
      box-sizing:border-box;
      gap:16px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 240px;
      cursor:pointer;
    }

    .brand img{
      height:34px;
      width:34px;
    }

    .brand-name{
      font-family:"Cinzel","Georgia",serif;
      font-size:18px;
      color:#d4af37;
      letter-spacing:0.8px;
      text-transform:uppercase;
      line-height:1.1;
    }

    .brand-tagline{
      font-size:12px;
      color:rgba(255,255,255,0.7);
      line-height:1.2;
      margin-top:2px;
    }

    nav{
      display:flex;
      align-items:center;
      gap:16px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    nav a{
      color:#d4af37;
      text-decoration:none;
      font-weight:500;
      cursor:pointer;
      white-space: nowrap;
    }

    .nav-sep{
      width:1px;
      height:16px;
      background:rgba(255,255,255,0.12);
      display:inline-block;
      margin:0 2px;
    }

    section{
      display:none;
      padding:120px 40px 80px;
      max-width:1100px;
      margin:auto;
      box-sizing:border-box;
    }

    section.active{ display:block; }

    footer{
      border-top:1px solid #222;
      padding:30px;
      text-align:center;
      color:#888;
      font-size:14px;
    }

    /* ========= HOME (Hero) ========= */
    #inicio{
      padding:0;
      max-width:none;
    }

    .hero{
      height:100vh;
      position:relative;
      overflow:hidden;
      background:#0b0b0b;
    }

    .hero-bg{
      position:absolute;
      inset:0;
      background-size:cover;
      background-position:center;
      filter:brightness(0.42) saturate(0.6);
      opacity:0;
      transition:opacity 3s ease;
      transform:scale(1.03);
    }

    .hero-bg.active{ opacity:1; }

    .hero-overlay{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,0.68);
    }

    .hero-content{
      position:relative;
      z-index:2;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:20px;
      box-sizing:border-box;
    }

    .hero-content h1{
      color:#d4af37;
      font-size:clamp(28px,4vw,52px);
      margin:0 0 12px;
    }

    .hero-content p{
      color:rgba(255,255,255,0.85);
      margin:6px 0;
      font-size:15px;
      line-height:1.6;
    }

    /* ========= QUEM SOMOS ========= */
    #quem{
      max-width:none;
      padding-left:0;
      padding-right:0;
    }

    .about-layout{
      display:grid;
      grid-template-columns:minmax(260px,1fr) minmax(520px,760px) minmax(260px,1fr);
      gap:26px;
      align-items:stretch;
      padding:0 40px;
      box-sizing:border-box;
    }

    .about-center{
      display:flex;
      flex-direction:column;
    }

    .about-center h2{
      text-align:center;
      color:#d4af37;
      margin:40px 0 34px;
      font-size:28px;
      letter-spacing:0.2px;
    }

    .text-block{
      color:#ddd;
      font-size:15px;
      line-height:1.7;
      max-width:760px;
      margin:0 auto 54px;
      text-align:center;
    }

    .rules-block{
      background:#111;
      border:1px solid #222;
      border-radius:14px;
      padding:30px;
      max-width:760px;
      margin:0 auto;
      font-size:14px;
      line-height:1.6;
      color:#ccc;
    }

    .rules-block strong{
      color:#d4af37;
      font-weight:700;
    }

    .rules-block .hl{
      color:#d4af37;
      font-weight:600;
    }

    .side-panel{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      border:1px solid #222;
      background:#0b0b0b;
      margin-top:92px;
      height:calc(100% - 92px);
    }

    .side-panel-inner{
      position:absolute;
      inset:0;
    }

    .side-bg{
      position:absolute;
      inset:0;
      background-size:cover;
      opacity:0;
      transition:opacity 3.2s ease;
      transform:scale(1.02);
      filter:brightness(0.72) saturate(0.9) contrast(0.95);
    }

    .side-bg.active{ opacity:1; }
    .side-bg.left{ background-position:left center; }
    .side-bg.right{ background-position:right center; }

    .side-overlay{
      position:absolute;
      inset:0;
      background:linear-gradient(
        180deg,
        rgba(0,0,0,0.42) 0%,
        rgba(0,0,0,0.58) 55%,
        rgba(0,0,0,0.72) 100%
      );
      pointer-events:none;
    }

    .side-caption{
      position:absolute;
      left:18px;
      bottom:16px;
      z-index:3;
      color:rgba(255,255,255,0.78);
      font-size:12.5px;
      letter-spacing:0.2px;
    }

    /* ========= CURADORIA ========= */
    #curadoria h2{
      text-align:center;
      color:#d4af37;
      margin:40px 0 14px;
      font-size:28px;
      letter-spacing:0.2px;
    }

    .subtitle{
      text-align:center;
      color:rgba(255,255,255,0.78);
      max-width:860px;
      margin:0 auto 34px;
      line-height:1.6;
      font-size:15px;
    }

    .card{
      background:linear-gradient(145deg,#111,#000);
      border:1px solid #222;
      border-radius:14px;
      padding:22px;
      transition:all 0.35s ease;
      position:relative;
    }

    .card:hover{
      transform:translateY(-4px);
      border-color:#d4af37;
      box-shadow:0 10px 20px rgba(212,175,55,0.20);
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:22px;
      margin-top:18px;
    }

    .card img{
      width:100%;
      height:150px;
      object-fit:cover;
      border-radius:10px;
      margin-bottom:12px;
      filter:brightness(0.82) saturate(0.9);
    }

    .card h3{
      margin:6px 0 8px;
      color:#d4af37;
      font-size:18px;
      letter-spacing:0.2px;
    }

    .card p{
      margin:0;
      color:rgba(255,255,255,0.75);
      font-size:13.8px;
      line-height:1.5;
    }

    button{
      cursor:pointer;
      padding:10px 16px;
      border-radius:10px;
      border:none;
      background:#d4af37;
      color:#000;
      font-weight:700;
      margin-top:14px;
    }

    button[disabled]{
      opacity:0.6;
      cursor:not-allowed;
    }

    .btn-ghost{
      background:transparent;
      border:1px solid rgba(212,175,55,0.35);
      color:#d4af37;
      font-weight:600;
    }

    .curadoria-panel{
      display:none;
      margin-top:26px;
      border-radius:16px;
      border:1px solid rgba(212,175,55,0.22);
      background:linear-gradient(145deg,#0f0f0f,#0a0a0a);
      padding:18px;
    }

    .panel-top{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    .breadcrumb{
      color:rgba(255,255,255,0.72);
      font-size:13px;
      margin-bottom:6px;
    }

    .panel-title{
      color:#d4af37;
      font-size:20px;
      margin:0;
      letter-spacing:0.2px;
    }

    .panel-meta{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid #222;
      background:#0f0f0f;
      color:rgba(255,255,255,0.75);
      font-size:12.5px;
      line-height:1;
      white-space:nowrap;
    }

    .pill.ok{
      border-color: rgba(212,175,55,0.35);
      color:#d4af37;
    }

    .pill.muted{
      border-color: rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.62);
    }

    .search-wrap{
      flex:1;
      min-width: 240px;
      max-width: 520px;
      position:relative;
    }

    .search-input{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid #222;
      background:#0f0f0f;
      color:#fff;
      outline:none;
      box-sizing:border-box;
      font-size:14px;
    }

    .search-input::placeholder{
      color:rgba(255,255,255,0.45);
    }

    .panel-actions{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }

    .cities-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:14px;
      margin-top:16px;
    }

    .city-card{
      background:#0f0f0f;
      border:1px solid #222;
      border-radius:14px;
      padding:16px;
      text-align:left;
      transition:all 0.3s ease;
      position:relative;
    }

    .city-card:hover{
      transform:translateY(-3px);
      border-color:rgba(212,175,55,0.55);
    }

    .city-card h4{
      margin:0 0 10px;
      color:#fff;
      font-weight:650;
      font-size:15px;
      line-height:1.3;
    }

    .city-card small{
      display:block;
      color:rgba(255,255,255,0.6);
      margin-top:2px;
      font-size:12px;
    }

    .city-meta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
      margin-bottom:8px;
      align-items:center;
    }

    .panel-footer{
      margin-top:14px;
      display:flex;
      justify-content:center;
    }

    .empty-state{
      text-align:center;
      color:rgba(255,255,255,0.68);
      border:1px dashed rgba(255,255,255,0.12);
      border-radius:14px;
      padding:22px 16px;
      margin-top:14px;
      font-size:14px;
      line-height:1.6;
    }

    /* ========= POPUPS ========= */
    .popup-bg{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.85);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:3000;
      padding:18px;
      box-sizing:border-box;
    }

    .popup-bg.active{ display:flex; }

    .popup-content{
      background:#111;
      border:1px solid #222;
      border-radius:14px;
      max-width:720px;
      width:100%;
      padding:24px;
      box-sizing:border-box;
      position:relative;
      text-align:center;
    }

    .popup-content h3{
      margin:0 0 10px;
      color:#d4af37;
      letter-spacing:0.2px;
    }

    .popup-content p{
      margin:0 0 14px;
      color:rgba(255,255,255,0.8);
      line-height:1.6;
      font-size:14px;
    }

    .popup-actions{
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .popup-rules{
      text-align:left;
      margin-top:14px;
      background:#0f0f0f;
      border:1px solid #222;
      border-radius:12px;
      padding:16px;
      color:rgba(255,255,255,0.78);
      font-size:13.5px;
      line-height:1.6;
    }

    .popup-rules strong{ color:#d4af37; }

    .consent-wrap{
      display:flex;
      gap:10px;
      align-items:flex-start;
      margin-top:12px;
      text-align:left;
      padding:12px;
      border:1px solid #222;
      border-radius:12px;
      background:#0f0f0f;
      color:rgba(255,255,255,0.82);
      font-size:13.2px;
      line-height:1.55;
    }

    .consent-wrap input{
      margin-top:3px;
      accent-color:#d4af37;
    }

    /* ========= CARRINHO (popup) ========= */
    .cart-list{
      text-align:left;
      margin-top:14px;
      border:1px solid #222;
      border-radius:12px;
      background:#0f0f0f;
      padding:12px;
    }

    .cart-item{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:12px 10px;
      border-bottom:1px solid rgba(255,255,255,0.08);
    }

    .cart-item:last-child{ border-bottom:none; }

    .cart-item-left{
      min-width:0;
    }

    .cart-item-title{
      color:#fff;
      font-weight:650;
      margin:0 0 4px;
      font-size:14px;
      line-height:1.35;
    }

    .cart-item-meta{
      color:rgba(255,255,255,0.70);
      font-size:12.5px;
      line-height:1.4;
    }

    .cart-item-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:10px;
      white-space:nowrap;
    }

    .cart-total{
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      padding:12px;
      border:1px solid rgba(255,255,255,0.10);
      border-radius:12px;
      background:#0f0f0f;
      text-align:left;
    }

    .cart-total strong{ color:#d4af37; }

    @media (max-width:980px){
      header{ padding:14px 16px; }
      section{ padding:110px 16px 70px; }

      .about-layout{
        grid-template-columns:1fr;
        padding:0 16px;
        gap:16px;
        align-items:start;
      }

      .side-panel{ height:240px; margin-top:0; }
      .side-bg.left,.side-bg.right{ background-position:center; }
      .brand{ min-width: auto; }

      .curadoria-panel{ padding:16px; }
      .panel-top{ align-items:flex-start; }
      .search-wrap{ max-width: 100%; }
    }
  </style>
</head>
<body>

<header>
  <div class="brand" onclick="showSection('inicio')">
    <img src="images/rosa-dos-ventos.png" alt="Rosa dos Ventos">
    <div>
      <div class="brand-name">Curadoria Elite Travel</div>
      <div class="brand-tagline">O seu mundo, bem indicado.</div>
    </div>
  </div>

  <nav>
    <a onclick="showSection('inicio')">Início</a>
    <a onclick="showSection('quem')">Quem Somos</a>
    <a onclick="showSection('curadoria')">Curadoria</a>
    <a onclick="showSection('buscador')">Buscador</a>

    <span class="nav-sep"></span>

    <!-- Carrinho -->
    <a id="navCart" onclick="openCart()">Carrinho (0)</a>

    <!-- alterna conforme login -->
    <a id="navAccount" onclick="goAccount()" style="display:none;">Minha conta</a>
    <a id="navLogin" onclick="goLogin()" style="display:none;">Entrar</a>
    <a id="navLogout" onclick="doLogout()" style="display:none;">Sair</a>
  </nav>
</header>

<section id="inicio" class="active">
  <div class="hero">
    <div class="hero-bg active" id="bg1"></div>
    <div class="hero-bg" id="bg2"></div>
    <div class="hero-overlay"></div>

    <div class="hero-content">
      <div>
        <h1>Uma plataforma de curadoria para viajar melhor.</h1>
        <p>Curadoria que orienta. Decisão que flui.</p>
        <p>Selecionamos e organizamos informações essenciais para decisões de viagem mais seguras e bem fundamentadas.</p>
      </div>
    </div>
  </div>
</section>

<section id="quem">
  <div class="about-layout">

    <div class="side-panel" aria-hidden="true">
      <div class="side-panel-inner">
        <div class="side-bg left active" id="sl1"></div>
        <div class="side-bg left" id="sl2"></div>
        <div class="side-overlay"></div>
        <div class="side-caption">Critério · Orientação · Decisão</div>
      </div>
    </div>

    <div class="about-center">
      <h2>Quem Somos</h2>

      <div class="text-block">
        Na Curadoria Elite Travel, acreditamos que o tempo é um dos bens mais valiosos de quem viaja.<br><br>
        Em um cenário onde a praticidade digital é essencial, percebemos que o viajante moderno buscava autonomia sem abrir mão de inspiração, critério e confiança - uma forma clara e organizada de decidir melhor, que ainda não existia.<br><br>
        Foi dessa necessidade que nascemos. A Curadoria Elite Travel é uma plataforma criada para organizar informações e oferecer indicações criteriosas, transformando destinos em universos referenciados e acessíveis digitalmente.<br><br>
        Nossa curadoria é composta por indicações, referências e orientações práticas, pensadas para apoiar decisões de viagem antes e durante a experiência.<br><br>
        Não somos uma agência de viagens e não realizamos reservas. Nosso papel é selecionar, estruturar e apresentar conhecimento de qualidade para quem prefere decidir com segurança e clareza.<br><br>
        <strong>O seu mundo, bem indicado.</strong>
      </div>

      <div class="rules-block">
        <strong>Informações Importantes</strong><br><br>

        A Curadoria Elite Travel oferece exclusivamente materiais digitais de caráter informativo e orientativo, baseados em indicações, referências e conteúdos selecionados.<br><br>

        Não realizamos reservas, vendas de passagens, hospedagens, experiências ou qualquer tipo de intermediação direta com fornecedores ou prestadores de serviço.<br><br>

        As decisões de compra, contratação e utilização de serviços indicados nos materiais são de <span class="hl">responsabilidade exclusiva do usuário</span>, assim como qualquer tratativa, solicitação, alteração ou eventual problema relacionado aos serviços contratados.<br><br>

        Por se tratar de conteúdo digital disponibilizado de forma imediata após a confirmação da compra, <span class="hl">não é possível realizar cancelamentos, trocas ou reembolsos</span>.<br><br>

        Ao adquirir nossos materiais, o usuário declara estar ciente e de acordo com essas condições.
      </div>
    </div>

    <div class="side-panel" aria-hidden="true">
      <div class="side-panel-inner">
        <div class="side-bg right active" id="sr1"></div>
        <div class="side-bg right" id="sr2"></div>
        <div class="side-overlay"></div>
      </div>
    </div>

  </div>
</section>

<section id="curadoria">
  <h2>Curadoria</h2>
  <p class="subtitle">
    Materiais digitais desenvolvidos para apoiar decisões de viagem com critério, clareza e indicações bem organizadas.
  </p>

  <div class="card" style="text-align:center; max-width:900px; margin:0 auto;">
    <h3 style="margin-top:0;">Overview</h3>
    <p>Conheça o formato, a profundidade e o padrão dos materiais que entregamos.</p>
    <button onclick="openOverview()">Abrir overview</button>
  </div>

  <!-- Grid de categorias (mantido como está) -->
  <div id="curadoria-categories" class="grid" style="margin-top:26px;">
    <div class="card" onclick="openCategory('City Guide')">
      <img src="https://images.unsplash.com/photo-1505761671935-60b3a7427bad?auto=format&fit=crop&w=1200&q=80">
      <h3>City Guide</h3>
      <p>Indicações essenciais por destino, com foco em clareza e praticidade.</p>
    </div>

    <div class="card" onclick="openCategory('Gastronomia')">
      <img src="https://images.unsplash.com/photo-1528605248644-14dd04022da1?auto=format&fit=crop&w=1200&q=80">
      <h3>Gastronomia</h3>
      <p>Seleções gastronômicas para decisões mais seguras e bem orientadas.</p>
    </div>

    <div class="card" onclick="openCategory('Atrações Turísticas')">
      <img src="https://images.unsplash.com/photo-1526778548025-fa2f459cd5c1?auto=format&fit=crop&w=1200&q=80">
      <h3>Atrações Turísticas</h3>
      <p>O que vale seu tempo - com contexto e organização por destino.</p>
    </div>

    <div class="card" onclick="openCategory('Vida Noturna')">
      <img src="https://images.unsplash.com/photo-1506157786151-b8491531f063?auto=format&fit=crop&w=1200&q=80">
      <h3>Vida Noturna</h3>
      <p>Locais e experiências noturnas com curadoria e referências.</p>
    </div>

    <div class="card" onclick="openCategory('Endereços para Compras')">
      <img src="https://images.unsplash.com/photo-1483985988355-763728e1935b?auto=format&fit=crop&w=1200&q=80">
      <h3>Endereços para Compras</h3>
      <p>Lojas, regiões e referências para comprar bem e com intenção.</p>
    </div>

    <div class="card" onclick="openCategory('Sugestão de Presentes')">
      <img src="https://images.unsplash.com/photo-1512909006721-3d6018887383?auto=format&fit=crop&w=1200&q=80">
      <h3>Sugestão de Presentes</h3>
      <p>Ideias e recomendações para presentes com bom senso e estilo.</p>
    </div>
  </div>

  <!-- Painel interno -->
  <div id="curadoria-panel" class="curadoria-panel">
    <div class="panel-top">
      <div>
        <div class="breadcrumb" id="breadcrumb">Curadoria</div>
        <h3 class="panel-title" id="panel-title">Categoria</h3>
        <div class="panel-meta">
          <span class="pill" id="cities-count">0 cidades</span>
          <span class="pill" id="visible-count">Mostrando 0</span>
          <span class="pill muted" id="admin-status">Admin: carregando...</span>
        </div>
      </div>

      <div class="panel-actions">
        <div class="search-wrap">
          <input
            id="city-search"
            class="search-input"
            type="text"
            placeholder="Buscar cidade..."
            oninput="onSearchCity()"
          />
        </div>
        <button class="btn-ghost" onclick="closeCategory()">← Voltar</button>
      </div>
    </div>

    <div id="cities-grid" class="cities-grid"></div>

    <div id="empty-state" class="empty-state" style="display:none;">
      Nenhum material disponível no momento.
    </div>

    <div class="panel-footer">
      <button id="btn-more" class="btn-ghost" style="display:none;" onclick="loadMoreCities()">
        Ver mais cidades
      </button>
    </div>
  </div>
</section>

<section id="buscador">
  <h2 style="text-align:center;color:#d4af37;margin:40px 0 14px;">Buscador</h2>
  <p class="subtitle">Em breve: área integrada com buscadores e indicações.</p>
</section>

<footer>
  Curadoria Elite Travel · O seu mundo, bem indicado.<br>
  São Paulo - SP · curadoriaelitetravel@gmail.com
</footer>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  function showSection(id){
    document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
    const el = document.getElementById(id);
    if (el) el.classList.add("active");
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function openOverview(){
    window.location.href = "https://lnyoqoezezisakghtmim.supabase.co/storage/v1/object/public/materiais/overview/general-overview.pdf";
  }

  /* =========================
     POPUP (checkbox agora é opcional via requireConsent)
  ========================= */
  function ensurePopupExists(){
    if (document.getElementById("popup")) return;

    const popupHTML = `
      <div class="popup-bg" id="popup">
        <div class="popup-content" id="popup-content">
          <h3 id="popup-title"></h3>
          <p id="popup-text"></p>

          <div class="popup-rules" id="popup-rules" style="display:none;">
            <strong>Informações Importantes</strong><br><br>
            A Curadoria Elite Travel oferece exclusivamente materiais digitais de caráter informativo e orientativo, baseados em indicações, referências e conteúdos selecionados.<br><br>
            Não realizamos reservas, vendas de passagens, hospedagens, experiências ou qualquer tipo de intermediação direta com fornecedores ou prestadores de serviço.<br><br>
            As decisões de compra, contratação e utilização de serviços indicados nos materiais são de <strong>responsabilidade exclusiva do usuário</strong>, assim como qualquer tratativa, solicitação, alteração ou eventual problema relacionado aos serviços contratados.<br><br>
            Por se tratar de conteúdo digital disponibilizado de forma imediata após a confirmação da compra, <strong>não é possível realizar cancelamentos, trocas ou reembolsos</strong>.<br><br>
            Ao adquirir nossos materiais, o usuário declara estar ciente e de acordo com essas condições.
          </div>

          <div class="popup-actions">
            <button id="popup-secondary" class="btn-ghost" style="display:none;">Minha conta</button>
            <button id="popup-tertiary" class="btn-ghost" style="display:none;">Sair</button>
            <button id="popup-prosseguir" style="display:none;">Prosseguir</button>
            <button class="btn-ghost" id="popup-fechar">Fechar</button>
          </div>
        </div>
      </div>
    `;

    const wrap = document.createElement("div");
    wrap.innerHTML = popupHTML;
    document.body.appendChild(wrap);

    document.getElementById("popup-fechar").addEventListener("click", closePopup);
  }

  function openPopup({
    title="",
    text="",
    showProsseguir=false,
    showRules=false,
    requireConsent=false,     // ✅ agora controla o checkbox
    onProsseguir=null,
    secondaryText=null,
    onSecondary=null,
    tertiaryText=null,
    onTertiary=null
  }){
    ensurePopupExists();

    document.getElementById("popup-title").innerText = title;
    document.getElementById("popup-text").innerText = text;

    const rules = document.getElementById("popup-rules");
    rules.style.display = showRules ? "block" : "none";

    const btn = document.getElementById("popup-prosseguir");
    btn.style.display = showProsseguir ? "inline-block" : "none";
    btn.disabled = false;
    btn.innerText = "Prosseguir";

    const btn2 = document.getElementById("popup-secondary");
    if (secondaryText && typeof onSecondary === "function"){
      btn2.style.display = "inline-block";
      btn2.innerText = secondaryText;
      btn2.onclick = () => {
        try{ closePopup(); }catch(e){}
        onSecondary();
      };
    }else{
      btn2.style.display = "none";
      btn2.onclick = null;
    }

    const btn3 = document.getElementById("popup-tertiary");
    if (tertiaryText && typeof onTertiary === "function"){
      btn3.style.display = "inline-block";
      btn3.innerText = tertiaryText;
      btn3.onclick = () => {
        try{ closePopup(); }catch(e){}
        onTertiary();
      };
    }else{
      btn3.style.display = "none";
      btn3.onclick = null;
    }

    const old = document.getElementById("consent-checkbox-wrap");
    if (old) old.remove();

    if (showProsseguir && requireConsent){
      const actions = document.querySelector("#popup-content .popup-actions");

      const consentWrap = document.createElement("div");
      consentWrap.id = "consent-checkbox-wrap";
      consentWrap.className = "consent-wrap";
      consentWrap.innerHTML = `
        <input type="checkbox" id="consent-checkbox" />
        <label for="consent-checkbox">(Li e concordo que, por ser um produto digital de acesso imediato, não será possível realizar cancelamentos, trocas ou reembolsos após a confirmação da compra.)</label>
      `;

      actions.parentNode.insertBefore(consentWrap, actions);

      btn.disabled = true;

      const cb = document.getElementById("consent-checkbox");
      cb.addEventListener("change", () => {
        btn.disabled = !cb.checked;
      });
    }

    btn.onclick = null;
    if (showProsseguir && typeof onProsseguir === "function"){
      btn.onclick = async () => {
        try{
          btn.disabled = true;
          btn.innerText = "Aguarde...";
          closePopup();
          await onProsseguir();
        }catch(e){
          openPopup({
            title: "Pagamento",
            text: "Não foi possível prosseguir. Tente novamente.",
            showProsseguir: false,
            showRules: false
          });
        }
      };
    }

    document.getElementById("popup").classList.add("active");
  }

  function closePopup(){
    const p = document.getElementById("popup");
    if (p) p.classList.remove("active");

    const old = document.getElementById("consent-checkbox-wrap");
    if (old) old.remove();

    const btn = document.getElementById("popup-prosseguir");
    if (btn){
      btn.disabled = false;
      btn.innerText = "Prosseguir";
    }

    const btn2 = document.getElementById("popup-secondary");
    if (btn2){
      btn2.style.display = "none";
      btn2.onclick = null;
    }

    const btn3 = document.getElementById("popup-tertiary");
    if (btn3){
      btn3.style.display = "none";
      btn3.onclick = null;
    }
  }

  /* =========================
     CARRINHO (popup)
  ========================= */
  const CART_STORAGE_KEY = "cet_cart_v1";
  const CHECKOUT_CONTEXT_KEY = "cet_checkout_context_v1";
  const CART_CHECKOUT_ITEMS_KEY = "cet_cart_checkout_items_v1";

  function ensureCartPopupExists(){
    if (document.getElementById("cartPopup")) return;

    const cartHTML = `
      <div class="popup-bg" id="cartPopup">
        <div class="popup-content" id="cartPopupContent">
          <h3>Carrinho</h3>
          <p id="cartSubtitle">Revise seus materiais antes de prosseguir.</p>

          <div class="cart-list" id="cartList"></div>

          <div class="cart-total" id="cartTotalWrap" style="display:none;">
            <div><strong>Total</strong></div>
            <div id="cartTotalValue"><strong>R$ 0,00</strong></div>
          </div>

          <div class="popup-actions">
            <button class="btn-ghost" id="cartContinueBtn">Continuar comprando</button>
            <button id="cartProceedBtn">Prosseguir</button>
            <button class="btn-ghost" id="cartCloseBtn">Fechar</button>
          </div>
        </div>
      </div>
    `;

    const wrap = document.createElement("div");
    wrap.innerHTML = cartHTML;
    document.body.appendChild(wrap);

    document.getElementById("cartCloseBtn").addEventListener("click", closeCart);
    document.getElementById("cartContinueBtn").addEventListener("click", closeCart);
    document.getElementById("cartProceedBtn").addEventListener("click", async () => {
      await startCartCheckoutFlow();
    });
  }

  function getCart(){
    try{
      const raw = localStorage.getItem(CART_STORAGE_KEY);
      const parsed = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(parsed)) return [];
      return parsed;
    }catch(e){
      return [];
    }
  }

  function saveCart(items){
    try{
      localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(items || []));
    }catch(e){}
    updateCartBadge();
  }

  function removeFromCart(key){
    const items = getCart().filter(it => it && it.key !== key);
    saveCart(items);
    renderCart();
  }

  function calcCartTotal(items){
    let total = 0;
    (items || []).forEach(it => {
      const q = Number(it.qty || 0);
      const p = Number(it.price || 0);
      total += (q * p);
    });
    return total;
  }

  function renderCart(){
    ensureCartPopupExists();

    const listEl = document.getElementById("cartList");
    const totalWrap = document.getElementById("cartTotalWrap");
    const totalVal = document.getElementById("cartTotalValue");

    const items = getCart();

    if (!items.length){
      listEl.innerHTML = `
        <div style="padding:14px;color:rgba(255,255,255,0.70);line-height:1.6;">
          Seu carrinho está vazio.
        </div>
      `;
      if (totalWrap) totalWrap.style.display = "none";
      return;
    }

    listEl.innerHTML = "";

    items.forEach(it => {
      const div = document.createElement("div");
      div.className = "cart-item";

      const price = formatBRL(Number(it.price || 0));
      const qty = Number(it.qty || 1) || 1;

      div.innerHTML = `
        <div class="cart-item-left">
          <div class="cart-item-title">${it.city}</div>
          <div class="cart-item-meta">
            Quantidade: ${qty} · ${it.category}
          </div>
          <div class="cart-item-meta">
            ${price}
          </div>
        </div>
        <div class="cart-item-right">
          <button class="btn-ghost" data-remove="${it.key}" style="margin-top:0;">Remover</button>
        </div>
      `;

      const btnRemove = div.querySelector("[data-remove]");
      btnRemove.addEventListener("click", () => removeFromCart(it.key));

      listEl.appendChild(div);
    });

    const total = calcCartTotal(items);
    if (totalWrap) totalWrap.style.display = "flex";
    if (totalVal) totalVal.innerHTML = `<strong>${formatBRL(total)}</strong>`;
  }

  function openCart(){
    ensureCartPopupExists();
    renderCart();
    document.getElementById("cartPopup").classList.add("active");
  }

  function closeCart(){
    const p = document.getElementById("cartPopup");
    if (p) p.classList.remove("active");
  }

  function updateCartBadge(){
    const el = document.getElementById("navCart");
    if (!el) return;
    const items = getCart();
    const count = (items || []).length;
    el.innerText = "Carrinho (" + count + ")";
  }

  /* =========================
     SUPABASE
  ========================= */
  const SUPABASE_URL = "https://lnyoqoezezisakghtmim.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxueW9xb2V6ZXppc2FrZ2h0bWltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNjI4OTMsImV4cCI6MjA3OTczODg5M30.Nn9ZPRXeJlvCGJ2kXQ3XBvT743pQn2VIXEsT9pexqnA";

  let supabaseClient = null;

  function ensureSupabase(){
    if (supabaseClient) return supabaseClient;
    if (!window.supabase) return null;
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    return supabaseClient;
  }

  async function getSession(){
    const sb = ensureSupabase();
    if (!sb) return null;
    const { data } = await sb.auth.getSession();
    return (data && data.session) ? data.session : null;
  }

  /* =========================
     Cabeçalho (auth)
  ========================= */
  async function refreshNavAuth(){
    const s = await getSession();
    const navLogin = document.getElementById("navLogin");
    const navLogout = document.getElementById("navLogout");
    const navAccount = document.getElementById("navAccount");

    if (!navLogin || !navLogout || !navAccount) return;

    if (s && s.user){
      navLogin.style.display = "none";
      navAccount.style.display = "inline";
      navLogout.style.display = "inline";
    }else{
      navLogin.style.display = "inline";
      navAccount.style.display = "none";
      navLogout.style.display = "none";
    }
  }

  function goLogin(){
    window.location.href = "login.html?return_to=index.html";
  }

  function goLoginWithReturn(returnTo){
    window.location.href = "login.html?return_to=" + encodeURIComponent(returnTo);
  }

  function goAccount(){
    window.location.href = "account.html";
  }

  async function doLogout(){
    try{
      const sb = ensureSupabase();
      if (sb) await sb.auth.signOut();
    }catch(e){}
    try{ await refreshNavAuth(); }catch(e){}
    openPopup({
      title: "Acesso à conta",
      text: "Você saiu da sua conta.",
      showProsseguir: false,
      showRules: false
    });
  }

  /* =========================
     NORMALIZAÇÃO + PREÇO
  ========================= */
  function normalizeKeyPart(str){
    const s = String(str || "")
      .trim()
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/[—–−]/g, "-")
      .replace(/\s*-\s*/g, " - ")
      .replace(/\s+/g, " ")
      .trim();
    return s;
  }

  function purchaseKey(category, cityLabel){
    return normalizeKeyPart(category) + "||" + normalizeKeyPart(cityLabel);
  }

  function formatBRL(v){
    try{
      return new Intl.NumberFormat("pt-BR", { style:"currency", currency:"BRL" }).format(v);
    }catch(e){
      return "R$ " + String(v);
    }
  }

  function getPriceForCategory(category){
    const c = String(category || "").trim().toLowerCase();
    if (c === "city guide") return 88.92;
    return 57.83;
  }

  /* =========================
     CONTEXTO (para voltar do login)
  ========================= */
  function setCheckoutContext(obj){
    try{ localStorage.setItem(CHECKOUT_CONTEXT_KEY, JSON.stringify(obj || {})); }catch(e){}
  }
  function getCheckoutContext(){
    try{
      const raw = localStorage.getItem(CHECKOUT_CONTEXT_KEY);
      return raw ? JSON.parse(raw) : null;
    }catch(e){ return null; }
  }
  function clearCheckoutContext(){
    try{ localStorage.removeItem(CHECKOUT_CONTEXT_KEY); }catch(e){}
  }

  /* =========================
     Nota Fiscal
  ========================= */
  function goInvoiceSingle(category, city){
    const url =
      "checkout-success.html?step=invoice&category=" +
      encodeURIComponent(category) +
      "&city=" +
      encodeURIComponent(city);

    window.location.href = url;
  }

  function goInvoiceCart(items){
    try{
      const payload = (items || []).map(it => ({
        category: it.category,
        city: it.city,
        qty: Number(it.qty || 1) || 1
      }));
      localStorage.setItem(CART_CHECKOUT_ITEMS_KEY, JSON.stringify(payload));
    }catch(e){}
    window.location.href = "checkout-success.html?step=invoice&cart=1";
  }

  /* =========================
     Política (checkbox obrigatório)
  ========================= */
  async function showPolicyThenProceed(nextFn){
    openPopup({
      title: "Informações Importantes",
      text: "Antes de prosseguir, confirme as condições abaixo.",
      showProsseguir: true,
      showRules: true,
      requireConsent: true,  // ✅ checkbox só aqui
      onProsseguir: async () => {
        await nextFn();
      }
    });
  }

  /* =========================
     Carrinho -> Login -> Política -> Nota Fiscal
  ========================= */
  async function startCartCheckoutFlow(){
    const items = getCart();
    if (!items.length){
      openPopup({
        title: "Carrinho",
        text: "Seu carrinho está vazio.",
        showProsseguir: false,
        showRules: false
      });
      return;
    }

    const sess = await getSession();
    if (!sess || !sess.user){
      setCheckoutContext({ type: "cart" });
      closeCart();
      goLoginWithReturn("index.html?after_login=1");
      return;
    }

    closeCart();
    await showPolicyThenProceed(async () => {
      goInvoiceCart(items);
    });
  }

  /* =========================
     Item único -> Login -> Política -> Nota Fiscal
  ========================= */
  async function startSingleCheckoutFlow(category, city){
    const sess = await getSession();
    if (!sess || !sess.user){
      setCheckoutContext({ type: "single", category, city });
      goLoginWithReturn("index.html?after_login=1");
      return;
    }

    await showPolicyThenProceed(async () => {
      goInvoiceSingle(category, city);
    });
  }

  /* =========================
     DADOS SUPABASE
  ========================= */
  const materiaisAtivosPorCategoria = new Map();
  const ownedMap = new Map();

  function setAdminStatus(text, ok){
    const el = document.getElementById("admin-status");
    if (!el) return;
    el.innerText = text;
    el.classList.remove("ok","muted");
    el.classList.add(ok ? "ok" : "muted");
  }

  async function loadActiveMaterials(){
    materiaisAtivosPorCategoria.clear();

    try{
      ensureSupabase();

      const { data, error } = await supabaseClient
        .from("curadoria_materials")
        .select("category, city_label, pdf_url")
        .eq("is_active", true)
        .order("city_label", { ascending: true });

      if (error){
        setAdminStatus("Admin: erro ao carregar", false);
        return;
      }

      (data || []).forEach(row => {
        const cat = String(row.category || "").trim();
        const city = String(row.city_label || "").trim();
        const url = row.pdf_url || null;

        if (!cat || !city || !url) return;

        if (!materiaisAtivosPorCategoria.has(cat)) materiaisAtivosPorCategoria.set(cat, []);
        materiaisAtivosPorCategoria.get(cat).push({ cidade: city, pdf_url: url });
      });

      setAdminStatus("Admin: conectado", true);
    }catch(e){
      setAdminStatus("Admin: falha na conexão", false);
    }
  }

  async function loadOwnedPurchases(){
    ownedMap.clear();

    try{
      const sess = await getSession();
      if (!sess || !sess.user) return;

      ensureSupabase();

      const { data, error } = await supabaseClient
        .from("purchase")
        .select("category, city, pdf_url")
        .eq("user_id", sess.user.id)
        .limit(500);

      if (error) return;

      (data || []).forEach(row => {
        const k = purchaseKey(row.category || "", row.city || "");
        ownedMap.set(k, { pdf_url: row.pdf_url || null });
      });
    }catch(e){}
  }

  function userOwns(category, cityLabel){
    return ownedMap.has(purchaseKey(category, cityLabel));
  }

  /* =========================
     CURADORIA PANEL
  ========================= */
  const BATCH_SIZE = 12;
  let currentCategory = null;
  let filteredCities = [];
  let visibleCount = 0;

  function normalizeText(str){
    return normalizeKeyPart(str || "");
  }

  function openCategory(category){
    currentCategory = category;

    const panel = document.getElementById("curadoria-panel");
    if (!panel) return;
    panel.style.display = "block";

    const bc = document.getElementById("breadcrumb");
    const pt = document.getElementById("panel-title");
    if (bc) bc.innerText = "Curadoria > " + category;
    if (pt) pt.innerText = category;

    const input = document.getElementById("city-search");
    if (input) input.value = "";

    const list = materiaisAtivosPorCategoria.get(category) || [];
    filteredCities = list.slice();
    visibleCount = Math.min(BATCH_SIZE, filteredCities.length);

    renderCities();

    setTimeout(() => {
      panel.scrollIntoView({ behavior: "smooth", block: "start" });
      if (input) input.focus({ preventScroll: true });
    }, 120);
  }

  function closeCategory(){
    const panel = document.getElementById("curadoria-panel");
    if (panel) panel.style.display = "none";
    currentCategory = null;
    filteredCities = [];
    visibleCount = 0;

    const cats = document.getElementById("curadoria-categories");
    if (cats) cats.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  function onSearchCity(){
    if (!currentCategory) return;

    const input = document.getElementById("city-search");
    const q = normalizeText(input ? input.value : "");
    const all = (materiaisAtivosPorCategoria.get(currentCategory) || []);

    if (!q) filteredCities = all.slice();
    else filteredCities = all.filter(item => normalizeText(item.cidade).includes(q));

    visibleCount = Math.min(BATCH_SIZE, filteredCities.length);
    renderCities();
  }

  function loadMoreCities(){
    visibleCount = Math.min(visibleCount + BATCH_SIZE, filteredCities.length);
    renderCities(true);
  }

  function renderCities(){
    const grid = document.getElementById("cities-grid");
    const empty = document.getElementById("empty-state");
    const btnMore = document.getElementById("btn-more");
    const citiesCount = document.getElementById("cities-count");
    const visible = document.getElementById("visible-count");

    if (!grid) return;

    const total = filteredCities.length;

    if (citiesCount) citiesCount.innerText = total + (total === 1 ? " cidade" : " cidades");
    if (visible) visible.innerText = "Mostrando " + Math.min(visibleCount, total);

    if (total === 0){
      grid.innerHTML = "";
      if (empty) empty.style.display = "block";
      if (btnMore) btnMore.style.display = "none";
      return;
    }

    if (empty) empty.style.display = "none";

    const slice = filteredCities.slice(0, visibleCount);
    grid.innerHTML = "";

    slice.forEach((item) => {
      const div = document.createElement("div");
      div.className = "city-card";

      const cityLabel = item.cidade || "";
      const price = formatBRL(getPriceForCategory(currentCategory));

      const badge = `<span class="pill ok">Disponível</span>`;
      const pricePill = `<span class="pill muted">${price}</span>`;

      div.innerHTML = `
        <h4>${cityLabel}<small>Material digital com indicações selecionadas</small></h4>
        <div class="city-meta">${badge} ${pricePill}</div>
        <button>Acessar</button>
      `;

      const btn = div.querySelector("button");
      btn.addEventListener("click", () => openCityModal(currentCategory, cityLabel));

      grid.appendChild(div);
    });

    if (btnMore){
      btnMore.style.display = visibleCount < total ? "inline-flex" : "none";
    }
  }

  /* =========================
     Modal da cidade
  ========================= */
  function cartItemKey(category, cityLabel){
    return purchaseKey(category, cityLabel);
  }

  function addToCart(category, cityLabel){
    const items = getCart();
    const k = cartItemKey(category, cityLabel);

    const exists = items.some(it => it && it.key === k);
    if (exists){
      openPopup({
        title: "Carrinho",
        text: "Este material já está no carrinho.",
        showProsseguir: false,
        showRules: false
      });
      return;
    }

    const price = getPriceForCategory(category);

    items.push({
      key: k,
      category: String(category || "").trim(),
      city: String(cityLabel || "").trim(),
      qty: 1,
      price: Number(price || 0)
    });

    saveCart(items);

    openPopup({
      title: "Carrinho",
      text: "Material adicionado ao carrinho.",
      showProsseguir: false,
      showRules: false
    });
  }

  function openCityModal(category, city){
    const msg =
      `${category} é um material digital com indicações e referências selecionadas para apoiar suas decisões de viagem. ` +
      `Este conteúdo é liberado após a confirmação da compra.`;

    const owns = userOwns(category, city);

    if (owns){
      openPopup({
        title: city,
        text: "Você já possui este produto. Deseja comprar novamente?",
        showProsseguir: true,
        showRules: false,
        requireConsent: false,
        secondaryText: "Minha conta",
        onSecondary: () => goAccount(),
        tertiaryText: "Sair",
        onTertiary: () => doLogout(),
        onProsseguir: async () => {
          await startSingleCheckoutFlow(category, city);
        }
      });
      return;
    }

    openPopup({
      title: city,
      text: msg,
      showProsseguir: true,
      showRules: false,
      requireConsent: false,
      secondaryText: "Adicionar ao carrinho",
      onSecondary: () => {
        addToCart(category, city);
        try{ openCart(); }catch(e){}
      },
      onProsseguir: async () => {
        await startSingleCheckoutFlow(category, city);
      }
    });
  }

  /* =========================
     Retomar após login
  ========================= */
  async function handleAfterLoginResume(){
    const url = new URL(window.location.href);
    const after = url.searchParams.get("after_login");
    if (!after) return;

    const ctx = getCheckoutContext();
    clearCheckoutContext();

    url.searchParams.delete("after_login");
    window.history.replaceState({}, document.title, url.toString());

    if (!ctx || !ctx.type) return;

    try{ await loadOwnedPurchases(); }catch(e){}
    try{ await refreshNavAuth(); }catch(e){}

    if (ctx.type === "cart"){
      await startCartCheckoutFlow();
      return;
    }

    if (ctx.type === "single" && ctx.category && ctx.city){
      await startSingleCheckoutFlow(ctx.category, ctx.city);
      return;
    }
  }

  /* =========================
     INIT
  ========================= */
  document.addEventListener("DOMContentLoaded", async () => {
    ensureSupabase();

    updateCartBadge();
    await refreshNavAuth();

    await loadActiveMaterials();
    await loadOwnedPurchases();

    await handleAfterLoginResume();
  });
</script>

</body>
</html>
