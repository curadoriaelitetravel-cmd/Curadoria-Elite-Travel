<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Curadoria Elite Travel - Pagamento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body{
      margin:0;
      font-family:"Segoe UI",sans-serif;
      background:#0b0b0b;
      color:#fff;
      overflow-x:hidden;
    }

    header{
      padding:16px 40px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:fixed;
      width:100%;
      top:0;
      z-index:1000;
      background:rgba(0,0,0,0.25);
      backdrop-filter:blur(8px);
      border-bottom:1px solid rgba(255,255,255,0.06);
      box-sizing:border-box;
      gap:16px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 240px;
      cursor:pointer;
    }

    .brand img{
      height:34px;
      width:34px;
    }

    .brand-name{
      font-family:"Cinzel","Georgia",serif;
      font-size:18px;
      color:#d4af37;
      letter-spacing:0.8px;
      text-transform:uppercase;
      line-height:1.1;
    }

    .brand-tagline{
      font-size:12px;
      color:rgba(255,255,255,0.7);
      line-height:1.2;
      margin-top:2px;
    }

    nav{
      display:flex;
      align-items:center;
      gap:16px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    nav a{
      color:#d4af37;
      text-decoration:none;
      font-weight:500;
      cursor:pointer;
      white-space: nowrap;
    }

    .nav-sep{
      width:1px;
      height:16px;
      background:rgba(255,255,255,0.12);
      display:inline-block;
      margin:0 2px;
    }

    main{
      padding:120px 16px 60px;
      max-width:980px;
      margin:0 auto;
      box-sizing:border-box;
    }

    .card{
      background:linear-gradient(145deg,#111,#000);
      border:1px solid #222;
      border-radius:16px;
      padding:26px;
      box-sizing:border-box;
    }

    h1{
      margin:0 0 8px;
      color:#d4af37;
      font-size:22px;
      letter-spacing:0.2px;
      text-align:center;
    }

    .subtitle{
      margin:0 auto 16px;
      max-width:760px;
      color:rgba(255,255,255,0.78);
      text-align:center;
      line-height:1.6;
      font-size:14px;
    }

    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
      margin-top:18px;
    }

    @media (max-width:860px){
      .grid{ grid-template-columns:1fr; }
      header{ padding:14px 16px; }
    }

    label{
      display:block;
      color:rgba(255,255,255,0.80);
      font-size:13px;
      margin:0 0 6px;
    }

    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid #222;
      background:#0f0f0f;
      color:#fff;
      outline:none;
      box-sizing:border-box;
      font-size:14px;
    }

    input::placeholder{
      color:rgba(255,255,255,0.45);
    }

    .hint{
      margin-top:8px;
      color:rgba(255,255,255,0.65);
      font-size:13px;
      line-height:1.55;
      text-align:center;
      min-height:20px;
    }

    .actions{
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:18px;
    }

    button{
      cursor:pointer;
      padding:11px 16px;
      border-radius:10px;
      border:none;
      background:#d4af37;
      color:#000;
      font-weight:800;
      min-width:160px;
    }

    button[disabled]{
      opacity:0.6;
      cursor:not-allowed;
    }

    .btn-ghost{
      background:transparent;
      border:1px solid rgba(212,175,55,0.35);
      color:#d4af37;
      font-weight:650;
    }

    .notice{
      margin-top:18px;
      padding:14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background:#0f0f0f;
      color:rgba(255,255,255,0.78);
      font-size:13.5px;
      line-height:1.6;
    }

    .notice strong{ color:#d4af37; }

    /* IE indicator */
    .ie-block{
      grid-column:1 / -1;
      border:1px solid #222;
      border-radius:14px;
      padding:14px;
      background:#0f0f0f;
    }

    .ie-title{
      color:#d4af37;
      font-weight:700;
      font-size:13px;
      margin:0 0 10px;
      letter-spacing:0.2px;
    }

    .ie-options{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .ie-opt{
      display:inline-flex;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(212,175,55,0.25);
      background:rgba(0,0,0,0.20);
      cursor:pointer;
      user-select:none;
      color:rgba(255,255,255,0.86);
      font-size:13px;
    }

    .ie-opt input{
      width:auto;
      margin:0;
      accent-color:#d4af37;
    }

    .hidden{ display:none !important; }
  </style>
</head>
<body>

<header>
  <div class="brand" onclick="window.location.href='index.html'">
    <img src="images/rosa-dos-ventos.png" alt="Rosa dos Ventos">
    <div>
      <div class="brand-name">Curadoria Elite Travel</div>
      <div class="brand-tagline">O seu mundo, bem indicado.</div>
    </div>
  </div>

  <nav>
    <a onclick="window.location.href='index.html'">Início</a>
    <span class="nav-sep"></span>
    <a id="navAccount" onclick="window.location.href='account.html'" style="display:none;">Minha conta</a>
    <a id="navLogin" onclick="window.location.href='login.html?return_to=checkout-success.html'" style="display:none;">Entrar</a>
    <a id="navLogout" onclick="doLogout()" style="display:none;">Sair</a>
  </nav>
</header>

<main>
  <div class="card" id="screenInvoice" style="display:none;">
    <h1>Nota Fiscal</h1>
    <p class="subtitle">
      Antes de prosseguir para o pagamento, confirme seus dados. Se já estiverem preenchidos, basta revisar e continuar.
    </p>

    <div class="notice">
      <strong>Importante:</strong> Produto digital de acesso imediato. Não é possível realizar cancelamentos, trocas ou reembolsos após a confirmação da compra.
    </div>

    <form id="invoiceForm" autocomplete="on">
      <div class="grid">
        <div>
          <label for="personType">Tipo</label>
          <select id="personType">
            <option value="cpf">Pessoa Física (CPF)</option>
            <option value="cnpj">Pessoa Jurídica (CNPJ)</option>
          </select>
        </div>

        <div>
          <label for="docNumber" id="docLabel">CPF</label>
          <input id="docNumber" placeholder="Digite o CPF" />
        </div>

        <div>
          <label for="fullName" id="nameLabel">Nome completo</label>
          <input id="fullName" placeholder="Digite seu nome" />
        </div>

        <div>
          <label for="email">E-mail</label>
          <input id="email" placeholder="Seu e-mail" />
        </div>

        <!-- CPF ONLY -->
        <div id="cpfBirthWrap">
          <label for="birthDate">Data de nascimento</label>
          <input id="birthDate" type="date" />
        </div>

        <div id="cpfGenderWrap">
          <label for="gender">Gênero</label>
          <select id="gender">
            <option value="">Selecione</option>
            <option value="Mulher">Mulher</option>
            <option value="Homem">Homem</option>
            <option value="Outro">Outro</option>
          </select>
        </div>

        <div>
          <label for="phone">Telefone</label>
          <input id="phone" placeholder="(00) 00000-0000" />
        </div>

        <div>
          <label for="zip">CEP</label>
          <input id="zip" placeholder="00000-000" />
        </div>

        <div>
          <label for="address">Endereço</label>
          <input id="address" placeholder="Rua / Avenida" />
        </div>

        <div>
          <label for="number">Número</label>
          <input id="number" placeholder="Número" />
        </div>

        <div>
          <label for="district">Bairro</label>
          <input id="district" placeholder="Bairro" />
        </div>

        <div>
          <label for="city">Cidade</label>
          <input id="city" placeholder="Cidade" />
        </div>

        <div>
          <label for="state">Estado</label>
          <input id="state" placeholder="UF" />
        </div>

        <div>
          <label for="complement">Complemento (opcional)</label>
          <input id="complement" placeholder="Apto, bloco, etc." />
        </div>

        <!-- CNPJ ONLY: IE INDICATOR -->
        <div id="ieBlock" class="ie-block hidden">
          <div class="ie-title">Indicador de IE</div>

          <div class="ie-options">
            <label class="ie-opt">
              <input type="radio" name="ie_indicator" value="CONTRIBUINTE">
              Contribuinte
            </label>

            <label class="ie-opt">
              <input type="radio" name="ie_indicator" value="ISENTO">
              Isento
            </label>

            <label class="ie-opt">
              <input type="radio" name="ie_indicator" value="NAO_CONTRIBUINTE">
              Não Contribuinte
            </label>
          </div>

          <div id="ieNumberWrap" class="hidden" style="margin-top:12px;">
            <label for="ieNumber">IE (se Contribuinte)</label>
            <input id="ieNumber" placeholder="Digite a IE" />
          </div>
        </div>
      </div>

      <div class="actions">
        <button type="button" class="btn-ghost" onclick="window.location.href='index.html'">Voltar ao site</button>
        <button type="button" id="btnInvoiceProceed">Prosseguir</button>
      </div>

      <p class="hint" id="invoiceHint"></p>
    </form>
  </div>

  <div class="card" id="screenPaymentError" style="display:none;">
    <h1>Pagamento</h1>
    <p class="subtitle" id="paymentErrorText">Não encontramos a sessão de pagamento. Volte ao site e tente novamente.</p>
    <div class="actions">
      <button type="button" onclick="window.location.href='account.html'">Ir para minha conta</button>
      <button type="button" class="btn-ghost" onclick="window.location.href='index.html'">Voltar ao site</button>
    </div>
  </div>

  <div class="card" id="screenLoading" style="display:block;">
    <h1>Aguarde...</h1>
    <p class="subtitle">Estamos preparando seu acesso.</p>
  </div>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  /* =========================
     SUPABASE
  ========================= */
  const SUPABASE_URL = "https://lnyoqoezezisakghtmim.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxueW9xb2V6ZXppc2FrZ2h0bWltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNjI4OTMsImV4cCI6MjA3OTczODg5M30.Nn9ZPRXeJlvCGJ2kXQ3XBvT743pQn2VIXEsT9pexqnA";

  let supabaseClient = null;

  function ensureSupabase(){
    if (supabaseClient) return supabaseClient;
    if (!window.supabase) return null;
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    return supabaseClient;
  }

  async function getSession(){
    const sb = ensureSupabase();
    if (!sb) return null;
    const { data } = await sb.auth.getSession();
    return (data && data.session) ? data.session : null;
  }

  async function getAccessToken(){
    const sess = await getSession();
    return (sess && sess.access_token) ? sess.access_token : null;
  }

  async function doLogout(){
    try{
      const sb = ensureSupabase();
      if (sb) await sb.auth.signOut();
    }catch(e){}
    window.location.href = "index.html";
  }

  function qs(name){
    try{
      return new URL(window.location.href).searchParams.get(name);
    }catch(e){ return null; }
  }

  function show(elId){
    const ids = ["screenLoading","screenInvoice","screenPaymentError"];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = (id === elId) ? "block" : "none";
    });
  }

  async function refreshNav(){
    const sess = await getSession();
    const navAccount = document.getElementById("navAccount");
    const navLogin = document.getElementById("navLogin");
    const navLogout = document.getElementById("navLogout");

    if (!navAccount || !navLogin || !navLogout) return;

    if (sess && sess.user){
      navAccount.style.display = "inline";
      navLogout.style.display = "inline";
      navLogin.style.display = "none";
    }else{
      navAccount.style.display = "none";
      navLogout.style.display = "none";
      navLogin.style.display = "inline";
    }
  }

  /* =========================
     STORAGE do carrinho (mesma chave do index)
  ========================= */
  const CART_CHECKOUT_ITEMS_KEY = "cet_cart_checkout_items_v2";

  function getCartCheckoutItems(){
    try{
      const raw = localStorage.getItem(CART_CHECKOUT_ITEMS_KEY);
      const parsed = raw ? JSON.parse(raw) : [];
      return Array.isArray(parsed) ? parsed : [];
    }catch(e){
      return [];
    }
  }

  /* =========================
     APIs existentes (com token)
  ========================= */
  async function apiGET(url){
    const token = await getAccessToken();
    const r = await fetch(url, {
      method:"GET",
      headers: token ? { "Authorization": "Bearer " + token } : {}
    });
    let json = null;
    try{ json = await r.json(); }catch(e){}
    return { ok: r.ok, status: r.status, json };
  }

  async function apiPOST(url, body){
    const token = await getAccessToken();
    const headers = { "Content-Type":"application/json" };
    if (token) headers["Authorization"] = "Bearer " + token;

    const r = await fetch(url, {
      method:"POST",
      headers,
      body: JSON.stringify(body || {})
    });
    let json = null;
    try{ json = await r.json(); }catch(e){}
    return { ok: r.ok, status: r.status, json };
  }

  /* =========================
     FORM — helpers
  ========================= */
  function setHint(text){
    const el = document.getElementById("invoiceHint");
    if (el) el.innerText = text || "";
  }

  function onlyDigits(s){
    return String(s || "").replace(/\D+/g, "");
  }

  // ✅ CPF: 000.000.000-00
  function maskCPF(v){
    const d = onlyDigits(v).slice(0, 11);
    let out = d;
    if (d.length > 3) out = d.slice(0,3) + "." + d.slice(3);
    if (d.length > 6) out = out.slice(0,7) + "." + out.slice(7);
    if (d.length > 9) out = out.slice(0,11) + "-" + out.slice(11);
    return out;
  }

  // ✅ CNPJ: 00.000.000/0000-00
  function maskCNPJ(v){
    const d = onlyDigits(v).slice(0, 14);
    let out = d;
    if (d.length > 2) out = d.slice(0,2) + "." + d.slice(2);
    if (d.length > 5) out = out.slice(0,6) + "." + out.slice(6);
    if (d.length > 8) out = out.slice(0,10) + "/" + out.slice(10);
    if (d.length > 12) out = out.slice(0,15) + "-" + out.slice(15);
    return out;
  }

  // ✅ Decide CPF/CNPJ pelo tipo selecionado
  function maskDocByType(v){
    const personType = (document.getElementById("personType")?.value || "cpf").toLowerCase();
    return (personType === "cnpj") ? maskCNPJ(v) : maskCPF(v);
  }

  // ✅ IE padronizado (genérico): 12345678901234 -> 123.456.789.012.34
  function maskIE(v){
    const d = onlyDigits(v).slice(0, 14);
    const parts = [];
    for (let i = 0; i < d.length; i += 3){
      parts.push(d.slice(i, i+3));
    }
    return parts.join(".");
  }

  function maskCEP(v){
    const d = onlyDigits(v).slice(0, 8);
    if (d.length <= 5) return d;
    return d.slice(0,5) + "-" + d.slice(5);
  }

  function maskPhone(v){
    const d = onlyDigits(v).slice(0, 11);
    if (d.length <= 2) return d;
    if (d.length <= 6) return "(" + d.slice(0,2) + ") " + d.slice(2);
    if (d.length <= 10) return "(" + d.slice(0,2) + ") " + d.slice(2,6) + "-" + d.slice(6);
    return "(" + d.slice(0,2) + ") " + d.slice(2,7) + "-" + d.slice(7);
  }

  function getSelectedIeIndicator(){
    const radios = document.querySelectorAll('input[name="ie_indicator"]');
    for (const r of radios){
      if (r.checked) return r.value;
    }
    return "";
  }

  function setSelectedIeIndicator(val){
    const radios = document.querySelectorAll('input[name="ie_indicator"]');
    radios.forEach(r => {
      r.checked = (r.value === val);
    });
  }

  function showCnpjBlocks(show){
    const ieBlock = document.getElementById("ieBlock");
    if (ieBlock) ieBlock.classList.toggle("hidden", !show);
  }

  function showCpfBlocks(show){
    const bw = document.getElementById("cpfBirthWrap");
    const gw = document.getElementById("cpfGenderWrap");
    if (bw) bw.classList.toggle("hidden", !show);
    if (gw) gw.classList.toggle("hidden", !show);
  }

  function toggleIeNumber(){
    const ind = getSelectedIeIndicator();
    const wrap = document.getElementById("ieNumberWrap");
    if (!wrap) return;
    wrap.classList.toggle("hidden", ind !== "CONTRIBUINTE");
    if (ind !== "CONTRIBUINTE"){
      const ie = document.getElementById("ieNumber");
      if (ie) ie.value = "";
    }
  }

  function setDocLabels(){
    const personType = (document.getElementById("personType")?.value || "cpf").toLowerCase();
    const docLabel = document.getElementById("docLabel");
    const nameLabel = document.getElementById("nameLabel");
    const doc = document.getElementById("docNumber");
    const name = document.getElementById("fullName");

    if (!docLabel || !nameLabel || !doc || !name) return;

    if (personType === "cnpj"){
      docLabel.innerText = "CNPJ";
      nameLabel.innerText = "Razão social";
      doc.placeholder = "Digite o CNPJ";
      name.placeholder = "Digite a Razão Social";

      showCnpjBlocks(true);
      showCpfBlocks(false);
      toggleIeNumber();
    }else{
      docLabel.innerText = "CPF";
      nameLabel.innerText = "Nome completo";
      doc.placeholder = "Digite o CPF";
      name.placeholder = "Digite seu nome";

      showCnpjBlocks(false);
      showCpfBlocks(true);
    }

    // re-mascara doc ao trocar o tipo
    doc.value = maskDocByType(doc.value);
  }

  function getFormValuesForApi(){
    const personType = (document.getElementById("personType")?.value || "cpf").toLowerCase();
    const isCnpj = personType === "cnpj";

    // ✅ envia somente números
    const doc = onlyDigits(document.getElementById("docNumber")?.value || "");
    const name = String(document.getElementById("fullName")?.value || "").trim();

    const zip = onlyDigits(document.getElementById("zip")?.value || "");
    const state = String(document.getElementById("state")?.value || "").trim();
    const city = String(document.getElementById("city")?.value || "").trim();
    const district = String(document.getElementById("district")?.value || "").trim();
    const address = String(document.getElementById("address")?.value || "").trim();
    const number = String(document.getElementById("number")?.value || "").trim();
    const complement = String(document.getElementById("complement")?.value || "").trim() || null;

    const email = String(document.getElementById("email")?.value || "").trim();
    const phone = String(document.getElementById("phone")?.value || "").trim();

    // CPF only
    const birthDate = String(document.getElementById("birthDate")?.value || "").trim();
    const gender = String(document.getElementById("gender")?.value || "").trim();

    // CNPJ only
    const ie_indicator = getSelectedIeIndicator();
    const ieNumberDigits = onlyDigits(document.getElementById("ieNumber")?.value || "");

    const payload = {
      person_type: isCnpj ? "CNPJ" : "CPF",
      doc_number: doc,

      full_name: isCnpj ? "" : name,
      corporate_name: isCnpj ? name : "",

      ie_indicator: isCnpj ? ie_indicator : null,
      ie: isCnpj ? (ie_indicator === "CONTRIBUINTE" ? (ieNumberDigits || null) : null) : null,

      birth_date: isCnpj ? null : (birthDate || null),
      gender: isCnpj ? null : (gender || null),

      cep: zip,
      uf: state,
      city_name: city,
      neighborhood: district,
      street: address,
      street_number: number,
      complement: complement,

      email,
      phone,
    };

    return payload;
  }

  function validateFront(){
    const personType = (document.getElementById("personType")?.value || "cpf").toLowerCase();
    const isCnpj = personType === "cnpj";

    const doc = onlyDigits(document.getElementById("docNumber")?.value || "");
    const name = String(document.getElementById("fullName")?.value || "").trim();

    const zip = onlyDigits(document.getElementById("zip")?.value || "");
    const state = String(document.getElementById("state")?.value || "").trim();
    const city = String(document.getElementById("city")?.value || "").trim();
    const district = String(document.getElementById("district")?.value || "").trim();
    const address = String(document.getElementById("address")?.value || "").trim();
    const number = String(document.getElementById("number")?.value || "").trim();

    if (!doc) return "Preencha CPF/CNPJ.";
    if (!name) return isCnpj ? "Preencha a Razão Social." : "Preencha o Nome completo.";
    if (!zip) return "Preencha o CEP.";
    if (!address) return "Preencha o Endereço.";
    if (!number) return "Preencha o Número.";
    if (!district) return "Preencha o Bairro.";
    if (!city) return "Preencha a Cidade.";
    if (!state) return "Preencha o Estado (UF).";

    if (!isCnpj){
      const birthDate = String(document.getElementById("birthDate")?.value || "").trim();
      const gender = String(document.getElementById("gender")?.value || "").trim();
      if (!birthDate) return "Preencha a Data de nascimento.";
      if (!gender) return "Selecione o Gênero.";
    }else{
      const ind = getSelectedIeIndicator();
      if (!ind) return "Selecione o Indicador de IE (Contribuinte, Isento ou Não Contribuinte).";
      if (ind === "CONTRIBUINTE"){
        const ieNumber = onlyDigits(document.getElementById("ieNumber")?.value || "");
        if (!ieNumber) return "Preencha a IE (se Contribuinte).";
      }
    }

    return null;
  }

  async function loadInvoiceProfile(){
    const res = await apiGET("/api/get-invoice-profile");
    if (!res.ok) return null;
    const j = res.json || {};
    return j.profile || j.data || j;
  }

  function fillForm(profile){
    if (!profile) return;

    const pt = String(profile.person_type || profile.personType || "").toUpperCase();
    const personTypeEl = document.getElementById("personType");
    if (personTypeEl){
      personTypeEl.value = (pt === "CNPJ") ? "cnpj" : "cpf";
    }

    setDocLabels();

    // doc (preenche mascarado)
    const docEl = document.getElementById("docNumber");
    if (docEl) docEl.value = maskDocByType(String(profile.doc_number || profile.document || "").trim());

    const nameEl = document.getElementById("fullName");
    if (nameEl) nameEl.value = String(profile.full_name || profile.name || "").trim();

    const bd = document.getElementById("birthDate");
    if (bd) bd.value = String(profile.birth_date || "").trim();

    const g = document.getElementById("gender");
    if (g) g.value = String(profile.gender || "").trim();

    const zipEl = document.getElementById("zip");
    if (zipEl) zipEl.value = maskCEP(String(profile.cep || profile.zip || "").trim());

    const stEl = document.getElementById("state");
    if (stEl) stEl.value = String(profile.uf || profile.state || "").trim();

    const cityEl = document.getElementById("city");
    if (cityEl) cityEl.value = String(profile.city_name || profile.city || "").trim();

    const distEl = document.getElementById("district");
    if (distEl) distEl.value = String(profile.neighborhood || profile.district || "").trim();

    const addrEl = document.getElementById("address");
    if (addrEl) addrEl.value = String(profile.street || profile.address || "").trim();

    const numEl = document.getElementById("number");
    if (numEl) numEl.value = String(profile.street_number || profile.number || "").trim();

    const compEl = document.getElementById("complement");
    if (compEl) compEl.value = String(profile.complement || "").trim();

    // IE indicator / IE
    const ind = String(profile.ie_indicator || "").toUpperCase();
    if (ind) setSelectedIeIndicator(ind);
    const ieNumEl = document.getElementById("ieNumber");
    if (ieNumEl) ieNumEl.value = profile.ie ? maskIE(String(profile.ie).trim()) : "";
    toggleIeNumber();
  }

  /* =========================
     STRIPE — criar sessão
  ========================= */
  async function createCheckoutSessionForSingle(category, city){
    const res = await apiPOST("/api/create-checkout-session", { category, city });
    if (!res.ok){
      const msg = (res.json && (res.json.error || res.json.message)) ? (res.json.error || res.json.message) : null;
      throw new Error(msg || "Não foi possível iniciar o pagamento.");
    }
    return res.json || {};
  }

  async function createCheckoutSessionForCart(items){
    const res = await apiPOST("/api/create-checkout-session", { items });
    if (!res.ok){
      const msg = (res.json && (res.json.error || res.json.message)) ? (res.json.error || res.json.message) : null;
      throw new Error(msg || "Não foi possível iniciar o pagamento.");
    }
    return res.json || {};
  }

  function redirectToStripe(sessionResponse){
    const url = sessionResponse.url || (sessionResponse.data && sessionResponse.data.url) || null;
    if (url){
      window.location.href = url;
      return;
    }
    throw new Error("Não foi possível abrir o pagamento.");
  }

  /* =========================
     FLOW
  ========================= */
  async function ensureLoggedInForInvoice(){
    const sess = await getSession();
    if (sess && sess.user) return true;

    const ret = encodeURIComponent(window.location.pathname + window.location.search);
    window.location.href = "login.html?return_to=" + ret;
    return false;
  }

  async function handleInvoiceStep(){
    const ok = await ensureLoggedInForInvoice();
    if (!ok) return;

    show("screenInvoice");
    setHint("");

    // masks
    const zipEl = document.getElementById("zip");
    if (zipEl){
      zipEl.addEventListener("input", () => {
        zipEl.value = maskCEP(zipEl.value);
      });
    }

    const phoneEl = document.getElementById("phone");
    if (phoneEl){
      phoneEl.addEventListener("input", () => {
        phoneEl.value = maskPhone(phoneEl.value);
      });
    }

    // ✅ doc (CPF/CNPJ)
    const docEl = document.getElementById("docNumber");
    if (docEl){
      docEl.addEventListener("input", () => {
        docEl.value = maskDocByType(docEl.value);
      });
      docEl.value = maskDocByType(docEl.value);
    }

    // ✅ IE
    const ieEl = document.getElementById("ieNumber");
    if (ieEl){
      ieEl.addEventListener("input", () => {
        ieEl.value = maskIE(ieEl.value);
      });
    }

    // person type change
    const personType = document.getElementById("personType");
    if (personType){
      personType.addEventListener("change", () => {
        setHint("");
        setSelectedIeIndicator("");
        const ieNum = document.getElementById("ieNumber");
        if (ieNum) ieNum.value = "";
        setDocLabels();
      });
    }

    // IE indicator change
    const radios = document.querySelectorAll('input[name="ie_indicator"]');
    radios.forEach(r => {
      r.addEventListener("change", () => {
        setHint("");
        toggleIeNumber();
      });
    });

    setDocLabels();

    // prefill
    try{
      const existing = await loadInvoiceProfile();
      if (existing) fillForm(existing);
    }catch(e){}

    // prefill email from session
    try{
      const sess = await getSession();
      const emailEl = document.getElementById("email");
      if (emailEl && !emailEl.value && sess && sess.user && sess.user.email){
        emailEl.value = sess.user.email;
      }
    }catch(e){}

    const btn = document.getElementById("btnInvoiceProceed");
    if (!btn) return;

    btn.onclick = async () => {
      try{
        btn.disabled = true;
        btn.innerText = "Aguarde...";
        setHint("");

        const token = await getAccessToken();
        if (!token){
          btn.disabled = false;
          btn.innerText = "Prosseguir";
          setHint("Sessão expirada. Faça login novamente.");
          const ret = encodeURIComponent(window.location.pathname + window.location.search);
          window.location.href = "login.html?return_to=" + ret;
          return;
        }

        const err = validateFront();
        if (err){
          btn.disabled = false;
          btn.innerText = "Prosseguir";
          setHint(err);
          return;
        }

        const payload = getFormValuesForApi();

        // salva perfil (bloqueia se falhar)
        const saveRes = await apiPOST("/api/save-invoice-profile", payload);
        if (!saveRes.ok){
          const msg = (saveRes.json && (saveRes.json.error || saveRes.json.message))
            ? (saveRes.json.error || saveRes.json.message)
            : "Não foi possível salvar seus dados.";
          btn.disabled = false;
          btn.innerText = "Prosseguir";
          setHint(msg);
          return;
        }

        // criar sessão stripe
        const isCart = qs("cart") === "1";
        const category = qs("category");
        const city = qs("city");

        let sessionResp = null;

        if (isCart){
          const items = getCartCheckoutItems();
          if (!items.length){
            btn.disabled = false;
            btn.innerText = "Prosseguir";
            setHint("Seu carrinho está vazio. Volte ao site e selecione seus materiais.");
            return;
          }
          sessionResp = await createCheckoutSessionForCart(items);
        }else{
          if (!category || !city){
            btn.disabled = false;
            btn.innerText = "Prosseguir";
            setHint("Não encontramos os dados do produto. Volte ao site e tente novamente.");
            return;
          }
          sessionResp = await createCheckoutSessionForSingle(category, city);
        }

        redirectToStripe(sessionResp);

      }catch(e){
        btn.disabled = false;
        btn.innerText = "Prosseguir";
        setHint(e && e.message ? e.message : "Não foi possível prosseguir. Tente novamente.");
      }
    };
  }

  async function handleSessionReturn(){
    const sessionId = qs("session_id");
    if (!sessionId){
      show("screenPaymentError");
      return;
    }

    const ok = await ensureLoggedInForInvoice();
    if (!ok) return;

    show("screenLoading");

    try{
      const res = await apiGET("/api/get-pdf-from-session?session_id=" + encodeURIComponent(sessionId));
      if (!res.ok){
        show("screenPaymentError");
        return;
      }
      window.location.href = "account.html";
    }catch(e){
      show("screenPaymentError");
    }
  }

  async function init(){
    ensureSupabase();
    await refreshNav();

    const step = qs("step");
    const sessionId = qs("session_id");

    if (step === "invoice"){
      await handleInvoiceStep();
      return;
    }

    if (sessionId){
      await handleSessionReturn();
      return;
    }

    show("screenPaymentError");
  }

  document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
