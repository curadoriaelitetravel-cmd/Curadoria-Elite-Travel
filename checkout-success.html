<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Confirmando pagamento | Curadoria Elite Travel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #0b0b0b;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
    }

    .box {
      max-width: 560px;
      padding: 40px 26px;
      border-radius: 16px;
      border: 1px solid #222;
      background: #111;
    }

    h1 {
      color: #d4af37;
      font-size: 22px;
      margin-bottom: 14px;
    }

    p {
      color: rgba(255,255,255,0.85);
      font-size: 15px;
      line-height: 1.6;
      margin: 8px 0;
    }

    .muted {
      color: rgba(255,255,255,0.6);
      font-size: 14px;
      margin-top: 18px;
    }

    form {
      margin-top: 22px;
      text-align: left;
      display: none;
    }

    label {
      display: block;
      margin-top: 14px;
      font-size: 14px;
    }

    input, select {
      width: 100%;
      margin-top: 6px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #0b0b0b;
      color: #fff;
    }

    .row {
      display: flex;
      gap: 12px;
    }

    .row > div {
      flex: 1;
    }

    button {
      margin-top: 22px;
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: none;
      background: #d4af37;
      color: #000;
      font-weight: 600;
      cursor: pointer;
    }

    .actions {
      margin-top: 26px;
      display: none;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .actions a {
      padding: 10px 16px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 600;
    }

    .btn-main {
      background: #d4af37;
      color: #000;
    }

    .btn-ghost {
      border: 1px solid rgba(212,175,55,0.4);
      color: #d4af37;
    }
  </style>
</head>
<body>

  <div class="box">
    <h1 id="title">Confirmando seu pagamento…</h1>

    <p id="subtitle">
      Estamos validando a compra e liberando seu material.
    </p>

    <p class="muted" id="status">
      Aguarde alguns instantes.
    </p>

    <!-- FORMULÁRIO NOTA FISCAL -->
    <form id="invoiceForm">
      <label>Tipo de documento</label>
      <select id="person_type">
        <option value="CPF">Pessoa Física (CPF)</option>
        <option value="CNPJ">Pessoa Jurídica (CNPJ)</option>
      </select>

      <label>CPF / CNPJ</label>
      <input id="doc_number" required />

      <label>Nome / Razão Social</label>
      <input id="full_name" required />

      <label id="birthLabel">Data de nascimento</label>
      <input type="date" id="birth_date" />

      <label>
        <input type="checkbox" id="ie_isento" checked />
        Isento de Inscrição Estadual
      </label>

      <label id="ieLabel">Inscrição Estadual</label>
      <input id="ie" />

      <div class="row">
        <div>
          <label>UF</label>
          <select id="uf"></select>
        </div>
        <div>
          <label>Cidade</label>
          <select id="city_name"></select>
        </div>
      </div>

      <label>CEP</label>
      <input id="cep" required />

      <label>Bairro</label>
      <input id="neighborhood" required />

      <label>Rua</label>
      <input id="street" required />

      <label>Número</label>
      <input id="street_number" required />

      <button type="submit">Salvar dados e acessar material</button>
    </form>

    <div class="actions" id="actions">
      <a href="/" class="btn-main">Voltar ao site</a>
      <a href="mailto:curadoriaelitetravel@gmail.com" class="btn-ghost">Contato</a>
    </div>
  </div>

<script>
/* ===============================
   MÁSCARAS CPF / CNPJ
================================ */
function onlyDigits(v) {
  return v.replace(/\D+/g, "");
}

function formatCPF(v) {
  v = onlyDigits(v).slice(0, 11);
  v = v.replace(/(\d{3})(\d)/, "$1.$2");
  v = v.replace(/(\d{3})(\d)/, "$1.$2");
  v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
  return v;
}

function formatCNPJ(v) {
  v = onlyDigits(v).slice(0, 14);
  v = v.replace(/^(\d{2})(\d)/, "$1.$2");
  v = v.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3");
  v = v.replace(/\.(\d{3})(\d)/, ".$1/$2");
  v = v.replace(/(\d{4})(\d{1,2})$/, "$1-$2");
  return v;
}

const docInput = document.getElementById("doc_number");
const personTypeSelect = document.getElementById("person_type");

docInput.addEventListener("input", () => {
  if (personTypeSelect.value === "CPF") {
    docInput.value = formatCPF(docInput.value);
  } else {
    docInput.value = formatCNPJ(docInput.value);
  }
});

personTypeSelect.addEventListener("change", () => {
  docInput.value = "";
});

/* ===============================
   LÓGICA EXISTENTE
================================ */
async function init() {
  const params = new URLSearchParams(window.location.search);
  const sessionId = params.get("session_id");

  if (!sessionId) return;

  const check = await fetch("/api/invoice-profile-exists");
  const exists = await check.json();

  if (!exists.has_profile) {
    document.getElementById("title").innerText = "Dados para Nota Fiscal";
    document.getElementById("subtitle").innerText =
      "Precisamos dessas informações para emitir sua nota fiscal.";
    document.getElementById("status").style.display = "none";
    document.getElementById("invoiceForm").style.display = "block";

    await loadUFs();
    return;
  }

  liberarPDF(sessionId);
}

async function liberarPDF(sessionId) {
  const res = await fetch("/api/get-pdf-from-session?session_id=" + encodeURIComponent(sessionId));
  const data = await res.json();
  if (data?.pdf_url) window.location.href = data.pdf_url;
}

async function loadUFs() {
  const res = await fetch("/api/br-cities");
  const data = await res.json();

  const ufSelect = document.getElementById("uf");
  ufSelect.innerHTML = (data.estados || []).map(u => `<option>${u}</option>`).join("");

  await loadCities();
}

async function loadCities() {
  const uf = document.getElementById("uf").value;
  const res = await fetch("/api/br-cities?uf=" + encodeURIComponent(uf));
  const data = await res.json();

  document.getElementById("city_name").innerHTML =
    (data.cidades || []).map(c => `<option>${c}</option>`).join("");
}

document.getElementById("uf").addEventListener("change", loadCities);

document.getElementById("person_type").addEventListener("change", e => {
  const isCPF = e.target.value === "CPF";
  document.getElementById("birthLabel").style.display = isCPF ? "block" : "none";
  document.getElementById("birth_date").style.display = isCPF ? "block" : "none";
});

document.getElementById("invoiceForm").addEventListener("submit", async e => {
  e.preventDefault();

  const payload = {
    person_type: person_type.value,
    doc_number: doc_number.value,
    full_name: full_name.value,
    birth_date: birth_date.value || null,
    ie_isento: ie_isento.checked,
    ie: ie.value || null,
    uf: uf.value,
    city_name: city_name.value,
    cep: cep.value,
    neighborhood: neighborhood.value,
    street: street.value,
    street_number: street_number.value
  };

  await fetch("/api/save-invoice-profile", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  liberarPDF(new URLSearchParams(window.location.search).get("session_id"));
});

init();
</script>

</body>
</html>
