<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Confirmando pagamento | Curadoria Elite Travel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #0b0b0b;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
    }

    .box {
      max-width: 560px;
      padding: 40px 26px;
      border-radius: 16px;
      border: 1px solid #222;
      background: #111;
    }

    h1 {
      color: #d4af37;
      font-size: 22px;
      margin-bottom: 14px;
    }

    p {
      color: rgba(255,255,255,0.85);
      font-size: 15px;
      line-height: 1.6;
      margin: 8px 0;
    }

    .muted {
      color: rgba(255,255,255,0.6);
      font-size: 14px;
      margin-top: 18px;
    }

    form {
      margin-top: 22px;
      text-align: left;
      display: none;
    }

    label {
      display: block;
      margin-top: 14px;
      font-size: 14px;
    }

    input, select {
      width: 100%;
      margin-top: 6px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #0b0b0b;
      color: #fff;
    }

    .row {
      display: flex;
      gap: 12px;
    }

    .row > div {
      flex: 1;
    }

    button {
      margin-top: 22px;
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: none;
      background: #d4af37;
      color: #000;
      font-weight: 600;
      cursor: pointer;
    }

    .actions {
      margin-top: 26px;
      display: none;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .actions a {
      padding: 10px 16px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 600;
    }

    .btn-main {
      background: #d4af37;
      color: #000;
    }

    .btn-ghost {
      border: 1px solid rgba(212,175,55,0.4);
      color: #d4af37;
    }
  </style>
</head>
<body>

  <div class="box">
    <h1 id="title">Confirmando seu pagamento…</h1>

    <p id="subtitle">
      Estamos validando a compra e liberando seu material.
    </p>

    <p class="muted" id="status">
      Aguarde alguns instantes.
    </p>

    <!-- FORMULÁRIO NOTA FISCAL (desativado por enquanto - endpoints removidos para caber no limite do plano Hobby) -->
    <form id="invoiceForm">
      <label>Tipo de documento</label>
      <select id="person_type">
        <option value="CPF">Pessoa Física (CPF)</option>
        <option value="CNPJ">Pessoa Jurídica (CNPJ)</option>
      </select>

      <label>CPF / CNPJ</label>
      <input id="doc_number" required />

      <label>Nome / Razão Social</label>
      <input id="full_name" required />

      <label id="birthLabel">Data de nascimento</label>
      <input type="date" id="birth_date" />

      <label>
        <input type="checkbox" id="ie_isento" checked />
        Isento de Inscrição Estadual
      </label>

      <label id="ieLabel">Inscrição Estadual</label>
      <input id="ie" />

      <div class="row">
        <div>
          <label>UF</label>
          <select id="uf"></select>
        </div>
        <div>
          <label>Cidade</label>
          <select id="city_name"></select>
        </div>
      </div>

      <label>CEP</label>
      <input id="cep" required />

      <label>Bairro</label>
      <input id="neighborhood" required />

      <label>Rua</label>
      <input id="street" required />

      <label>Número</label>
      <input id="street_number" required />

      <button type="submit">Salvar dados e acessar material</button>
    </form>

    <div class="actions" id="actions">
      <a href="/" class="btn-main">Voltar ao site</a>
      <a href="mailto:curadoriaelitetravel@gmail.com" class="btn-ghost">Contato</a>
    </div>
  </div>

<script>
async function init() {
  const params = new URLSearchParams(window.location.search);
  const sessionId = params.get("session_id");

  if (!sessionId) {
    showError("Sessão não encontrada", "Não foi possível identificar o pagamento. Volte ao site e tente novamente.");
    return;
  }

  // ✅ No plano Hobby (limite de funções), os endpoints de NF foram removidos.
  // Portanto, seguimos direto para liberação do material.
  liberarPDF(sessionId);
}

async function liberarPDF(sessionId) {
  try {
    const statusEl = document.getElementById("status");
    if (statusEl) statusEl.innerText = "Aguarde alguns instantes.";

    const res = await fetch("/api/get-pdf-from-session?session_id=" + encodeURIComponent(sessionId), {
      method: "GET",
      headers: { "Accept": "application/json" }
    });

    let data = null;
    try {
      data = await res.json();
    } catch (e) {
      // se por algum motivo não vier JSON
      data = null;
    }

    if (data && data.pdf_url) {
      window.location.href = data.pdf_url;
      return;
    }

    // se não veio pdf_url, mostra erro amigável
    const errTitle = "Não foi possível liberar o material";
    const errMsg =
      (data && (data.error || data.message || data.details))
        ? String(data.error || data.message || data.details)
        : "Tente novamente em instantes. Se persistir, entre em contato.";

    showError(errTitle, errMsg);
  } catch (err) {
    showError("Erro inesperado", (err && err.message) ? err.message : "Tente novamente em instantes.");
  }
}

function showError(title, message) {
  const titleEl = document.getElementById("title");
  const subtitleEl = document.getElementById("subtitle");
  const statusEl = document.getElementById("status");
  const actionsEl = document.getElementById("actions");

  if (titleEl) titleEl.innerText = title || "Erro";
  if (subtitleEl) subtitleEl.innerText = message || "Ocorreu um problema.";
  if (statusEl) statusEl.style.display = "none";
  if (actionsEl) actionsEl.style.display = "flex";
}

init();
</script>

</body>
</html>
