<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Confirmando pagamento | Curadoria Elite Travel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex,nofollow" />

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #0b0b0b;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
      padding: 16px;
      box-sizing: border-box;
    }
    .box {
      max-width: 620px;
      width: 100%;
      padding: 40px 26px;
      border-radius: 16px;
      border: 1px solid #222;
      background: #111;
    }
    h1 { color: #d4af37; font-size: 22px; margin-bottom: 12px; }
    p { color: rgba(255,255,255,0.85); font-size: 15px; line-height: 1.6; margin: 8px 0; }
    .muted { color: rgba(255,255,255,0.6); font-size: 14px; margin-top: 14px; }
    .actions {
      margin-top: 22px;
      display: none;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .actions a {
      padding: 10px 16px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 700;
      display: inline-block;
    }
    .btn-main { background: #d4af37; color: #000; }
    .btn-ghost { border: 1px solid rgba(212,175,55,0.4); color: #d4af37; }
  </style>
</head>
<body>

  <div class="box">
    <h1 id="title">Confirmando seu pagamento…</h1>
    <p id="subtitle">Estamos validando a compra e liberando seu acesso.</p>
    <p class="muted" id="status">Aguarde alguns instantes.</p>

    <div class="actions" id="actions">
      <a href="account.html" class="btn-main">Ir para minha conta</a>
      <a href="index.html" class="btn-ghost">Voltar ao site</a>
    </div>
  </div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://lnyoqoezezisakghtmim.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxueW9xb2V6ZXppc2FrZ2h0bWltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNjI4OTMsImV4cCI6MjA3OTczODg5M30.Nn9ZPRXeJlvCGJ2kXQ3XBvT743pQn2VIXEsT9pexqnA";

  let sb = null;
  function ensureSupabase(){
    if (sb) return sb;
    if (!window.supabase) return null;
    sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    return sb;
  }
  async function getAccessToken(){
    const s = ensureSupabase();
    if (!s) return null;
    const { data } = await s.auth.getSession();
    return data?.session?.access_token || null;
  }

  async function init(){
    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get("session_id");

    if (!sessionId){
      document.getElementById("title").innerText = "Pagamento";
      document.getElementById("subtitle").innerText = "Não encontramos a sessão de pagamento.";
      document.getElementById("status").innerText = "Volte ao site e tente novamente.";
      document.getElementById("actions").style.display = "flex";
      return;
    }

    const token = await getAccessToken();
    if (!token){
      document.getElementById("title").innerText = "Acesso à conta";
      document.getElementById("subtitle").innerText = "Para liberar o material, é necessário estar logado.";
      document.getElementById("status").innerText = "Você será direcionado para o login.";
      setTimeout(() => {
        window.location.href = "login.html?return_to=" + encodeURIComponent("checkout-success.html?session_id=" + encodeURIComponent(sessionId));
      }, 900);
      return;
    }

    try{
      const res = await fetch("/api/get-pdf-from-session?session_id=" + encodeURIComponent(sessionId), {
        headers: { "Authorization": "Bearer " + token }
      });
      const data = await res.json().catch(() => null);

      if (!res.ok || !data?.ok){
        document.getElementById("title").innerText = "Pagamento";
        document.getElementById("subtitle").innerText = "Não conseguimos liberar seu acesso automaticamente.";
        document.getElementById("status").innerText = "Vá para sua conta ou volte ao site.";
        document.getElementById("actions").style.display = "flex";
        return;
      }

      document.getElementById("title").innerText = "Acesso liberado";
      document.getElementById("subtitle").innerText = "Seu material já está disponível em Minha Conta.";
      document.getElementById("status").innerText = "Estamos te redirecionando…";
      document.getElementById("actions").style.display = "flex";

      setTimeout(() => {
        window.location.href = "account.html";
      }, 900);

    }catch(e){
      document.getElementById("title").innerText = "Pagamento";
      document.getElementById("subtitle").innerText = "Não conseguimos finalizar agora.";
      document.getElementById("status").innerText = "Tente novamente em instantes.";
      document.getElementById("actions").style.display = "flex";
    }
  }

  init();
</script>
</body>
</html>
