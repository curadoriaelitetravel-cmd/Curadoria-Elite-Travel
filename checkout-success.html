<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Confirmando pagamento | Curadoria Elite Travel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #0b0b0b;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      text-align: center;
    }

    .box {
      max-width: 560px;
      padding: 40px 26px;
      border-radius: 16px;
      border: 1px solid #222;
      background: #111;
    }

    h1 {
      color: #d4af37;
      font-size: 22px;
      margin-bottom: 14px;
    }

    p {
      color: rgba(255,255,255,0.85);
      font-size: 15px;
      line-height: 1.6;
      margin: 8px 0;
    }

    .muted {
      color: rgba(255,255,255,0.6);
      font-size: 14px;
      margin-top: 18px;
    }

    form {
      margin-top: 22px;
      text-align: left;
      display: none;
    }

    label {
      display: block;
      margin-top: 14px;
      font-size: 14px;
    }

    input, select {
      width: 100%;
      margin-top: 6px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #0b0b0b;
      color: #fff;
      box-sizing: border-box;
    }

    .row {
      display: flex;
      gap: 12px;
    }

    .row > div {
      flex: 1;
    }

    .checkboxRow {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 14px;
    }

    .checkboxRow input[type="checkbox"] {
      width: auto;
      margin: 0;
      transform: translateY(1px);
    }

    button {
      margin-top: 22px;
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: none;
      background: #d4af37;
      color: #000;
      font-weight: 600;
      cursor: pointer;
    }

    .actions {
      margin-top: 26px;
      display: none;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .actions a {
      padding: 10px 16px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 600;
    }

    .btn-main {
      background: #d4af37;
      color: #000;
    }

    .btn-ghost {
      border: 1px solid rgba(212,175,55,0.4);
      color: #d4af37;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>

  <div class="box">
    <h1 id="title">Confirmando seu pagamento…</h1>

    <p id="subtitle">
      Estamos validando a compra e liberando seu material.
    </p>

    <p class="muted" id="status">
      Aguarde alguns instantes.
    </p>

    <!-- FORMULÁRIO NOTA FISCAL -->
    <form id="invoiceForm">
      <label>Tipo de documento</label>
      <select id="person_type">
        <option value="CPF">Pessoa Física (CPF)</option>
        <option value="CNPJ">Pessoa Jurídica (CNPJ)</option>
      </select>

      <label>CPF / CNPJ</label>
      <input id="doc_number" required placeholder="Digite seu CPF ou CNPJ" inputmode="numeric" />

      <!-- CPF: Nome -->
      <div id="cpfNameWrap">
        <label>Nome completo</label>
        <input id="full_name" required />
      </div>

      <!-- CNPJ: Razão Social -->
      <div id="cnpjCorporateWrap" class="hidden">
        <label>Razão Social</label>
        <input id="corporate_name" />
      </div>

      <!-- CPF: Sexo -->
      <div id="genderWrap">
        <label>Sexo</label>
        <select id="gender">
          <option value="" selected>Selecione</option>
          <option value="Mulher">Mulher</option>
          <option value="Homem">Homem</option>
          <option value="Outro">Outro</option>
        </select>
      </div>

      <!-- CPF: Nascimento -->
      <div id="birthWrap">
        <label>Data de nascimento</label>
        <input type="date" id="birth_date" />
      </div>

      <!-- CNPJ: IE + Isento -->
      <div id="ieWrap" class="hidden">
        <div class="checkboxRow">
          <input type="checkbox" id="ie_isento" checked />
          <label for="ie_isento" style="margin:0;">Isento de Inscrição Estadual</label>
        </div>

        <label id="ieLabel">Inscrição Estadual (IE)</label>
        <input id="ie" disabled />
      </div>

      <div class="row">
        <div>
          <label>UF</label>
          <select id="uf"></select>
        </div>
        <div>
          <label>Cidade</label>
          <select id="city_name"></select>
        </div>
      </div>

      <label>CEP</label>
      <input id="cep" required inputmode="numeric" placeholder="00000-000" />

      <label>Bairro</label>
      <input id="neighborhood" required />

      <label>Rua</label>
      <input id="street" required />

      <label>Número</label>
      <input id="street_number" required />

      <button type="submit">Salvar dados e acessar material</button>
    </form>

    <div class="actions" id="actions">
      <a href="/" class="btn-main">Voltar ao site</a>
      <a href="mailto:curadoriaelitetravel@gmail.com" class="btn-ghost">Contato</a>
    </div>
  </div>

  <!-- Supabase JS (oficial) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* =========================================================
   SUPABASE (já configurado)
========================================================= */
const sb = supabase.createClient(
  "https://lnyoqoezezisakghtmim.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxueW9xb2V6ZXppc2FrZ2h0bWltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNjI4OTMsImV4cCI6MjA3OTczODg5M30.Nn9ZPRXeJlvCGJ2kXQ3XBvT743pQn2VIXEsT9pexqnA"
);

function showActions() {
  document.getElementById("actions").style.display = "flex";
}

async function requireLoginOrStop() {
  const { data } = await sb.auth.getSession();
  if (!data || !data.session || !data.session.access_token) {
    document.getElementById("title").innerText = "Acesso à sua conta";
    document.getElementById("subtitle").innerText =
      "Para liberar seu material na sua conta, faça login primeiro.";
    document.getElementById("status").innerText =
      "Clique em “Voltar ao site” e entre na sua conta.";
    showActions();
    return null;
  }
  return data.session.access_token;
}

async function init() {
  const params = new URLSearchParams(window.location.search);
  const sessionId = params.get("session_id");

  if (!sessionId) return;

  // 1) precisa estar logado para gravar acesso vitalício
  const accessToken = await requireLoginOrStop();
  if (!accessToken) return;

  // verificar se já existe invoice profile
  const check = await fetch("/api/invoice-profile-exists");
  const exists = await check.json();

  if (!exists.has_profile) {
    document.getElementById("title").innerText = "Dados para Nota Fiscal";
    document.getElementById("subtitle").innerText =
      "Precisamos dessas informações para emitir sua nota fiscal.";
    document.getElementById("status").style.display = "none";
    document.getElementById("invoiceForm").style.display = "block";

    await loadUFs();
    applyPersonTypeUI();     // aplica a UI inicial (CPF)
    applyDocMask();          // aplica máscara inicial
    return;
  }

  liberarAcesso(sessionId, accessToken);
}

async function liberarAcesso(sessionId, accessToken) {
  const res = await fetch(
    "/api/get-pdf-from-session?session_id=" + encodeURIComponent(sessionId),
    {
      headers: {
        "Authorization": "Bearer " + accessToken
      }
    }
  );

  const data = await res.json();

  if (data && data.ok) {
    // IMPORTANTE: não abrir pdf_url direto (sem download)
    // Leva o cliente para a conta, onde ele visualiza dentro da account.html
    window.location.href = "account.html";
    return;
  }

  document.getElementById("title").innerText = "Não foi possível liberar o material";
  document.getElementById("subtitle").innerText =
    "Se o problema continuar, entre em contato.";
  document.getElementById("status").innerText =
    (data && data.error) ? ("Detalhe: " + data.error) : "Tente novamente em instantes.";
  showActions();
}

async function loadUFs() {
  // ✅ endpoint correto (você testou e está retornando 27 UFs)
  const res = await fetch("/api/br-cities");
  const data = await res.json();

  const ufSelect = document.getElementById("uf");
  ufSelect.innerHTML = (data.estados || []).map(u => `<option>${u}</option>`).join("");

  // já carrega cidades do primeiro UF
  await loadCities();
}

async function loadCities() {
  const uf = document.getElementById("uf").value;

  const res = await fetch("/api/br-cities?uf=" + encodeURIComponent(uf));
  const data = await res.json();

  document.getElementById("city_name").innerHTML =
    (data.cidades || []).map(c => `<option>${c}</option>`).join("");
}

document.getElementById("uf").addEventListener("change", loadCities);

/* =========================
   CPF / CNPJ: UI CONDICIONAL
========================= */
function applyPersonTypeUI() {
  const personType = document.getElementById("person_type").value;
  const isCPF = personType === "CPF";

  // CPF: Nome + Sexo + Nascimento
  document.getElementById("cpfNameWrap").classList.toggle("hidden", !isCPF);
  document.getElementById("genderWrap").classList.toggle("hidden", !isCPF);
  document.getElementById("birthWrap").classList.toggle("hidden", !isCPF);

  // CNPJ: Razão Social + IE
  document.getElementById("cnpjCorporateWrap").classList.toggle("hidden", isCPF);
  document.getElementById("ieWrap").classList.toggle("hidden", isCPF);

  // Regras de required
  document.getElementById("full_name").required = isCPF;
  document.getElementById("corporate_name").required = !isCPF;

  document.getElementById("birth_date").required = isCPF;

  // Se mudar tipo, limpa campos que não fazem sentido
  if (isCPF) {
    document.getElementById("corporate_name").value = "";
    document.getElementById("ie").value = "";
    document.getElementById("ie_isento").checked = true;
    document.getElementById("ie").disabled = true;
  } else {
    document.getElementById("full_name").value = "";
    document.getElementById("gender").value = "";
    document.getElementById("birth_date").value = "";
    // IE habilita/desabilita conforme isento
    toggleIE();
  }
}

/* =========================
   IE: habilita só se NÃO for isento
========================= */
function toggleIE() {
  const isento = document.getElementById("ie_isento").checked;
  const ieInput = document.getElementById("ie");

  if (isento) {
    ieInput.value = "";
    ieInput.disabled = true;
  } else {
    ieInput.disabled = false;
    ieInput.focus();
  }
}

document.getElementById("person_type").addEventListener("change", () => {
  applyPersonTypeUI();
  applyDocMask(); // reaplica máscara quando troca CPF/CNPJ
});

document.getElementById("ie_isento").addEventListener("change", toggleIE);

/* =========================
   MÁSCARA CPF / CNPJ
   CPF  = 000.000.000-00
   CNPJ = 00.000.000/0001-00
========================= */
function onlyDigits(v) {
  return String(v || "").replace(/\D+/g, "");
}

function formatCPF(digits) {
  const d = digits.slice(0, 11);
  // 000.000.000-00
  return d
    .replace(/^(\d{3})(\d)/, "$1.$2")
    .replace(/^(\d{3})\.(\d{3})(\d)/, "$1.$2.$3")
    .replace(/^(\d{3})\.(\d{3})\.(\d{3})(\d{1,2})$/, "$1.$2.$3-$4");
}

function formatCNPJ(digits) {
  const d = digits.slice(0, 14);
  // 00.000.000/0000-00
  return d
    .replace(/^(\d{2})(\d)/, "$1.$2")
    .replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3")
    .replace(/^(\d{2})\.(\d{3})\.(\d{3})(\d)/, "$1.$2.$3/$4")
    .replace(/^(\d{2})\.(\d{3})\.(\d{3})\/(\d{4})(\d{1,2})$/, "$1.$2.$3/$4-$5");
}

function applyDocMask() {
  const personType = document.getElementById("person_type").value;
  const input = document.getElementById("doc_number");
  const digits = onlyDigits(input.value);

  if (personType === "CPF") {
    input.value = formatCPF(digits);
    input.placeholder = "000.000.000-00";
  } else {
    input.value = formatCNPJ(digits);
    input.placeholder = "00.000.000/0001-00";
  }
}

document.getElementById("doc_number").addEventListener("input", applyDocMask);

/* =========================
   SUBMIT
========================= */
document.getElementById("invoiceForm").addEventListener("submit", async e => {
  e.preventDefault();

  // precisa estar logado aqui também
  const accessToken = await requireLoginOrStop();
  if (!accessToken) return;

  const personType = person_type.value;

  const payload = {
    person_type: personType,
    doc_number: onlyDigits(doc_number.value),

    // CPF:
    full_name: personType === "CPF" ? full_name.value : "",
    gender: personType === "CPF" ? (gender.value || null) : null,
    birth_date: personType === "CPF" ? (birth_date.value || null) : null,

    // CNPJ:
    corporate_name: personType === "CNPJ" ? corporate_name.value : "",
    ie_isento: personType === "CNPJ" ? ie_isento.checked : true,
    ie: personType === "CNPJ" ? (ie.value || null) : null,

    // Endereço:
    uf: uf.value,
    city_name: city_name.value,
    cep: onlyDigits(cep.value),
    neighborhood: neighborhood.value,
    street: street.value,
    street_number: street_number.value
  };

  await fetch("/api/save-invoice-profile", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  liberarAcesso(new URLSearchParams(window.location.search).get("session_id"), accessToken);
});

init();
</script>

</body>
</html>
