<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Confirmando pagamento | Curadoria Elite Travel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <meta name="robots" content="noindex,nofollow" />

  <style>
    body{
      margin:0;
      font-family:"Segoe UI",sans-serif;
      background:#0b0b0b;
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      text-align:center;
      padding:18px;
      box-sizing:border-box;
    }

    .box{
      width: min(980px, 100%);
      padding:26px 18px;
      border-radius:16px;
      border:1px solid #222;
      background:#111;
      box-sizing:border-box;
    }

    h1{
      color:#d4af37;
      font-size:22px;
      margin:0 0 10px;
      letter-spacing:.2px;
    }

    p{
      color:rgba(255,255,255,0.85);
      font-size:15px;
      line-height:1.6;
      margin:8px 0;
    }

    .muted{
      color:rgba(255,255,255,0.65);
      font-size:14px;
      margin-top:12px;
    }

    .actions{
      margin-top:18px;
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
    }

    .btn{
      padding:12px 16px;
      border-radius:12px;
      text-decoration:none;
      font-weight:700;
      border:none;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 160px;
    }

    .btn-main{
      background:#d4af37;
      color:#000;
    }

    .btn-ghost{
      background:transparent;
      border:1px solid rgba(212,175,55,0.45);
      color:#d4af37;
    }

    .viewer-wrap{
      margin-top:18px;
      border:1px solid rgba(255,255,255,0.10);
      border-radius:14px;
      overflow:hidden;
      background:#0b0b0b;
      text-align:left;
      display:none;
    }

    .viewer-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,0.10);
      flex-wrap:wrap;
    }

    .viewer-top .label{
      color:rgba(255,255,255,0.75);
      font-size:13px;
    }

    iframe{
      width:100%;
      height:70vh;
      border:0;
      background:#000;
    }

    .error-box{
      display:none;
    }
  </style>
</head>

<body>

  <div class="box">
    <h1 id="title">Confirmando seu pagamento...</h1>

    <p id="subtitle">Estamos validando a compra e liberando seu material.</p>

    <p class="muted" id="status">Aguarde alguns instantes.</p>

    <div class="actions" id="actions" style="display:none;">
      <a href="index.html" class="btn btn-main">Voltar ao site</a>
      <a href="account.html" class="btn btn-ghost">Minha conta</a>
      <a id="btnNewTab" href="#" target="_blank" rel="noopener" class="btn btn-ghost" style="display:none;">Abrir em nova aba</a>
    </div>

    <div class="viewer-wrap" id="viewerWrap" oncontextmenu="return false;">
      <div class="viewer-top">
        <div class="label" id="viewerLabel">Visualização do material</div>
      </div>
      <iframe id="viewer" title="Visualização do material"></iframe>
    </div>

    <div class="error-box" id="errorBox">
      <h1 style="margin-top:10px;">Pagamento</h1>
      <p id="errorText">Não conseguimos liberar seu material.</p>
      <p class="muted">Se precisar, volte ao site ou acesse sua conta.</p>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    /* =========================
       SUPABASE (mesmo projeto)
    ========================= */
    const SUPABASE_URL = "https://lnyoqoezezisakghtmim.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxueW9xb2V6ZXppc2FrZ2h0bWltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNjI4OTMsImV4cCI6MjA3OTczODg5M30.Nn9ZPRXeJlvCGJ2kXQ3XBvT743pQn2VIXEsT9pexqnA";

    let sb = null;
    function ensureSupabase(){
      if (sb) return sb;
      if (!window.supabase) return null;
      sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      return sb;
    }

    async function getAccessToken(){
      const s = ensureSupabase();
      if (!s) return null;
      const { data } = await s.auth.getSession();
      return (data && data.session && data.session.access_token) ? data.session.access_token : null;
    }

    function showError(msg){
      document.getElementById("title").innerText = "Pagamento";
      document.getElementById("subtitle").innerText = "Não conseguimos liberar seu material.";
      document.getElementById("status").innerText = msg || "Se precisar, volte ao site ou acesse sua conta.";

      document.getElementById("actions").style.display = "flex";
      document.getElementById("errorBox").style.display = "block";
    }

    function showSuccess(pdfUrl){
      document.getElementById("title").innerText = "Seu material foi liberado";
      document.getElementById("subtitle").innerText = "Você pode visualizar abaixo.";
      document.getElementById("status").style.display = "none";

      const btnNewTab = document.getElementById("btnNewTab");
      btnNewTab.href = pdfUrl;
      btnNewTab.style.display = "inline-flex";

      document.getElementById("actions").style.display = "flex";
      document.getElementById("viewerWrap").style.display = "block";

      const viewer = document.getElementById("viewer");
      viewer.src = pdfUrl;
    }

    /* =========================
       INIT (pós-stripe)
    ========================= */
    async function init() {
      const params = new URLSearchParams(window.location.search);
      const sessionId = params.get("session_id");

      if (!sessionId) {
        showError("Não encontramos a sessão de pagamento. Volte ao site e tente novamente.");
        return;
      }

      // precisa estar logado para liberar e salvar acesso vitalício
      const token = await getAccessToken();

      if (!token) {
        // manda para login e volta para esta página
        const returnTo = "checkout-success.html?session_id=" + encodeURIComponent(sessionId);
        window.location.href = "login.html?return_to=" + encodeURIComponent(returnTo);
        return;
      }

      await liberarPDF(sessionId, token);
    }

    /* =========================
       LIBERA PDF (pós-pagamento)
       >>> COM AUTH HEADER <<<
    ========================= */
    async function liberarPDF(sessionId, token) {
      try{
        const res = await fetch("/api/get-pdf-from-session?session_id=" + encodeURIComponent(sessionId), {
          method: "GET",
          headers: {
            "Authorization": "Bearer " + token
          }
        });

        const data = await res.json().catch(() => null);

        if (data && data.pdf_url) {
          showSuccess(data.pdf_url);
          return;
        }

        // fallback de erro
        showError("Não conseguimos liberar seu material. Verifique sua conta.");
      }catch(e){
        showError("Falha ao confirmar pagamento. Tente novamente.");
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      ensureSupabase();
      init();
    });
  </script>

</body>
</html>
