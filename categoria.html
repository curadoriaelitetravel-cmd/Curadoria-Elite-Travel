  async function maybeResumePendingCheckout(){
    const pending = readPendingCheckout();
    if (!pending || !pending.category || !pending.city) return;

    const token = await getAccessToken();
    if (!token) return;

    openPopup({
      title: "Continuar",
      text: "Deseja continuar o acesso do material selecionado?",
      showProsseguir: true,
      showRules: false,
      onProsseguir: () => {
        closePopup();
        pendingCheckout.category = pending.category;
        pendingCheckout.city = pending.city;
        clearPendingCheckout();
        proceedCheckout();
      }
    });
  }

  let pendingCheckout = { category:null, city:null };

  async function startCheckout(category, city){
    try{
      const token = await getAccessToken();

      if (!token){
        savePendingCheckout(category, city);

        openPopup({
          title: "Acesso à conta",
          text: "Para prosseguir, é necessário entrar ou criar seu cadastro.",
          showProsseguir: true,
          showRules: false,
          onProsseguir: () => {
            window.location.href = "login.html?return_to=index.html";
          }
        });
        return;
      }

      const res = await fetch("/api/create-checkout-session", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ category, city })
      });

      let data = null;
      try{ data = await res.json(); }catch(e){}

      if (data && data.code === "INVOICE_REQUIRED"){
        savePendingCheckout(category, city);

        openPopup({
          title: "Dados para Nota Fiscal",
          text: "Antes do pagamento, precisamos dessas informações.",
          showProsseguir: true,
          showRules: false,
          onProsseguir: () => {
            window.location.href =
              "checkout-success.html?step=invoice&category=" +
              encodeURIComponent(category) +
              "&city=" +
              encodeURIComponent(city);
          }
        });
        return;
      }

      if (data && data.code === "LOGIN_REQUIRED"){
        savePendingCheckout(category, city);
        openPopup({
          title: "Acesso à conta",
          text: "Para prosseguir, é necessário entrar ou criar seu cadastro.",
          showProsseguir: true,
          showRules: false,
          onProsseguir: () => {
            window.location.href = "login.html?return_to=index.html";
          }
        });
        return;
      }

      if (!res.ok || !data || !data.url){
        openPopup({
          title: "Pagamento",
          text: "Não foi possível iniciar o pagamento. Tente novamente.",
          showProsseguir: false,
          showRules: false,
          onProsseguir: null
        });
        return;
      }

      window.location.href = data.url;
    } catch(e){
      openPopup({
        title: "Pagamento",
        text: "Erro ao conectar com o pagamento. Tente novamente.",
        showProsseguir: false,
        showRules: false,
        onProsseguir: null
      });
    }
  }

  function proceedCheckout(){
    if (!pendingCheckout.category || !pendingCheckout.city) return;
    startCheckout(pendingCheckout.category, pendingCheckout.city);
  }

  const BATCH_SIZE = 8;
  let currentCategory = null;
  let filteredCities = [];
  let visibleCount = 0;

  function normalizeText(str){
    return (str || "")
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "");
  }

  function openCategory(category){
    currentCategory = category;

    const panel = document.getElementById("curadoria-panel");
    if (!panel) return;
    panel.style.display = "block";

    const bc = document.getElementById("breadcrumb");
    const pt = document.getElementById("panel-title");
    if (bc) bc.innerText = "Curadoria > " + category;
    if (pt) pt.innerText = category;

    const input = document.getElementById("city-search");
    if (input) input.value = "";

    filteredCities = (curadoriaData[category] || []).slice();
    visibleCount = Math.min(BATCH_SIZE, filteredCities.length);

    renderCities();

    setTimeout(() => {
      panel.scrollIntoView({ behavior: "smooth", block: "start" });
      if (input) input.focus({ preventScroll: true });
    }, 120);
  }

  function closeCategory(){
    const panel = document.getElementById("curadoria-panel");
    if (panel) panel.style.display = "none";
    currentCategory = null;
    filteredCities = [];
    visibleCount = 0;

    const cats = document.getElementById("curadoria-categories");
    if (cats) cats.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  function onSearchCity(){
    if (!currentCategory) return;

    const input = document.getElementById("city-search");
    const q = normalizeText(input ? input.value : "");
    const all = (curadoriaData[currentCategory] || []);

    if (!q) filteredCities = all.slice();
    else filteredCities = all.filter(item => normalizeText(item.cidade).includes(q));

    visibleCount = Math.min(BATCH_SIZE, filteredCities.length);
    renderCities();
  }

  function loadMoreCities(){
    visibleCount = Math.min(visibleCount + BATCH_SIZE, filteredCities.length);
    renderCities(true);
  }

  function renderCities(){
    const grid = document.getElementById("cities-grid");
    const empty = document.getElementById("empty-state");
    const btnMore = document.getElementById("btn-more");
    const citiesCount = document.getElementById("cities-count");
    const visible = document.getElementById("visible-count");

    if (!grid) return;

    const total = filteredCities.length;

    if (citiesCount) citiesCount.innerText = total + (total === 1 ? " cidade" : " cidades");
    if (visible) visible.innerText = "Mostrando " + Math.min(visibleCount, total);

    if (total === 0){
      grid.innerHTML = "";
      if (empty) empty.style.display = "block";
      if (btnMore) btnMore.style.display = "none";
      return;
    }

    if (empty) empty.style.display = "none";

    const slice = filteredCities.slice(0, visibleCount);
    grid.innerHTML = "";

    slice.forEach((item) => {
      const div = document.createElement("div");
      div.className = "city-card";

      const cityLabel = item.cidade || "";
      const isAvailable = hasActiveMaterial(currentCategory, cityLabel);

      const badge = isAvailable
        ? `<span class="pill ok">Disponível</span>`
        : `<span class="pill muted">Em breve</span>`;

      div.innerHTML = `
        <h4>${cityLabel}<small>Material digital com indicações selecionadas</small></h4>
        <div class="city-meta">${badge}</div>
        <button>Acessar</button>
      `;

      const btn = div.querySelector("button");
      btn.addEventListener("click", () => openCityModal(currentCategory, cityLabel));

      grid.appendChild(div);
    });

    if (btnMore){
      btnMore.style.display = visibleCount < total ? "inline-flex" : "none";
    }
  }

  function openCityModal(category, city){
    const isAvailable = hasActiveMaterial(category, city);

    pendingCheckout.category = category;
    pendingCheckout.city = city;

    const msg = isAvailable
      ? `${category} é um material digital com indicações e referências selecionadas para apoiar suas decisões de viagem. Este conteúdo é liberado após a confirmação da compra.`
      : `${category} é um material digital com indicações e referências selecionadas para apoiar suas decisões de viagem. Este conteúdo estará disponível em breve.`;

    if (!isAvailable){
      openPopup({
        title: city,
        text: msg,
        showProsseguir: false,
        showRules: true,
        onProsseguir: null
      });
      return;
    }

    openPopup({
      title: city,
      text: msg,
      showProsseguir: true,
      showRules: true,
      onProsseguir: proceedCheckout
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadActiveMaterials();
  });
</script>

</body>
</html>
